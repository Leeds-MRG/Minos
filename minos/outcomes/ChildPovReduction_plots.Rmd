---
title: "Scottish Child Poverty Briefing Plots"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
---


WS5 (Dynamic Microsimulation): What are the impacts on mental health of meeting the targets?
·        Across the population? 
·        Population by income quintile (looking at absolute/relative inequalities)?
·        For families only? By income quintile (looking at absolute/relative inequalities)?
·        For families that meet criteria of 0/1/2+ of the priority family groups?
·        Differential impacts of UK package of policies only, and then UK package with SG policies?


```{r "setup", include=FALSE}

require(tidyverse)
require(ggplot2)

#workingDir <- "/home/luke/Documents/WORK/MINOS/Minos/output/default_config/scp_summary_out/"
#workingDir <- "/home/luke/Documents/WORK/MINOS/Minos/output/default_config/cpr_summary_out/"
#workingDir <- "/home/luke/Documents/WORK/MINOS/SCP_ARC_SUMMARIES/"
workingDir <- "/home/luke/Documents/WORK/MINOS/CPR_ARC_SUMMARIES/"
knitr::opts_knit$set(root.dir = workingDir)
rm(workingDir)
```

```{r "data_in_functions", include=FALSE}

generate_df_list <- function(summary, scen.list) {
  df.list <- lapply(scen.list, function(scen) {
    df <- read.csv(file = sprintf('%s/combined_summary_%s.csv', scen, summary))
    df$scen <- scen
    return(df)
  })
  return(df.list)
}

```

```{r "SF12_change_simple_functions", include=FALSE}
SF12_change_simple <- function(summary_group, scen.list) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  plot_data <- data %>%
    select(run_id, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"), 
                 names_to = c(".value", "scen"), 
                 names_sep = "\\.") %>%
    filter(scen != 'baseline')
  
  plot_data_confint <- plot_data %>%
    group_by(year) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  plot_data_confint2 <- plot_data %>%
    group_by(year) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qnorm(0.975) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
    
  
  p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p3 <- ggplot(plot_data_confint2, aes(x = year, y = mean_SF12_change)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  print(p1)
  print(p2)
  #print(p3)
}

SF12_change_percentage <- function(summary_group, scen.list) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  plot_data <- data %>%
    select(run_id, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ ((. - SF_12.baseline) / SF_12.baseline) * 100)) %>% # Calculate percentage change
    rename_with(~ paste0("percent_change_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("percent_change") | starts_with("mean_cost"), 
                 names_to = c(".value", "scen"), 
                 names_sep = "\\.") %>%
    filter(scen != 'baseline')
  
  plot_data_confint <- plot_data %>%
    group_by(year) %>%
    summarise(n = n(),
              mean_SF12_change = mean(percent_change_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(percent_change_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  p1 <- ggplot(plot_data, aes(x = year, y = percent_change_SF_12)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    labs(title = tit) +
    xlab('Year') +
    ylab('Percentage Change in SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Percentage Change in SF-12')
  
  print(p1)
  print(p2)
}


```

```{r "SF12_change_income_quint", include=FALSE}
SF12_change_income_quint <- function(summary_group, scen.list) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  
  summary_group <- paste0(summary_group, '_income_quint')
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  plot_data <- data %>%
    select(run_id, income_quintile, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    select(-scen)
  
  plot_data$income_quintile <- factor(plot_data$income_quintile)
  
  plot_data_confint <- plot_data %>%
    group_by(year, income_quintile) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  plot_data_confint2 <- plot_data %>%
    group_by(year, income_quintile) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qnorm(0.975) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
    
  
  p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12, group = income_quintile, colour = income_quintile, fill = income_quintile)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    labs(title = tit, subtitle = 'Income Quintile') +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change, group = income_quintile, colour = income_quintile, fill = income_quintile)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit, subtitle = 'Income Quintile') +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p3 <- ggplot(plot_data_confint2, aes(x = year, y = mean_SF12_change, group = income_quintile, colour = income_quintile, fill = income_quintile)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit, subtitle = 'Income Quintile') +
    xlab('Year') +
    ylab('Change in SF-12')
  
  print(p1)
  print(p2)
}

SF12_change_percentage_income_quint <- function(summary_group, scen.list) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  
  summary_group <- paste0(summary_group, '_income_quint')
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  plot_data <- data %>%
    select(run_id, income_quintile, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ ((. - SF_12.baseline) / SF_12.baseline) * 100)) %>% # Calculate percentage change
    rename_with(~ paste0("percent_change_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("percent_change") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    select(-scen)
  
  plot_data$income_quintile <- factor(plot_data$income_quintile)
  
  plot_data_confint <- plot_data %>%
    group_by(year, income_quintile) %>%
    summarise(n = n(),
              mean_SF12_change = mean(percent_change_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(percent_change_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
    
  
  p1 <- ggplot(plot_data, aes(x = year, y = percent_change_SF_12, group = income_quintile, colour = income_quintile, fill = income_quintile)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    labs(title = tit, subtitle = 'Income Quintile') +
    xlab('Year') +
    ylab('Percentage Change in SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change, group = income_quintile, colour = income_quintile, fill = income_quintile)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit, subtitle = 'Income Quintile') +
    xlab('Year') +
    ylab('Percentage Change in SF-12')
  
  print(p1)
  print(p2)
}

```

```{r "SF12_change_num_priority_groups", include=FALSE}
SF12_change_num_priority_groups <- function(scen.list) {

  summary_group <- 'priority_num'
  
  tit <- 'Number of Priority Subgroups'
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list.test))
  
  data <- replace_na(data, list(num_priority_groups=0))
  
  plot_data <- data %>%
    select(run_id, num_priority_groups, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    select(-scen)
  
  plot_data$num_priority_groups <- factor(plot_data$num_priority_groups)
  
  plot_data_confint <- plot_data %>%
    group_by(year, num_priority_groups) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  plot_data_confint2 <- plot_data %>%
    group_by(year, num_priority_groups) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qnorm(0.975) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  
  p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p3 <- ggplot(plot_data_confint2, aes(x = year, y = mean_SF12_change, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  print(p1)
  print(p2)
}

SF12_change_percentage_num_priority_groups <- function(scen.list) {

  summary_group <- 'priority_num'
  
  tit <- 'Number of Priority Subgroups'
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list.test))
  
  data <- replace_na(data, list(num_priority_groups=0))
  
  plot_data <- data %>%
    select(run_id, num_priority_groups, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ ((. - SF_12.baseline) / SF_12.baseline) * 100)) %>% # Calculate percentage change
    rename_with(~ paste0("percent_change_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("percent_change") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    select(-scen)
  
  plot_data$num_priority_groups <- factor(plot_data$num_priority_groups)
  
  plot_data_confint <- plot_data %>%
    group_by(year, num_priority_groups) %>%
    summarise(n = n(),
              mean_SF12_change = mean(percent_change_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(percent_change_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  plot_data_confint2 <- plot_data %>%
    group_by(year, num_priority_groups) %>%
    summarise(n = n(),
              mean_SF12_change = mean(percent_change_SF_12),
              margin = qnorm(0.975) * (sd(percent_change_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  
  p1 <- ggplot(plot_data, aes(x = year, y = percent_change_SF_12, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p3 <- ggplot(plot_data_confint2, aes(x = year, y = mean_SF12_change, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  print(p1)
  print(p2)
}
```


```{r}
scen.list.test <- c('baseline', 'ChildPovertyReductionRELATIVE_2')
#scen.list.test <- c('baseline', 'ChildPovertyReductionABSOLUTE')
whole_pop_data <- do.call(rbind, generate_df_list('whole_pop', scen.list.test))
```

# Quick Data Test

```{r}
ggplot(whole_pop_data, aes(x = year, y = SF_12, group = scen, colour = scen, fill = scen)) +
  geom_smooth()
```

Check if SF12 results in one year (across 100 runs) are normally distributed.

```{r}
whole_pop_2030 <- whole_pop_data %>%
  filter(year == 2030)

hist(whole_pop_2030$SF_12)
qqnorm(whole_pop_2030$SF_12)
qqline(whole_pop_2030$SF_12)

shapiro.test(whole_pop_2030$SF_12)

# Results look normally distributed^
```


# Whole Population

What are the impacts on mental health of meeting the targets:

- Across the population?
- Population by income quintile?

```{r}
SF12_change_simple(summary_group = 'whole_pop',
                   scen.list = scen.list.test)

SF12_change_percentage(summary_group = 'whole_pop',
                       scen.list = scen.list.test)
```

```{r}
SF12_change_income_quint(summary_group = 'whole_pop',
                         scen.list = scen.list.test)

SF12_change_percentage_income_quint(summary_group = 'whole_pop',
                                    scen.list = scen.list.test)
```


# Families

What are the impacts on mental health of meeting the targets:

- For families only? By income quintile

```{r}
SF12_change_simple(summary_group = 'families',
                   scen.list = scen.list.test)

SF12_change_percentage(summary_group = 'families',
                       scen.list = scen.list.test)
```

```{r}
SF12_change_income_quint(summary_group = 'families',
                         scen.list = scen.list.test)

SF12_change_percentage_income_quint(summary_group = 'families',
                                    scen.list = scen.list.test)
```


# Priority Subgroups

What are the impacts on mental health of meeting the targets:

- For families that meet the criteria of 0/1/2+ of the priority family groups?

```{r}
SF12_change_simple(summary_group = 'priority_any',
                         scen.list = scen.list.test)

SF12_change_percentage(summary_group = 'priority_any',
                                    scen.list = scen.list.test)
```

## Number of Priority Subgroups

```{r}
SF12_change_num_priority_groups(scen.list.test)
SF12_change_percentage_num_priority_groups(scen.list.test)
```

# TESTING

```{r}

```


# Differential Impacts of UK vs SG

What are the impacts on mental health of meeting the targets?

- Differential impacts of UK package of policies only, and then UK package with SG policies?

# BONUS - Treated Pop

```{r}

```




```{r}

```

