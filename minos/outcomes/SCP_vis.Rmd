---
title: "Scottish Child Payment Interventions"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
---

# SETUP

```{r "setup", include=FALSE}

require(tidyverse)
require(ggplot2)
require(knitr)
require(here)
require(dplyr)
require(tidyr)
require(purrr)

#workingDir <- "/home/luke/Documents/WORK/MINOS/"
workingDir <- normalizePath('../')
knitr::opts_knit$set(root.dir = workingDir)
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
rm(workingDir)
```

Source utils for some functions.

```{r}
source(here::here('minos', 'utils_datain.R'))
#source(here::here('minos', 'utils_validation_vis.R'))
#source(here::here('minos', 'validation', 'utils.r'))
```


```{r}
# out.path <- here::here('output', 'default_config')
# 
# # define subset of variables to reduce size of batch output
# var.list <- c('pidp', 'hidp', 'time', 'weight', 
#               'age', 'ethnicity', 'education_state', 'region', 'nkids',
#               'hh_income',
#               'housing_quality', 'neighbourhood_safety', 'loneliness', 'ncigs', 'nutrition_quality', 'financial_situation', 'urban', 'housing_tenure',
#               'SF_12', 'matdep_child')
# 
# base <- read_output(out.path, 
#                     scenario = 'baseline', 
#                     var.list = var.list,
#                     verbose = TRUE)
# int25All <- read_output(out.path, 
#                         scenario = '25All', 
#                         var.list = var.list,
#                         verbose = TRUE)
# int50All <- read_output(out.path, 
#                         scenario = '50All', 
#                         var.list = var.list,
#                         verbose = TRUE)
# int75All <- read_output(out.path, 
#                         scenario = '75All', 
#                         var.list = var.list,
#                         verbose = TRUE)
# int100All <- read_output(out.path, 
#                         scenario = '100All', 
#                         var.list = var.list,
#                         verbose = TRUE)
# 
# int.list <- c(int25All, int50All, int75All, int100All)
# 
# # set up a boolean tag for batch or not
# # this is necessary because batch runs need slightly different processing before visualisation
# if ('run_id' %in% names(base)) {
#   batch <- TRUE
# } else {
#   batch <- FALSE
# }
# 
# # Save path and save flag
# save.path <- here::here('plots', 'SCOTGOV', 'CPR')
# create.if.not.exists(save.path)
# shall.we.save <- FALSE
# plot.width <- 10
# plot.height <- 5
```

```{r}
#out.path <- here::here('output', 'default_config')
out.path <- here::here('output', 'glasgow_scaled')


# define subset of variables to reduce size of batch output
var.list <- c('pidp', 'hidp', 'time', 'weight', 
              'age', 'ethnicity', 'education_state', 'region', 'nkids',
              'hh_income',
              'housing_quality', 'neighbourhood_safety', 'loneliness', 'ncigs', 'nutrition_quality', 'financial_situation', 'urban', 'housing_tenure',
              'SF_12', 'matdep_child')

base <- read_output(out.path, 
                    scenario = 'baseline', 
                    var.list = var.list,
                    verbose = TRUE)
int25 <- read_output(out.path, 
                      scenario = '25UniversalCredit', 
                      var.list = var.list,
                      verbose = TRUE)
int30 <- read_output(out.path,
                      scenario = '30UniversalCredit',
                      var.list = var.list,
                      verbose = TRUE)
int35 <- read_output(out.path,
                      scenario = '35UniversalCredit',
                      var.list = var.list,
                      verbose = TRUE)
int40 <- read_output(out.path,
                      scenario = '40UniversalCredit',
                      var.list = var.list,
                      verbose = TRUE)
int45 <- read_output(out.path,
                      scenario = '45UniversalCredit',
                      var.list = var.list,
                      verbose = TRUE)
int50 <- read_output(out.path,
                      scenario = '50UniversalCredit',
                      var.list = var.list,
                      verbose = TRUE)

#int.list <- c(int25, int30, int35, int40, int45, int50)
int.list <- list(base, int25, int30, int35, int40, int45, int50)
# 
scen.list <- c('base', 'int25', 'int30', 'int35', 'int40', 'int45', 'int50')

# set up a boolean tag for batch or not
# this is necessary because batch runs need slightly different processing before visualisation
if ('run_id' %in% names(base)) {
  batch <- TRUE
} else {
  batch <- FALSE
}

# Save path and save flag
save.path <- here::here('plots', 'SCOTGOV', 'CPR')
create.if.not.exists(save.path)
shall.we.save <- FALSE
plot.width <- 10
plot.height <- 5
```


# FUNCTIONS

```{r}
# single.mean <- function(data, scen) {
#   newvar.name <- paste0(scen, '.SF12')
#   print(newvar.name)
#   data <- data %>%
#     select(time, weight, SF_12) %>%
#     group_by(time) %>%
#     summarise(!!sym(newvar.name) := weighted.mean(SF_12, w = weight))
#   return(data)
# }
# 
# int.list <- list(base, int25, int30)
# 
# scen.list <- c('base', 'int25', 'int30')
# 
# #mod.list <- lapply(int.list, single.mean, scen.list)
# #mod.list <- mapply(single.mean, int.list, scen.list)
# 
# mod.list <- mapply(single.mean, int.list, scen.list, SIMPLIFY = FALSE)
# 
# combined <- mod.list %>%
#   reduce(full_join, by='time')
# 
# # List of intervention columns
# int_cols <- grep("int\\d+.SF12", names(combined), value = TRUE)
# 
# # # Create the new dataframe with differences
# # combined_diff <- combined %>%
# #   mutate(across(all_of(int_cols), ~ . - base.SF12, .names = "diff{col}"))
# 
# # Create the new dataframe with differences
# combined_diff <- combined %>%
#   mutate(across(all_of(int_cols), ~ . - base.SF12, .names = "diff{col}")) %>%
#   select(time, starts_with("diff")) %>%
#   rename_with(~ str_replace_all(., "diffint(\\d+).SF12", "diff\\1"))

```


```{r SF12_whole_pop, echo=FALSE}
SF12.change.full.sample.single <- function(df.list, scen.list) {
  single.mean <- function(data, scen) {
    newvar.name <- paste0(scen, '.SF12')
    data <- data %>%
      select(time, weight, SF_12) %>%
      group_by(time) %>%
      summarise(!!newvar.name := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  df.list <- mapply(single.mean, df.list, scen.list, SIMPLIFY = FALSE)
  
  combined <- df.list %>%
    reduce(full_join, by='time')

  # List of intervention columns
  int_cols <- grep("int\\d+.SF12", names(combined), value = TRUE)
  
  # Create the new dataframe with differences
  combined <- combined %>%
    mutate(across(all_of(int_cols), ~ . - base.SF12, .names = "diff{col}")) %>%
    select(time, starts_with("diff")) %>%
    rename_with(~ str_replace_all(., "diffint(\\d+).SF12", "diff\\1"))

  combined <- combined %>%
    pivot_longer(cols = starts_with('diff'),
                 names_to = 'scen',
                 values_to = 'diff')
  
  #return(combined)
  
  scen.list <- scen.list[-1]
  
  #TODO: Rename factor levels
  #correct factor levels for plot
  # combined$scen <- factor(combined$scen,
  #                         levels = scen.list)
  
  #return(combined)
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_line() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Whole population') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}

SF12.change.full.sample.batch <- function(df.list, scen.list) {
  batch.mean <- function(data, scen) {
    newvar.name <- paste0(scen, '.SF12')
    data <- data %>%
      select(time, weight, run_id, SF_12) %>%
      group_by(time, run_id) %>%
      summarise(!!sym(newvar.name) := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  # base <- batch.mean(base.dat, scen = 'base')
  # int1 <- batch.mean(int.dat1, scen = 'int25')
  # int2 <- batch.mean(int.dat2, scen = 'int50')
  # int3 <- batch.mean(int.dat3, scen = 'int75')
  # int4 <- batch.mean(int.dat4, scen = 'int100')
  
  df.list <- mapply(single.mean, df.list, scen.list, SIMPLIFY = FALSE)
  
  #df.list <- list(base, int1, int2, int3, int4)
  combined <- df.list %>%
    reduce(full_join, by=c('time', 'run_id'))

  # combined$diff25 <- combined$int25.SF12 - combined$base.SF12
  # combined$diff50 <- combined$int50.SF12 - combined$base.SF12
  # combined$diff75 <- combined$int75.SF12 - combined$base.SF12
  # combined$diff100 <- combined$int100.SF12 - combined$base.SF12
  
  # List of intervention columns
  int_cols <- grep("int\\d+.SF12", names(combined), value = TRUE)
  
  # Create the new dataframe with differences
  combined <- combined %>%
    mutate(across(all_of(int_cols), ~ . - base.SF12, .names = "diff{col}")) %>%
    select(time, starts_with("diff")) %>%
    rename_with(~ str_replace_all(., "diffint(\\d+).SF12", "diff\\1"))

  combined <- combined %>%
    pivot_longer(cols = starts_with('diff'),
                 names_to = 'scen',
                 values_to = 'diff')

  # combined <- combined %>%
  #   select(time, run_id, contains('diff')) %>%
  #   pivot_longer(cols = diff25:diff100,
  #                names_to = 'scen',
  #                values_to = 'diff')
  
  # TODO: Rename factor levels
  # correct factor levels for plot
  # combined$scen <- factor(combined$scen,
  #                         levels = c('diff100', 'diff75', 'diff50', 'diff25'))
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_smooth() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Whole population') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}
```

```{r SF12_families, echo=FALSE}
SF12.change.families.single <- function(df.list, scen.list) {
  single.mean <- function(data, scen) {
    newvar.name <- paste0(scen, '.SF12')
    data <- data %>%
      select(time, weight, SF_12, nkids) %>%
      filter(nkids > 0) %>%
      group_by(time) %>%
      summarise(!!newvar.name := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  df.list <- mapply(single.mean, df.list, scen.list, SIMPLIFY = FALSE)
  
  combined <- df.list %>%
    reduce(full_join, by='time')

  # List of intervention columns
  int_cols <- grep("int\\d+.SF12", names(combined), value = TRUE)
  
  # Create the new dataframe with differences
  combined <- combined %>%
    mutate(across(all_of(int_cols), ~ . - base.SF12, .names = "diff{col}")) %>%
    select(time, starts_with("diff")) %>%
    rename_with(~ str_replace_all(., "diffint(\\d+).SF12", "diff\\1"))

  combined <- combined %>%
    pivot_longer(cols = starts_with('diff'),
                 names_to = 'scen',
                 values_to = 'diff')
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_line() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Households with Children') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}

SF12.change.families.batch <- function(df.list, scen.list) {
  batch.mean <- function(data, scen) {
    newvar.name <- paste0(scen, '.SF12')
    data <- data %>%
      select(time, weight, run_id, SF_12, nkids) %>%
      filter(nkids > 0) %>%
      group_by(time, run_id) %>%
      summarise(!!newvar.name := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  df.list <- mapply(batch.mean, df.list, scen.list, SIMPLIFY = FALSE)
  
  combined <- df.list %>%
    reduce(full_join, by=c('time', 'run_id'))

  # List of intervention columns
  int_cols <- grep("int\\d+.SF12", names(combined), value = TRUE)
  
  # Create the new dataframe with differences
  combined <- combined %>%
    mutate(across(all_of(int_cols), ~ . - base.SF12, .names = "diff{col}")) %>%
    select(time, starts_with("diff")) %>%
    rename_with(~ str_replace_all(., "diffint(\\d+).SF12", "diff\\1"))

  combined <- combined %>%
    pivot_longer(cols = starts_with('diff'),
                 names_to = 'scen',
                 values_to = 'diff')
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_smooth() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Households with Children') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}
```

```{r SF12_treated, echo=FALSE}
SF12.change.treated.single <- function(df.list, scen.list) {
  single.mean <- function(data, scen, boosted) {
    # define varname
    newvar.name <- paste0(scen, '.SF12')
    # prepare data
    data <- data %>%
      select(pidp, time, weight, SF_12) %>%
      filter(pidp %in% boosted) %>%
      group_by(time) %>%
      summarise(!!newvar.name := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  #TODO: FIX THIS! NEED DIFFERENT BASELINE FOR EACH INT?? THINK SO!
  # NEED A FUNCTION TO DO THE DIFF CALCULATION AND ANOTHER TO RUN IT THROUGH
  # EACH DF
  # get boosted pidps
  boosted <- df.list[[2]] %>%
    select(pidp, income_boosted) %>%
    filter(income_boosted == 'True')
  rm(tmp)
  
  df.list <- mapply(single.mean, df.list, scen.list, boosted, SIMPLIFY = FALSE)

  combined <- df.list %>%
    reduce(full_join, by='time')

  # List of intervention columns
  int_cols <- grep("int\\d+.SF12", names(combined), value = TRUE)
  
  # Create the new dataframe with differences
  combined <- combined %>%
    mutate(across(all_of(int_cols), ~ . - base.SF12, .names = "diff{col}")) %>%
    select(time, starts_with("diff")) %>%
    rename_with(~ str_replace_all(., "diffint(\\d+).SF12", "diff\\1"))

  combined <- combined %>%
    pivot_longer(cols = starts_with('diff'),
                 names_to = 'scen',
                 values_to = 'diff')
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_line() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Treated Population') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}

SF12.change.treated.batch <- function(df.list, scen.list) {
  batch.mean <- function(data, scen, boosted) {
    # define varname
    newvar.name <- paste0(scen, '.SF12')
    # prepare data
    data <- data %>%
      select(pidp, time, weight, run_id, SF_12) %>%
      filter(pidp %in% boosted) %>%
      group_by(time, run_id) %>%
      summarise(!!newvar.name := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  #TODO: FIX THIS! NEED DIFFERENT BASELINE FOR EACH INT?? THINK SO!
  # NEED A FUNCTION TO DO THE DIFF CALCULATION AND ANOTHER TO RUN IT THROUGH
  # EACH DF
  # get boosted pidps
  boosted <- df.list[[2]] %>%
    select(pidp, income_boosted) %>%
    filter(income_boosted == 'True')
  
  df.list <- mapply(single.mean, df.list, scen.list, boosted, SIMPLIFY = FALSE)
  
  combined <- df.list %>%
    reduce(full_join, by=c('time', 'run_id'))

  # List of intervention columns
  int_cols <- grep("int\\d+.SF12", names(combined), value = TRUE)
  
  # Create the new dataframe with differences
  combined <- combined %>%
    mutate(across(all_of(int_cols), ~ . - base.SF12, .names = "diff{col}")) %>%
    select(time, starts_with("diff")) %>%
    rename_with(~ str_replace_all(., "diffint(\\d+).SF12", "diff\\1"))

  combined <- combined %>%
    pivot_longer(cols = starts_with('diff'),
                 names_to = 'scen',
                 values_to = 'diff')
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_smooth() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Treated Population') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}
```

# PLOTS

## MCS - Whole Population

```{r}
if (batch) {
  SF12.change.full.sample.batch(int.list, scen.list)
} else {
  SF12.change.full.sample.single(int.list, scen.list)
}
```

## MCS - Households with Children

```{r}
if (batch) {
  SF12.change.families.batch(int.list, scen.list)
} else {
  SF12.change.families.single(int.list, scen.list)
}
```

## MCS - Treatment on Treated

```{r}
if (batch) {
  SF12.change.treated.batch(int.list, scen.list)
} else {
  SF12.change.treated.single(int.list, scen.list)
}
```






```{r}

```

