---
title: "Scottish Child Payment Interventions"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
---

# SETUP

```{r "setup", include=FALSE}

require(tidyverse)
require(ggplot2)
require(knitr)
require(here)
require(dplyr)
require(tidyr)
require(purrr)

#workingDir <- "/home/luke/Documents/WORK/MINOS/"
workingDir <- normalizePath('../')
knitr::opts_knit$set(root.dir = workingDir)
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
rm(workingDir)
```

Source utils for some functions.

```{r}
source(here::here('minos', 'utils_datain.R'))
#source(here::here('minos', 'utils_validation_vis.R'))
#source(here::here('minos', 'validation', 'utils.r'))
```


```{r}
out.path <- here::here('output', 'default_config_batch')

# define subset of variables to reduce size of batch output
var.list <- c('pidp', 'hidp', 'time', 'weight', 
              'age', 'ethnicity', 'education_state', 'region', 'nkids',
              'hh_income',
              'housing_quality', 'neighbourhood_safety', 'loneliness', 'ncigs', 'nutrition_quality', 'financial_situation', 'urban', 'housing_tenure',
              'SF_12', 'matdep_child')

base <- read_output(out.path, 
                    scenario = 'baseline', 
                    var.list = var.list,
                    verbose = TRUE)
int25All <- read_output(out.path, 
                        scenario = '25All', 
                        var.list = var.list,
                        verbose = TRUE)
int50All <- read_output(out.path, 
                        scenario = '50All', 
                        var.list = var.list,
                        verbose = TRUE)
int75All <- read_output(out.path, 
                        scenario = '75All', 
                        var.list = var.list,
                        verbose = TRUE)
int100All <- read_output(out.path, 
                        scenario = '100All', 
                        var.list = var.list,
                        verbose = TRUE)

int.list <- c(int25All, int50All, int75All, int100All)

# set up a boolean tag for batch or not
# this is necessary because batch runs need slightly different processing before visualisation
if ('run_id' %in% names(base)) {
  batch <- TRUE
} else {
  batch <- FALSE
}

# Save path and save flag
save.path <- here::here('plots', 'SCOTGOV', 'CPR')
create.if.not.exists(save.path)
shall.we.save <- FALSE
plot.width <- 10
plot.height <- 5
```


# FUNCTIONS

```{r SF12_whole_pop, echo=FALSE}
SF12.change.full.sample.single <- function(base.dat, int.dat1, int.dat2, int.dat3, int.dat4) {
  single.mean <- function(data, scen) {
    newvar.name <- paste0(scen, '.SF12')
    data <- data %>%
      select(time, weight, SF_12) %>%
      group_by(time) %>%
      summarise(!!newvar.name := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  base <- single.mean(base.dat, scen = 'base')
  int1 <- single.mean(int.dat1, scen = 'int25')
  int2 <- single.mean(int.dat2, scen = 'int50')
  int3 <- single.mean(int.dat3, scen = 'int75')
  int4 <- single.mean(int.dat4, scen = 'int100')
  
  df.list <- list(base, int1, int2, int3, int4)
  combined <- df.list %>%
    reduce(full_join, by='time')

  combined$diff25 <- combined$int25.SF12 - combined$base.SF12
  combined$diff50 <- combined$int50.SF12 - combined$base.SF12
  combined$diff75 <- combined$int75.SF12 - combined$base.SF12
  combined$diff100 <- combined$int100.SF12 - combined$base.SF12

  combined <- combined %>%
    select(time, contains('diff')) %>%
    pivot_longer(cols = diff25:diff100,
                 names_to = 'scen',
                 values_to = 'diff')
  
  # TODO: Rename factor levels
  # correct factor levels for plot
  combined$scen <- factor(combined$scen,
                          levels = c('diff100', 'diff75', 'diff50', 'diff25'))
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_line() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Whole population') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}

SF12.change.full.sample.batch <- function(base.dat, int.dat1, int.dat2, int.dat3, int.dat4) {
  batch.mean <- function(data, scen) {
    newvar.name <- paste0(scen, '.SF12')
    data <- data %>%
      select(time, weight, run_id, SF_12) %>%
      group_by(time, run_id) %>%
      summarise(!!newvar.name := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  base <- batch.mean(base.dat, scen = 'base')
  int1 <- batch.mean(int.dat1, scen = 'int25')
  int2 <- batch.mean(int.dat2, scen = 'int50')
  int3 <- batch.mean(int.dat3, scen = 'int75')
  int4 <- batch.mean(int.dat4, scen = 'int100')
  
  df.list <- list(base, int1, int2, int3, int4)
  combined <- df.list %>%
    reduce(full_join, by=c('time', 'run_id'))

  combined$diff25 <- combined$int25.SF12 - combined$base.SF12
  combined$diff50 <- combined$int50.SF12 - combined$base.SF12
  combined$diff75 <- combined$int75.SF12 - combined$base.SF12
  combined$diff100 <- combined$int100.SF12 - combined$base.SF12

  combined <- combined %>%
    select(time, run_id, contains('diff')) %>%
    pivot_longer(cols = diff25:diff100,
                 names_to = 'scen',
                 values_to = 'diff')
  
  # TODO: Rename factor levels
  # correct factor levels for plot
  combined$scen <- factor(combined$scen,
                          levels = c('diff100', 'diff75', 'diff50', 'diff25'))
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_smooth() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Whole population') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}
```

```{r SF12_families, echo=FALSE}
SF12.change.families.single <- function(base.dat, int.dat1, int.dat2, int.dat3, int.dat4) {
  single.mean <- function(data, scen) {
    newvar.name <- paste0(scen, '.SF12')
    data <- data %>%
      select(time, weight, SF_12, nkids) %>%
      filter(nkids > 0) %>%
      group_by(time) %>%
      summarise(!!newvar.name := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  base <- single.mean(base.dat, scen = 'base')
  int1 <- single.mean(int.dat1, scen = 'int25')
  int2 <- single.mean(int.dat2, scen = 'int50')
  int3 <- single.mean(int.dat3, scen = 'int75')
  int4 <- single.mean(int.dat4, scen = 'int100')
  
  df.list <- list(base, int1, int2, int3, int4)
  combined <- df.list %>%
    reduce(full_join, by='time')

  combined$diff25 <- combined$int25.SF12 - combined$base.SF12
  combined$diff50 <- combined$int50.SF12 - combined$base.SF12
  combined$diff75 <- combined$int75.SF12 - combined$base.SF12
  combined$diff100 <- combined$int100.SF12 - combined$base.SF12

  combined <- combined %>%
    select(time, contains('diff')) %>%
    pivot_longer(cols = diff25:diff100,
                 names_to = 'scen',
                 values_to = 'diff')
  
  # TODO: Rename factor levels
  # correct factor levels for plot
  combined$scen <- factor(combined$scen,
                          levels = c('diff100', 'diff75', 'diff50', 'diff25'))
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_line() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Households with Children') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}

SF12.change.families.batch <- function(base.dat, int.dat1, int.dat2, int.dat3, int.dat4) {
  batch.mean <- function(data, scen) {
    newvar.name <- paste0(scen, '.SF12')
    data <- data %>%
      select(time, weight, run_id, SF_12, nkids) %>%
      filter(nkids > 0) %>%
      group_by(time, run_id) %>%
      summarise(!!newvar.name := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  base <- batch.mean(base.dat, scen = 'base')
  int1 <- batch.mean(int.dat1, scen = 'int25')
  int2 <- batch.mean(int.dat2, scen = 'int50')
  int3 <- batch.mean(int.dat3, scen = 'int75')
  int4 <- batch.mean(int.dat4, scen = 'int100')
  
  df.list <- list(base, int1, int2, int3, int4)
  combined <- df.list %>%
    reduce(full_join, by=c('time', 'run_id'))

  combined$diff25 <- combined$int25.SF12 - combined$base.SF12
  combined$diff50 <- combined$int50.SF12 - combined$base.SF12
  combined$diff75 <- combined$int75.SF12 - combined$base.SF12
  combined$diff100 <- combined$int100.SF12 - combined$base.SF12

  combined <- combined %>%
    select(time, run_id, contains('diff')) %>%
    pivot_longer(cols = diff25:diff100,
                 names_to = 'scen',
                 values_to = 'diff')
  
  # TODO: Rename factor levels
  # correct factor levels for plot
  combined$scen <- factor(combined$scen,
                          levels = c('diff100', 'diff75', 'diff50', 'diff25'))
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_smooth() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Households with Children') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}
```

```{r SF12_treated, echo=FALSE}
SF12.change.treated.single <- function(base.dat, int.dat1, int.dat2, int.dat3, int.dat4) {
  single.mean <- function(data, scen, boosted) {
    # define varname
    newvar.name <- paste0(scen, '.SF12')
    # prepare data
    data <- data %>%
      select(pidp, time, weight, SF_12) %>%
      filter(pidp %in% boosted) %>%
      group_by(time) %>%
      summarise(!!newvar.name := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  #TODO: FIX THIS! NEED DIFFERENT BASELINE FOR EACH INT?? THINK SO!
  # NEED A FUNCTION TO DO THE DIFF CALCULATION AND ANOTHER TO RUN IT THROUGH
  # EACH DF
  # get boosted pidps
  boosted <- int.dat1 %>%
    select(pidp, income_boosted) %>%
    filter(income_boosted == 'True')
  
  base <- single.mean(base.dat, scen = 'base', boosted$pidp)
  int1 <- single.mean(int.dat1, scen = 'int25', boosted$pidp)
  int2 <- single.mean(int.dat2, scen = 'int50', boosted$pidp)
  int3 <- single.mean(int.dat3, scen = 'int75', boosted$pidp)
  int4 <- single.mean(int.dat4, scen = 'int100', boosted$pidp)
  
  df.list <- list(base, int1, int2, int3, int4)
  combined <- df.list %>%
    reduce(full_join, by='time')

  combined$diff25 <- combined$int25.SF12 - combined$base.SF12
  combined$diff50 <- combined$int50.SF12 - combined$base.SF12
  combined$diff75 <- combined$int75.SF12 - combined$base.SF12
  combined$diff100 <- combined$int100.SF12 - combined$base.SF12

  combined <- combined %>%
    select(time, contains('diff')) %>%
    pivot_longer(cols = diff25:diff100,
                 names_to = 'scen',
                 values_to = 'diff')
  
  # TODO: Rename factor levels
  # correct factor levels for plot
  combined$scen <- factor(combined$scen,
                          levels = c('diff100', 'diff75', 'diff50', 'diff25'))
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_line() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Treated Population') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}

SF12.change.treated.batch <- function(base.dat, int.dat1, int.dat2, int.dat3, int.dat4) {
  batch.mean <- function(data, scen, boosted) {
    # define varname
    newvar.name <- paste0(scen, '.SF12')
    # prepare data
    data <- data %>%
      select(pidp, time, weight, run_id, SF_12) %>%
      filter(pidp %in% boosted) %>%
      group_by(time, run_id) %>%
      summarise(!!newvar.name := weighted.mean(SF_12, w = weight))
    return(data)
  }
  
  #TODO: FIX THIS! NEED DIFFERENT BASELINE FOR EACH INT?? THINK SO!
  # NEED A FUNCTION TO DO THE DIFF CALCULATION AND ANOTHER TO RUN IT THROUGH
  # EACH DF
  # get boosted pidps
  boosted <- int.dat1 %>%
    select(pidp, income_boosted) %>%
    filter(income_boosted == 'True')
  
  base <- batch.mean(base.dat, scen = 'base', boosted$pidp)
  int1 <- batch.mean(int.dat1, scen = 'int25', boosted$pidp)
  int2 <- batch.mean(int.dat2, scen = 'int50', boosted$pidp)
  int3 <- batch.mean(int.dat3, scen = 'int75', boosted$pidp)
  int4 <- batch.mean(int.dat4, scen = 'int100', boosted$pidp)
  
  df.list <- list(base, int1, int2, int3, int4)
  combined <- df.list %>%
    reduce(full_join, by=c('time', 'run_id'))

  combined$diff25 <- combined$int25.SF12 - combined$base.SF12
  combined$diff50 <- combined$int50.SF12 - combined$base.SF12
  combined$diff75 <- combined$int75.SF12 - combined$base.SF12
  combined$diff100 <- combined$int100.SF12 - combined$base.SF12

  combined <- combined %>%
    select(time, run_id, contains('diff')) %>%
    pivot_longer(cols = diff25:diff100,
                 names_to = 'scen',
                 values_to = 'diff')
  
  # TODO: Rename factor levels
  # correct factor levels for plot
  combined$scen <- factor(combined$scen,
                          levels = c('diff100', 'diff75', 'diff50', 'diff25'))
  
  p1 <- ggplot(combined, aes(x = time, y = diff, group = scen, colour = scen)) +
    geom_smooth() +
    geom_hline(yintercept = 0, linetype='dashed') +
    labs(title = 'Relative change in SF12 MCS', subtitle = 'Treated Population') +
    xlab('Year') +
    ylab('Difference')
  
  print(p1)
}
```

# PLOTS

## MCS - Whole Population

```{r}
if (batch) {
  SF12.change.full.sample.batch(base, int25All, int50All, int75All, int100All)
} else {
  SF12.change.full.sample.single(base, int25All, int50All, int75All, int100All)
}
```

## MCS - Households with Children

```{r}
if (batch) {
  SF12.change.families.batch(base, int25All, int50All, int75All, int100All)
} else {
  SF12.change.families.single(base, int25All, int50All, int75All, int100All)
}
```

## MCS - Treatment on Treated

```{r}
if (batch) {
  print('batch')
  SF12.change.treated.batch(base, int25All, int50All, int75All, int100All)
} else {
  SF12.change.treated.single(base, int25All, int50All, int75All, int100All)
}
```

