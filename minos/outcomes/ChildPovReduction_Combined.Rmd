---
title: "Scottish Child Poverty Briefing Plots"
output:
  pdf_document:
    toc: true
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
---


WS5 (Dynamic Microsimulation): What are the impacts on mental health of meeting the targets?
·        Across the population? 
·        Population by income quintile (looking at absolute/relative inequalities)?
·        For families only? By income quintile (looking at absolute/relative inequalities)?
·        For families that meet criteria of 0/1/2+ of the priority family groups?
·        Differential impacts of UK package of policies only, and then UK package with SG policies?


```{r "setup", include=FALSE}

require(tidyverse)
require(ggplot2)

#workingDir <- "/home/luke/Documents/WORK/MINOS/Minos/output/default_config/scp_summary_out/"
#workingDir <- "/home/luke/Documents/WORK/MINOS/Minos/output/default_config/cpr_summary_out/"
#workingDir <- "/home/luke/Documents/WORK/MINOS/SCP_ARC_SUMMARIES/"
#workingDir <- "/home/luke/Documents/WORK/MINOS/CPR_ARC_SUMMARIES/"
workingDir <- "/home/luke/Documents/WORK/MINOS/CPR_ARC_SUMMARIES/old/old7_scot/"
knitr::opts_knit$set(root.dir = workingDir)
rm(workingDir)
```

```{r "data_in_functions", include=FALSE}

generate_df_list <- function(summary, scen.list) {
  df.list <- lapply(scen.list, function(scen) {
    df <- read.csv(file = sprintf('%s/combined_summary_%s.csv', scen, summary))
    df$scen <- scen
    return(df)
  })
  return(df.list)
}

```

```{r "SF12_change_simple_functions", include=FALSE}
SF12_change_simple <- function(summary_group, scen.list) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  if (summary_group == 'priority_any') { tit <- 'Any Priority Subgroup' }
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  plot_data <- data %>%
    select(run_id, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"), 
                 names_to = c(".value", "scen"), 
                 names_sep = "\\.") %>%
    filter(scen != 'baseline')
  
  plot_data_confint <- plot_data %>%
    group_by(year) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  plot_data_confint2 <- plot_data %>%
    group_by(year) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qnorm(0.975) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
    
  
  p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p3 <- ggplot(plot_data_confint2, aes(x = year, y = mean_SF12_change)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  print(p1)
  print(p2)
  #print(p3)
}
```

```{r "SF12_change_income_quint", include=FALSE}
SF12_change_income_quint <- function(summary_group, scen.list) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  
  summary_group <- paste0(summary_group, '_income_quint')
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  plot_data <- data %>%
    select(run_id, income_quintile, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    select(-scen)
  
  plot_data$income_quintile <- factor(plot_data$income_quintile)
  
  plot_data_confint <- plot_data %>%
    group_by(year, income_quintile) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  plot_data_confint2 <- plot_data %>%
    group_by(year, income_quintile) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qnorm(0.975) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
    
  
  p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12, group = income_quintile, colour = income_quintile, fill = income_quintile)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    labs(title = tit, subtitle = 'Income Quintile') +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change, group = income_quintile, colour = income_quintile, fill = income_quintile)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit, subtitle = 'Income Quintile') +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p3 <- ggplot(plot_data_confint2, aes(x = year, y = mean_SF12_change, group = income_quintile, colour = income_quintile, fill = income_quintile)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit, subtitle = 'Income Quintile') +
    xlab('Year') +
    ylab('Change in SF-12')
  
  print(p1)
  print(p2)
}
```

```{r "SF12_change_num_priority_groups", include=FALSE}
SF12_change_num_priority_groups <- function(scen.list) {

  summary_group <- 'priority_num'
  
  tit <- 'Number of Priority Subgroups'
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  data <- replace_na(data, list(num_priority_groups=0))
  
  plot_data <- data %>%
    select(run_id, num_priority_groups, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    select(-scen)
  
  plot_data$num_priority_groups <- factor(plot_data$num_priority_groups)
  
  plot_data_confint <- plot_data %>%
    group_by(year, num_priority_groups) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  plot_data_confint2 <- plot_data %>%
    group_by(year, num_priority_groups) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qnorm(0.975) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  
  p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  p3 <- ggplot(plot_data_confint2, aes(x = year, y = mean_SF12_change, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in SF-12')
  
  print(p1)
  print(p2)
}
```

```{r "inequality_plots", include=FALSE}
inequality_plots <- function(summary_group, scen.list) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  
  summary_group <- paste0(summary_group, '_income_quint')
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  data$income_quintile <- factor(data$income_quintile)
  
  # Combine the data
  data_combined <- data %>%
    mutate(scenario = ifelse(scen == 'baseline', 'Baseline', 'Intervention'))
  
  p1 <- ggplot(data_combined, aes(x = year, y = SF_12, group = interaction(income_quintile, scenario), color = income_quintile, linetype = scenario)) +
    geom_smooth(alpha = 0.7) +
    scale_color_manual(name = "Income Quintile", 
                       values = c("red", "blue", "green", "orange", "purple")) +
    scale_linetype_manual(name = "Scenario", 
                          values = c("Baseline" = "solid", "Intervention" = "dotted")) +
    labs(title = "SF_12 Scores by Income Quintile",
         subtitle = tit,
         x = "Year",
         y = "Mean SF_12 MCS") +
    theme_minimal() +
    theme(legend.position = "right",
          legend.title = element_text(size = 12),
          legend.text = element_text(size = 10))
  
  # Aggregate data
  agg_data <- data %>%
    mutate(scenario = ifelse(scen == 'baseline', 'Baseline', 'Intervention')) %>%
    group_by(year, income_quintile, scenario) %>%
    summarize(mean_SF_12 = mean(SF_12, na.rm = TRUE)) %>%
    spread(scenario, mean_SF_12) %>%
    mutate(difference = Intervention - Baseline)
  
  p2 <- ggplot(agg_data, aes(x = year, y = difference, fill = income_quintile)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_manual(name = "Income Quintile", 
                      values = c("red", "blue", "green", "orange", "purple")) +
    labs(title = "Average Difference in SF_12 Scores by Income Quintile",
         subtitle = tit,
         x = "Year",
         y = "Difference in SF_12 Score") +
    theme_minimal() +
    theme(legend.position = "right",
          legend.title = element_text(size = 12),
          legend.text = element_text(size = 10))
  
  print(p1)
  print(p2)
}
```

```{r "Data", include=FALSE}
scen.list.rel <- c('baseline', 'ChildPovertyReductionRELATIVE_2')
scen.list.abs <- c('baseline', 'ChildPovertyReductionABSOLUTE')
```

# RELATIVE POVERTY INTERVENTION

Reducing the proportion of children in poverty to 10% or lower by 2030.

## Whole Population

What are the impacts on mental health of meeting the targets:

- Across the population?
- Population by income quintile?

```{r}
SF12_change_simple(summary_group = 'whole_pop',
                   scen.list = scen.list.rel)
```

### Income Quintiles

```{r}
SF12_change_income_quint(summary_group = 'whole_pop',
                                    scen.list = scen.list.rel)
```

### SF_12 Inequality

```{r}
inequality_plots(summary_group = 'whole_pop',
                 scen.list = scen.list.rel)
```


## Families

What are the impacts on mental health of meeting the targets:

- For families only? By income quintile

```{r}
SF12_change_simple(summary_group = 'families',
                       scen.list = scen.list.rel)
```

### Income Quintile

```{r}
SF12_change_income_quint(summary_group = 'families',
                                    scen.list = scen.list.rel)
```

### SF_12 Inequality

```{r}
inequality_plots(summary_group = 'families',
                 scen.list = scen.list.rel)
```

## Priority Subgroups

What are the impacts on mental health of meeting the targets:

- For families that meet the criteria of 0/1/2+ of the priority family groups?

```{r}
SF12_change_simple(summary_group = 'priority_any',
                       scen.list = scen.list.rel)
```

### Number of Priority Subgroups

Results disaggregated by if household belongs to 0, 1, 2, 3+ priority subgroups.

```{r}
SF12_change_num_priority_groups(scen.list.rel)
```

## Differential Impacts of UK vs SG

What are the impacts on mental health of meeting the targets?

- Differential impacts of UK package of policies only, and then UK package with SG policies?



# ABSOLUTE POVERTY INTERVENTION

Reducing the proportion of children in poverty to 10% or lower by 2030.

## Whole Population

What are the impacts on mental health of meeting the targets:

- Across the population?
- Population by income quintile?

```{r}
SF12_change_simple(summary_group = 'whole_pop',
                       scen.list = scen.list.abs)
```

### Income Quintile

```{r}
SF12_change_income_quint(summary_group = 'whole_pop',
                                    scen.list = scen.list.abs)
```

### SF_12 Inequality

```{r}
inequality_plots(summary_group = 'whole_pop',
                 scen.list = scen.list.abs)
```

## Families

What are the impacts on mental health of meeting the targets:

- For families only? By income quintile

```{r}
SF12_change_simple(summary_group = 'families',
                       scen.list = scen.list.abs)
```

### Income Quintile

```{r}
SF12_change_income_quint(summary_group = 'families',
                                    scen.list = scen.list.abs)
```

### SF_12 Inequality

```{r}
inequality_plots(summary_group = 'families',
                 scen.list = scen.list.abs)
```

## Priority Subgroups

What are the impacts on mental health of meeting the targets:

- For families that meet the criteria of 0/1/2+ of the priority family groups?

```{r}
SF12_change_simple(summary_group = 'priority_any',
                                    scen.list = scen.list.abs)
```

### Number of Priority Subgroups

Results disaggregated by if household belongs to 0, 1, 2, 3+ priority subgroups.

```{r}
SF12_change_num_priority_groups(scen.list.abs)
```

## Differential Impacts of UK vs SG

What are the impacts on mental health of meeting the targets?

- Differential impacts of UK package of policies only, and then UK package with SG policies?


```{r}

```

