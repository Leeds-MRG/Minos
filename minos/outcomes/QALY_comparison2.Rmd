---
params:
  experiment: ''
  base: ''
  intervention: ''
  start.year: ''
title: "QALY Comparisons - `r params$experiment` - `r params$intervention` - `r params$baseline`"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
---

# SETUP

```{r "setup", include=FALSE}

library(tidyverse)
library(ggplot2)
library(knitr)
library(here)
library(MESS)
library(scales)

#workingDir <- "/home/luke/Documents/WORK/MINOS/PLOTS_FROM_ARC/QALY_SCP_28Feb/QALY_analysis_SCP_test/"
#workingDir <- "/home/luke/Documents/WORK/MINOS/PLOTS_FROM_ARC/tmp/"
workingDir <- normalizePath('../')
knitr::opts_knit$set(root.dir = workingDir)
knitr::opts_chunk$set(
  options(scipen = 999)
)
rm(workingDir)
```

```{r}
#source_dir <- '/home/luke/Documents/WORK/MINOS/Minos/minos'
#datain <- here::here(source_dir, 'utils_datain.R')

source(here::here('minos', 'utils_datain.R'))
source(here::here('minos', 'utils_qaly.R'))
```

## Parameters

```{r}
experiment <- params$experiment
baseline <- params$base
ints <- params$intervention
start.year <- params$start.year
# #
#experiment <- 'default_batch_10'
# experiment <- 'default_config'
# baseline <- 'baseline'
# #ints <- c('25UniversalCredit', '50UniversalCredit', '75UniversalCredit', '100UniversalCredit')
# ints <- c('25All', '50All', '75All', '100All')
# #ints <- c('25All', '50All', '100All')
# start.year <- 2021
```


## Data

```{r}
# read in QALY files for baseline and interventions
out.path <- here::here('output', experiment)

expts <- c(baseline, ints)


combined <- data.frame()
for (expt in expts) {
  path <- get_latest_runtime_subdirectory(here::here(out.path, expt))
  data <- read.csv(paste0(path, 'qalys.csv'))
  combined <- rbind(combined, data)
}
```


```{r}
# # read in QALY files for baseline and interventions
# out.path <- here::here('output', experiment)
# 
# base.path <- get_latest_runtime_subdirectory(here::here(out.path, baseline))
# int.path <- get_latest_runtime_subdirectory(here::here(out.path, intervention1))
# 
# if (intervention2 != '') {
#   int2.path <- get_latest_runtime_subdirectory(here::here(out.path, intervention2))
# }
# 
# base <- read.csv(paste0(base.path, 'qalys.csv'))
# int <- read.csv(paste0(int.path, 'qalys.csv'))
# 
# # combine the dataframes
# combined <- rbind(base, int)
```



TESTING TEMPORARY TEMPORARY TEMPORARY TEMPORARY TEMPORARY TEMPORARY TEMPORARY 
```{r}
# out.path <- here::here('output', 'tmp_down2/')
# 
# baseline <- 'baseline'
# ints <- c('25All', '50All', '75All', '100All')
# 
# start.year <- 2021
# 
# expts <- c(baseline, ints)
# 
# combined <- data.frame()
# for (expt in expts) {
#   data <- read.csv(paste0(out.path, expt, '_qalys.csv'))
#   combined <- rbind(combined, data)
# }
```
TESTING TEMPORARY TEMPORARY TEMPORARY TEMPORARY TEMPORARY TEMPORARY TEMPORARY 

# Sample Information

```{r}

```


# Intervention Information

## Boosted Population

```{r}
combined.pop_boosted <- combined %>%
  group_by(year, intervention, run_id) %>%
  summarise(pop_boosted = sum(pop_boosted, na.rm = TRUE))

# print(paste("There are", sum(is.na(combined.pop_boosted$pop_boosted)), "NA pop_boosted values in combined.pop.boosted.", sep = ' '))

combined.pop_boosted.boxplot <- combined.pop_boosted %>%
  filter(year != start.year) %>%
  filter(intervention != baseline)

ggplot(combined.pop_boosted.boxplot, aes(x = year, y = pop_boosted, group = interaction(year, intervention), color = intervention)) +
  geom_boxplot() +
  labs(title = 'Number Individuals Receiving Intervention')

```

## Boost Amount

```{r}

combined.diff <- combined %>%
  select(run_id, year, intervention, total_boost) %>%
  pivot_wider(names_from = 'intervention',
              values_from = 'total_boost') %>%
  mutate(across(all_of(ints), ~.x - .data[[baseline]], .names = "diff_{.col}")) %>%
  select(run_id, year, contains('diff_')) %>%
  pivot_longer(cols = contains('diff_'),
               names_prefix = 'diff_',
               names_to = 'scenario',
               values_to = 'total_boost')

ggplot(combined.diff, aes(x = year, y = total_boost, group = scenario, color = scenario)) +
  geom_smooth() +
  labs(title = 'Total Boost amount by year') +
  scale_y_continuous(label = comma)
# 
# ggplot(combined, aes(x = year, y = alive_ratio, group = intervention, colour = intervention)) +
#   geom_smooth() +
#   labs(title = 'Ratio of living to dead in output dataframe')
# 
# ## incidence of mortality
# deaths <- combined %>%
#   select(run_id, intervention, year, alive_pop, dead_pop) %>%
#   group_by(run_id, intervention) %>%
#   mutate(total_pop = alive_pop + dead_pop,
#          deaths_this_year = dead_pop - lag(dead_pop)) %>%
#   group_by(run_id, year, intervention) %>%
#   summarise(death_incidence = deaths_this_year / total_pop)
# 
# ggplot(deaths, aes(x = year, y = death_incidence, group = intervention, colour = intervention)) +
#   geom_smooth() +
#   labs(title = 'Incidence of Mortality Comparison')
```

# QALY comparison

```{r}
QALY_comparison(combined, ints)
```


```{r}
# #QALY_comparison <- function(combined, ints) {
#   
# p1 <- ggplot(data = combined, aes(x = year, y = QALYs, group = intervention, colour = intervention)) +
#   geom_smooth() +
#   labs(title = 'QALYs per year')
# print(p1)
# 
# # Now change from baseline
# combined.QALY.change <- combined %>%
#   select(run_id, year, intervention, QALYs) %>%
#   pivot_wider(names_from = 'intervention',
#               values_from = 'QALYs') %>%
#   #mutate(QALYs = .data[[int.name]] - .data[[base.name]]) %>%
#   mutate(across(all_of(ints), ~.x - .data[[baseline]], .names = "QALYs_{.col}")) %>%
#   select(run_id, year, contains('QALYs')) %>%
#   pivot_longer(cols = contains('QALYs'),
#                names_prefix = 'QALYs_',
#                names_to = 'scenario',
#                values_to = 'QALYs')
# 
# p2 <- ggplot(data = combined.QALY.change, aes(x = year, y = QALYs, group = scenario, color = scenario, fill = scenario)) +
#   geom_hline(yintercept = 0, linetype = 'dashed') +
#   geom_smooth() +
#   labs(title = 'QALY change')
# print(p2)
# 
# combined.QALY.change$year <- as.factor(combined.QALY.change$year)
# combined.QALY.change$scenario <- as.factor(combined.QALY.change$scenario)
# 
# p3 <- ggplot(data = combined.QALY.change, aes(x = year, y = QALYs, group = interaction(year, scenario), fill = scenario)) +
#   geom_boxplot() +
#   stat_summary(fun=mean, geom="line", aes(group=scenario), linetype = 'dashed')  + 
#   stat_summary(fun=mean, geom="point", aes(group=scenario))
# print(p3)
# 
# 
# 
# combined.QALY.change.confint <- combined.QALY.change %>%
#   group_by(year, scenario) %>%
#   summarise(n = n(),
#             mean_QALY_change = mean(QALYs),
#             margin = qt(0.975, df = n - 1) * (sd(QALYs) / sqrt(n)),
#             lower = mean_QALY_change - margin,
#             upper = mean_QALY_change + margin)
# 
# p4 <- ggplot(combined.QALY.change.confint, aes(x = year, y = mean_QALY_change, group = scenario, color = scenario, fill = scenario)) +  # 
#   geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.5) +
#   geom_line(aes(color = scenario), linetype = 'dashed') +
#   geom_hline(yintercept = 0, linetype = 'dashed') +
#   labs(title = 'QALY Change') +
#   xlab('Year') +
#   ylab('QALYs')
# print(p4)
# 
# 
# #}
```


## SF12 Change

```{r}
sf12.plots(combined, ints)
```



## Area Under the Curve

```{r}
auc.plots(combined, ints)
```


# Cost per QALY

The [UK Government](https://www.gov.uk/government/publications/valuation-of-risks-to-life-and-health-monetary-value-of-a-life-year-voly/a-scoping-study-on-the-valuation-of-risks-to-life-and-health-the-monetary-value-of-a-life-year-voly) has set the value of 1 QALY to be equal to $60,000. This is the number we will use for our calculations.

```{r}
# cost.per.qaly(base = base,
#               base.name = baseline,
#               int = int,
#               int.name = intervention,
#               QALY_value = 70000,  # QALY value == £70,000
#               int.label <- intervention)
```


# Incremental Cost-Effectiveness Ratio

From [NICE guidelines](https://www.nice.org.uk/process/pmg6/chapter/assessing-cost-effectiveness) about the cost-effectiveness of health interventions (7.3), and works with a statistic called the Incremental Cost-Effectiveness Ratio (ICER). The formula for calculating the ICER can be found [here](https://en.wikipedia.org/wiki/Incremental_cost-effectiveness_ratio), but in short, it represents the average incremental cost associated with 1 additional unit of the measurement of effect. In our case, the unit of measurement of effect is a QALY. 

From the NICE guidelines, there is a general consensus that anything below £20,000 is cost effective, and anything above £30,000 is not. Between £20,000 and £30,000 is a grey area, and depends on the field and other factors to decide (i.e. if a rare or important condition is tackled by an intervention then the cost-effective threshold is higher). 

```{r}
ICER(combined,
     ints,
     QALY_value = 70000,
     start.year = start.year)
```


# Total Cost of Intervention

```{r}
# intervention.cost(base = base,
#                   base.name = baseline,
#                   int = int,
#                   int.name = intervention,
#                   int.label = intervention)
```



```{r}

```

