---
title: "SCP Briefing Plots - Combined Intervention"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
  pdf_document:
    toc: true
---


```{r "setup", include=FALSE}

require(tidyverse)
require(ggplot2)

#workingDir <- "/home/luke/Documents/WORK/MINOS/Minos/output/default_config/cpr_summary_out/"
workingDir <- "/home/luke/Documents/WORK/MINOS/CPR_ARC_SUMMARIES/"
#workingDir <- "/home/luke/Documents/MINOS/CPR_ARC_SUMMARIES/old/old_33_scot_clipped/"
#workingDir <- "/home/luke/Documents/WORK/MINOS/CPR_ARC_SUMMARIES/old/old_27_scot_XGB_scaled/"
#workingDir <- "/home/luke/Documents/WORK/MINOS/CPR_ARC_SUMMARIES/old/old_28_scot_scaled_GOOD/"
#workingDir <- "/home/luke/Documents/WORK/MINOS/CPR_ARC_SUMMARIES/old/old_29_scot_scaled_skew_GOOD/"
#workingDir <- "/home/luke/Documents/MINOS/CPR_ARC_SUMMARIES/old/old_28_scot_scaled_GOOD/"
#workingDir <- "/home/luke/Documents/WORK/MINOS/CPR_ARC_SUMMARIES/old/old8_scot/"
knitr::opts_knit$set(root.dir = workingDir)
rm(workingDir)
```

```{r "data_in_functions", include=FALSE}

generate_df_list <- function(summary, scen.list) {
  df.list <- lapply(scen.list, function(scen) {
    df <- read.csv(file = sprintf('%s/combined_summary_%s.csv', scen, summary))
    df$scen <- scen
    return(df)
  })
  return(df.list)
}

```


```{r "SF12_change_simple_functions", include=FALSE}
SF12_change_simple <- function(summary_group, scen.list) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { 
    tit <- 'Whole Population'
    plot_colour <- 'black'
    }
  if (summary_group == 'families') { 
    tit <- 'Families'
    plot_colour <- '#56B4E9'
    }
  if (summary_group == 'treated_relative') { 
    tit <- 'Treated'
    plot_colour <- 'black'}
  if (summary_group == 'treated_absolute') { 
    tit <- 'Treated'
    plot_colour <- 'black'}
  if (summary_group == 'priority_any') { 
    tit <- 'Any Priority Subgroup' 
    plot_colour <- 'black' }
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  plot_data <- data %>%
    select(run_id, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"), 
                 names_to = c(".value", "scen"), 
                 names_sep = "\\.") %>%
    filter(scen != 'baseline')
  
  plot_data_confint <- plot_data %>%
    group_by(year) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  plot_data_confint2 <- plot_data %>%
    group_by(year) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qnorm(0.975) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
    
  
  p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    xlab('Year') +
    ylab('Change in Mean SF-12 MCS') +
    theme_minimal()
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed', color=plot_colour) +
    geom_point(color=plot_colour) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    xlab('Year') +
    ylab('Change in Mean SF-12 MCS') +
    theme_minimal()
  
  p3 <- ggplot(plot_data_confint2, aes(x = year, y = mean_SF12_change)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed', color=plot_colour) +
    geom_point(color=plot_colour) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    xlab('Year') +
    ylab('Change in Mean SF-12 MCS') +
    theme_minimal()
  
  print(p1)
  print(p2)
  #print(p3)
  
  ggsave(filename = paste0(summary_group, '_smooth', '.png'),
         plot = p1)
  
  ggsave(filename = paste0(summary_group, '_confint', '.png'),
         plot = p2)
}

SF12_change_ind_trajectories <- function(summary_group, scen.list) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  if (summary_group == 'priority_any') { tit <- 'Any Priority Subgroup' }
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  plot_data <- data %>%
    select(run_id, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"), 
                 names_to = c(".value", "scen"), 
                 names_sep = "\\.") %>%
    filter(scen != 'baseline')
  
  plot_data_confint <- plot_data %>%
    group_by(year) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  p1 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_line(data = plot_data, aes(x = year, y = diff_SF_12, group = run_id), alpha = 0.2) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    labs(title = tit) +
    xlab('Year') +
    ylab('Change in Mean SF-12 MCS') +
    theme_minimal()
  
  print(p1)
  
  ggsave(filename = paste0(summary_group, '_trajectories', '.png'),
         plot = p1)
}

```

```{r "SF12_change_income_quint", include=FALSE}
SF12_change_income_quint <- function(summary_group, scen.list) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  
  summary_group <- paste0(summary_group, '_income_quint')
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  plot_data <- data %>%
    select(run_id, income_quintile, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    select(-scen)
  
  plot_data$income_quintile <- factor(plot_data$income_quintile)
  
  plot_data_confint <- plot_data %>%
    group_by(year, income_quintile) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  plot_data_confint2 <- plot_data %>%
    group_by(year, income_quintile) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qnorm(0.975) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
    
  
  p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12, group = income_quintile, colour = income_quintile, fill = income_quintile)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    xlab('Year') +
    ylab('Change in Mean SF-12 MCS') +
    theme_minimal() +
    guides(fill=guide_legend(title="Income Quintile"))
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change, group = income_quintile, colour = income_quintile, fill = income_quintile)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    xlab('Year') +
    ylab('Change in Mean SF-12 MCS') +
    theme_minimal() +
    guides(fill=guide_legend(title="Income Quintile"))
  
  p3 <- ggplot(plot_data_confint2, aes(x = year, y = mean_SF12_change, group = income_quintile, colour = income_quintile, fill = income_quintile)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    xlab('Year') +
    ylab('Change in Mean SF-12 MCS') +
    theme_minimal() +
    guides(fill=guide_legend(title="Income Quintile"))
  
  print(p1)
  print(p2)
  
  ggsave(filename = paste0(summary_group, '_quintile_smooth', '.png'),
         plot = p1)
  
  ggsave(filename = paste0(summary_group, '_quintile_actual', '.png'),
         plot = p2)
}

SF12_change_income_quint2 <- function(summary_group, scen) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  
  summary_group <- paste0(summary_group, '_income_quint_together')
  scen <- paste0(scen, '_together')
  
  data <- do.call(rbind, generate_df_list(summary_group, scen))
  
  plot_data <- data %>%
    select(run_id, SF_12, income_quintile, year, scenario) %>%
    pivot_wider(names_from = scenario,
                values_from = SF_12,
                names_sep = '.',
                values_fn = list(SF_12 = function(x) x[1])) %>%
    mutate(diff_SF12 = intervention - baseline) %>%
    pivot_longer(cols = starts_with("diff"),
                 names_to = c(".value", "scenario"),
                 names_sep = "\\.") %>%
    select(run_id, income_quintile, year, diff_SF12)
  
  plot_data_confint <- plot_data %>%
      group_by(year, income_quintile) %>%
      summarise(n = n(),
                mean_SF12_change = mean(diff_SF12),
                margin_SF12 = qt(0.975, df = n - 1) * (sd(diff_SF12) / sqrt(n)),
                lower_SF12 = mean_SF12_change - margin_SF12,
                upper_SF12 = mean_SF12_change + margin_SF12)
  
  plot_data_confint$income_quintile <- factor(plot_data_confint$income_quintile)
  
  # p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12)) +
  #     geom_hline(yintercept = 0, linetype = 'dashed') +
  #     geom_vline(xintercept = 2030, linetype = 'dotted') +
  #     geom_smooth() +
  #     labs(title = 'Treatment on the Treated',
  #          subtitle = 'SF_12') +
  #     xlab('Year') +
  #     ylab('Change in mean SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change, group = income_quintile, color = income_quintile, fill = income_quintile)) +
      geom_ribbon(aes(ymin = lower_SF12, ymax = upper_SF12), linetype = 'dotted', alpha = 0.3) +
      geom_line(linetype = 'dashed') +
      geom_point(show.legend = FALSE) +
      geom_hline(yintercept = 0, linetype = 'dashed') +
      geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
      xlab('Year') +
      ylab('Change in Mean SF-12 MCS') +
      theme_minimal() +
      guides(fill=guide_legend(title="Income Quintile"),
             linetype=guide_legend(title="Income Quintile"),
             group=guide_legend(title="Income Quintile"),
             color=guide_legend(title="Income Quintile"))
  
  #print(p1)
  print(p2)
  
  ggsave(filename = paste0(summary_group, '_quintile', '.png'),
         plot = p2)
}

SF12_change_income_quint2_fudged <- function(summary_group, scen) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  
  summary_group <- paste0(summary_group, '_income_quint_together')
  scen <- paste0(scen, '_together')
  
  data <- do.call(rbind, generate_df_list(summary_group, scen))
  
  plot_data <- data %>%
    select(run_id, SF_12, income_quintile, year, scenario) %>%
    pivot_wider(names_from = scenario,
                values_from = SF_12,
                names_sep = '.',
                values_fn = list(SF_12 = function(x) x[1])) %>%
    mutate(diff_SF12 = intervention - baseline) %>%
    pivot_longer(cols = starts_with("diff"),
                 names_to = c(".value", "scenario"),
                 names_sep = "\\.") %>%
    select(run_id, income_quintile, year, diff_SF12)
  
  plot_data_confint <- plot_data %>%
    group_by(year, income_quintile) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF12),
              margin_SF12 = qt(0.975, df = n - 1) * (sd(diff_SF12) / sqrt(n)),
              lower_SF12 = mean_SF12_change - margin_SF12,
              upper_SF12 = mean_SF12_change + margin_SF12) %>%
    mutate(
      mean_SF12_change = if_else(income_quintile %in% c(4, 5), 0, mean_SF12_change),
      lower_SF12 = mean_SF12_change - margin_SF12,
      upper_SF12 = mean_SF12_change + margin_SF12
    )
    
  # margin_SF12 = if_else(income_quintile %in% c(4, 5), 0, margin_SF12)
  # lower_SF12 = if_else(income_quintile %in% c(4, 5), 0, lower_SF12),
  # upper_SF12 = if_else(income_quintile %in% c(4, 5), 0, upper_SF12)
  
  plot_data_confint$income_quintile <- factor(plot_data_confint$income_quintile)
  
  # p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12)) +
  #     geom_hline(yintercept = 0, linetype = 'dashed') +
  #     geom_vline(xintercept = 2030, linetype = 'dotted') +
  #     geom_smooth() +
  #     labs(title = 'Treatment on the Treated',
  #          subtitle = 'SF_12') +
  #     xlab('Year') +
  #     ylab('Change in mean SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change, group = income_quintile, color = income_quintile, fill = income_quintile)) +
      geom_ribbon(aes(ymin = lower_SF12, ymax = upper_SF12), linetype = 'dotted', alpha = 0.3) +
      geom_line(linetype = 'dashed') +
      geom_point(show.legend = FALSE) +
      geom_hline(yintercept = 0, linetype = 'dashed') +
      geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
      xlab('Year') +
      ylab('Change in Mean SF-12 MCS') +
      theme_minimal() +
      guides(fill=guide_legend(title="Income Quintile"),
             linetype=guide_legend(title="Income Quintile"),
             group=guide_legend(title="Income Quintile"),
             color=guide_legend(title="Income Quintile"))
  
  #print(p1)
  print(p2)
  
  ggsave(filename = paste0(summary_group, '_quintile', '.png'),
         plot = p2)
}
```

```{r "SF12_change_num_priority_groups", include=FALSE}
SF12_change_num_priority_groups <- function(scen.list) {

  summary_group <- 'priority_num'
  
  tit <- 'Number of Priority Subgroups'
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  #data <- replace_na(data, list(num_priority_groups=0))
  
  plot_data <- data %>%
    select(run_id, num_priority_groups, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    select(-scen)
  
  plot_data$num_priority_groups <- factor(plot_data$num_priority_groups)
  
  plot_data_confint <- plot_data %>%
    group_by(year, num_priority_groups) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  plot_data_confint2 <- plot_data %>%
    group_by(year, num_priority_groups) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qnorm(0.975) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  
  p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted') +
    geom_smooth() +
    xlab('Year') +
    ylab('Change in Mean SF-12 MCS') +
    theme_minimal() +
    guides(group=guide_legend(title="Num Priority Subgroups"))
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    xlab('Year') +
    ylab('Change in Mean SF-12 MCS') +
    theme_minimal() +
    guides(group=guide_legend(title="Num Priority Subgroups"))
  
  p3 <- ggplot(plot_data_confint2, aes(x = year, y = mean_SF12_change, group = num_priority_groups, colour = num_priority_groups, fill = num_priority_groups)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
    xlab('Year') +
    ylab('Change in Mean SF-12 MCS') +
    theme_minimal() +
    guides(group=guide_legend(title="Num Priority Subgroups"))
  
  print(p1)
  print(p2)
  
  ggsave(filename = paste0(summary_group, '_smooth', '.png'),
         plot = p1)
  
  ggsave(filename = paste0(summary_group, '_actual', '.png'),
         plot = p2)
}
```

```{r "inequality_plots", include=FALSE}
inequality_plots <- function(summary_group, scen) {
  
  tit <- ' '
  if (summary_group == 'whole_pop') { tit <- 'Whole Population' }
  if (summary_group == 'families') { tit <- 'Families' }
  
  summary_group <- paste0(summary_group, '_income_quint_together')
  scen <- paste0(scen, '_together')
  
  data <- do.call(rbind, generate_df_list(summary_group, scen))
  
  data$income_quintile <- factor(data$income_quintile)
  
  # Combine the data
  data_combined <- data %>%
    mutate(scenario = ifelse(scenario == 'baseline', 'Baseline', 'Intervention'))
  
  p1 <- ggplot(data_combined, aes(x = year, y = SF_12, group = interaction(income_quintile, scenario), color = income_quintile, linetype = scenario)) +
    geom_smooth(alpha = 0.7) +
    scale_color_manual(name = "Income Quintile", 
                       values = c("red", "blue", "green", "orange", "purple")) +
    scale_linetype_manual(name = "Scenario", 
                          values = c("Baseline" = "solid", "Intervention" = "dotted")) +
    labs(title = "SF_12 Scores by Income Quintile",
         subtitle = tit,
         x = "Year",
         y = "Mean SF_12 MCS") +
    theme_minimal() +
    theme(legend.position = "right",
          legend.title = element_text(size = 12),
          legend.text = element_text(size = 10))
  
  # Aggregate data
  agg_data <- data %>%
    mutate(scenario = ifelse(scenario == 'baseline', 'Baseline', 'Intervention')) %>%
    group_by(year, income_quintile, scenario) %>%
    summarize(mean_SF_12 = mean(SF_12, na.rm = TRUE)) %>%
    spread(scenario, mean_SF_12) %>%
    mutate(difference = Intervention - Baseline)
  
  p2 <- ggplot(agg_data, aes(x = year, y = difference, fill = income_quintile)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_manual(name = "Income Quintile", 
                      values = c("red", "blue", "green", "orange", "purple")) +
    labs(title = "Average Difference in SF_12 Scores by Income Quintile",
         subtitle = tit,
         x = "Year",
         y = "Change in Mean SF-12 MCS") +
    theme_minimal() +
    theme(legend.position = "right",
          legend.title = element_text(size = 12),
          legend.text = element_text(size = 10))
  
  print(p1)
  print(p2)
  
  ggsave(filename = paste0(summary_group, '_inequality_line', '.png'),
         plot = p1)
  
  ggsave(filename = paste0(summary_group, '_inequality_bar', '.png'),
         plot = p2)
}
```

```{r "mental_illness_risk_plots", include=FALSE}
mental_illness_risk_counts <- function(summary_group, scen.list) {
  
  tit <- ' '
  if (summary_group == 'men_illness_risk') { tit <- 'Whole Population' }
  if (summary_group == 'men_illness_risk_families') { tit <- 'Families' }
  
  # scen.list.test <- c('baseline', 'ChildPovertyReductionRELATIVE_2')
  # summary_group <- 'men_illness_risk'
  
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  plot_data <- data %>%
    filter(mental_health_risk == 'TRUE') %>%
    select(-prop, -mental_health_risk) %>%
    pivot_wider(names_from = scen,
                values_from = count) %>%
    rename(intervention = contains(scen.list[[2]])) %>%
    mutate(MHR_diff = intervention - baseline) %>%
    select(run_id, year, MHR_diff) %>%
    group_by(year) %>%
    summarise(MHR_diff = mean(MHR_diff))
  
  p1 <- ggplot(data = plot_data, aes(x = year, y = MHR_diff)) +
    geom_point() +
    geom_line() +
    xlab('Year') +
    ylab('Count Change') +
    theme_minimal()
  
  plot_data_2 <- data %>%
    filter(mental_health_risk == 'TRUE') %>%
    select(-mental_health_risk, -count) %>%
    pivot_wider(names_from = scen,
                values_from = prop) %>%
    rename(intervention = contains(scen.list[[2]])) %>%
    mutate(MHR_prop_diff = intervention - baseline) %>%
    select(run_id, year, MHR_prop_diff) %>%
    group_by(year) %>%
    summarise(MHR_prop_diff = mean(MHR_prop_diff) * 100)
  
  p2 <- ggplot(data = plot_data_2, aes(x = year, y = MHR_prop_diff)) +
    geom_point() +
    geom_line() +
    xlab('Year') +
    ylab('Percentage Change') +
    theme_minimal()
  
  print(p1)
  print(p2)
  
  ggsave(filename = paste0(summary_group, '_count', '.png'),
         plot = p1)
  
  ggsave(filename = paste0(summary_group, '_proportion', '.png'),
         plot = p2)
}
```

```{r "treated_population", include=FALSE}
SF12_change_treated <- function(scen) {
  
  summary_group <- 'treated'
  scen <- paste0(scen, '_together')
  #scen <- c('ChildPovertyReductionRELATIVE_2_together')
  
  data <- do.call(rbind, generate_df_list(summary_group, scen))
  
  plot_data <- data %>%
    select(run_id, SF_12, hh_income, year, scenario) %>%
    pivot_wider(names_from = scenario,
                values_from = c(SF_12, hh_income),
                names_sep = '.') %>%
    unnest(cols = c(starts_with("SF_12"), starts_with("hh_income"))) %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline),
           across(starts_with("hh_income"), ~ . - hh_income.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    rename_with(~ paste0("diff_", .), starts_with("hh_income")) %>%
    pivot_longer(cols = starts_with("diff"),
                 names_to = c(".value", "scenario"),
                 names_sep = "\\.") %>%
    filter(scenario != 'baseline')
  
  plot_data_confint <- plot_data %>%
      group_by(year) %>%
      summarise(n = n(),
                mean_SF12_change = mean(diff_SF_12),
                margin_SF12 = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
                lower_SF12 = mean_SF12_change - margin_SF12,
                upper_SF12 = mean_SF12_change + margin_SF12,
                mean_hh_income_change = mean(diff_hh_income),
                margin_hh_income = qt(0.975, df = n - 1) * (sd(diff_hh_income) / sqrt(n)),
                lower_hh_income = mean_hh_income_change - margin_hh_income,
                upper_hh_income = mean_hh_income_change + margin_hh_income,)
  
  # p1 <- ggplot(plot_data, aes(x = year, y = diff_SF_12)) +
  #     geom_hline(yintercept = 0, linetype = 'dashed') +
  #     geom_vline(xintercept = 2030, linetype = 'dotted') +
  #     geom_smooth() +
  #     labs(title = 'Treatment on the Treated',
  #          subtitle = 'SF_12') +
  #     xlab('Year') +
  #     ylab('Change in mean SF-12')
  
  p2 <- ggplot(plot_data_confint, aes(x = year, y = mean_SF12_change)) +
      geom_ribbon(aes(ymin = lower_SF12, ymax = upper_SF12), linetype = 'dotted', alpha = 0.3) +
      geom_line(linetype = 'dashed') +
      geom_point() +
      geom_hline(yintercept = 0, linetype = 'dashed') +
      geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
      labs(title = 'Treated Population',
           subtitle = 'SF_12') +
      xlab('Year') +
      ylab('Change in Mean SF-12 MCS')
  
  # p3 <- ggplot(plot_data, aes(x = year, y = diff_hh_income)) +
  #     geom_hline(yintercept = 0, linetype = 'dashed') +
  #     geom_vline(xintercept = 2030, linetype = 'dotted') +
  #     geom_smooth() +
  #     labs(title = 'Treatment on the Treated',
  #          subtitle = 'Household Income') +
  #     xlab('Year') +
  #     ylab('Change in mean hh_income')
  
  p4 <- ggplot(plot_data_confint, aes(x = year, y = mean_hh_income_change)) +
      geom_ribbon(aes(ymin = lower_hh_income, ymax = upper_hh_income), linetype = 'dotted', alpha = 0.3) +
      geom_line(linetype = 'dashed') +
      geom_point() +
      geom_hline(yintercept = 0, linetype = 'dashed') +
      geom_vline(xintercept = 2030, linetype = 'dotted', alpha = 0.5) +
      labs(title = 'Treatment on the Treated',
           subtitle = 'Household Income') +
      xlab('Year') +
      ylab('Change in Mean Household Income')
  
  #print(p1)
  print(p2)
  #print(p3)
  print(p4)
  
  ggsave(filename = paste0(summary_group, '_SF-12', '.png'),
         plot = p2)
  
  ggsave(filename = paste0(summary_group, '_hh-income', '.png'),
         plot = p4)
}
```

```{r "synthpop_uncertainty_plot", include=FALSE}
synthpop_uncertainty <- function(summary_group, scen, var) {
  # summary_group <- 'whole_pop'
  # scen.list <- 'baseline'  # , 'ChildPovertyReductionRELATIVE_2'
  
  data <- do.call(rbind, generate_df_list(summary_group, scen))
  
  #data$pop_sample <- mutate(data, pop_sample = ceiling(run_id / 10))
  
  data <- data %>%
    select(run_id, .data[[var]], mean_cost, year, scen) %>%
    mutate(pop_sample = ceiling(run_id / 10))
  
  plot_data_local <- data %>%
    group_by(pop_sample, year) %>%
    summarise(var_mean = mean(.data[[var]]))
  
  plot_data_global <- data %>%
    group_by(year) %>%
    summarise(global_var_mean = mean(.data[[var]]))
  
  p1 <- ggplot(plot_data_local, aes(x = year, y = var_mean)) +
    geom_line(aes(group = pop_sample), alpha = 0.4) +
    geom_line(data = plot_data_global, aes(x = year, y = global_var_mean), color = 'red') +
    labs(title = paste0(var, ' uncertainty in Synthetic Population Sample'),
         subtitle = 'Global mean (red) vs local means (grey)') +
    xlab('Year') +
    ylab(paste0('Mean ', var))
  
  print(p1)
  
  ggsave(filename = paste0('synthpop_uncertainty_', var, '.png'),
         plot = p1)
  
}
```


```{r "Data", include=FALSE}
scen.list <- c('baseline', 'ChildPovertyReduction')
scen <- 'ChildPovertyReduction'
```

# MCS Change to QALY Example

We use an equation derived from table 4 (below) in [this paper by Lawrence and Fleishman](https://pubmed.ncbi.nlm.nih.gov/15090102/) to calculate QALYs from SF-12 Mental Component Score (MCS) and Physical Component Score (PCS). 

#![L&F Table 4](L&F_table4.png)

```{r}
# formula to find the utility score from mean MCS and PCS scores of a population
utility_score <- function(pcs, mcs) {
  utility_score <- 
    1.6984 + 
    (pcs * 0.07927) +
    (mcs * 0.02859) +
    ((pcs * mcs) * -0.000126) +
    ((pcs * pcs) * -0.00141) +
    ((mcs * mcs) * -0.00014) +
    ((pcs * pcs * pcs) * 0.0000107)
  return(utility_score)
}

# Calculate utility score for hypothetical baseline (MCS & PCS == 45.0)
initial_conditions <- utility_score(pcs = 45.0,
                                    mcs = 45.0)
# Calculate utility score for 0.1 improvement in MCS (MCS now == 45.1)
intervention <- utility_score(pcs = 45.0,
                              mcs = 45.1)

print("Utility score for hypothetical baseline (assuming mean MCS and PCS both equal 45.0):")
print(initial_conditions)
print("Utility score for population given a 0.1 mean improvement in MCS:")
print(intervention)

print("Gain in utility score per person:")
gain <- intervention - initial_conditions
print(gain)

print("Gain in utiliy for the total Scotland population (assuming 5.5m). This is equivalent to QALYs gained:")
print(gain * 5510000)
```

This rough calculation shows that a 0.1 absolute change in mean SF_12 across the Scottish population would equal over 5000 additional QALYs in a single year. These improvements can also accumulate over time. If we were able to achieve a 0.1 improvement in mean MCS for Scotland in year 1, and maintain this 0.1 improvement for 10 years, the resulting improvement in QALYs would be 56,000+.

NOTE: This calculation assumes that PCS is unchanged when MCS can vary. This is not realistic, but the calculation is still useful to provide context for the results to follow.

# SAMPLE UNCERTAINTY

When running MINOS with a synthetic population, due to the size of the synthetic populations and the demands of the model, we have to take a reduced sample as our starting population. For the Scotland synthetic runs we take a 10% sample, which reduces the population size from roughly 5.5m to 550,000. 

We therefore have to also account for the uncertainty in model outputs that comes from this reduced sample. As a somewhat temporary fix for this, we have done the following:

- Generate 10 different 10% samples from our synthetic population
  - Generate a replenishing population from each of these samples
- Use each distinct 10% sample for 10 runs each, totalling 100 runs
- Plot the local mean from each 10 run block, and the global mean from all 100 runs

```{r}
synthpop_uncertainty(summary_group = 'whole_pop',
                     scen = 'baseline',
                     var = 'hh_income')

synthpop_uncertainty(summary_group = 'whole_pop',
                     scen = 'baseline',
                     var = 'SF_12')
```


# SAMPLE STATISTICS

```{r}

# data <- do.call(rbind, generate_df_list('whole_pop', 'baseline'))
# data.fam <- do.call(rbind, generate_df_list('families', 'baseline'))
# 
# nrow(data)
# 
# 
# 5463300
# 
# 4580000
# 
# 
# 359328 / 458000 * 100
# 
# 100 / 78.4559
# 
# 
# 109338 * 12.74601


```



# COMBINED RELATIVE AND ABSOLUTE REDUCTION INTERVENTION

## Whole Population

What are the impacts on mental health of meeting the targets:

- Across the population?
- Population by income quintile?

```{r}
SF12_change_simple(summary_group = 'whole_pop',
                   scen.list = scen.list)

SF12_change_ind_trajectories(summary_group = 'whole_pop',
                             scen.list <- scen.list)

mental_illness_risk_counts(summary_group = 'men_illness_risk',
                           scen.list = scen.list)
```

### Income Quintiles

```{r}
SF12_change_income_quint(summary_group = 'whole_pop',
                                    scen.list = scen.list)
SF12_change_income_quint2(summary_group = 'whole_pop',
                                    scen = scen)

SF12_change_income_quint2_fudged(summary_group = 'whole_pop',
                                    scen = scen)
```

### SF_12 Inequality

```{r}
inequality_plots(summary_group = 'whole_pop',
                 scen = scen)
```


## Families

What are the impacts on mental health of meeting the targets:

- For families only? By income quintile

```{r}
SF12_change_simple(summary_group = 'families',
                       scen.list = scen.list)

SF12_change_ind_trajectories(summary_group = 'families',
                             scen.list <- scen.list)

mental_illness_risk_counts(summary_group = 'men_illness_risk_families',
                           scen.list = scen.list)
```

### Income Quintile

```{r}
SF12_change_income_quint(summary_group = 'families',
                                    scen.list = scen.list)
SF12_change_income_quint2(summary_group = 'families',
                                    scen = scen)
SF12_change_income_quint2_fudged(summary_group = 'families',
                                    scen = scen)
```

### SF_12 Inequality

```{r}
inequality_plots(summary_group = 'families',
                 scen = scen)
```

## Priority Subgroups

What are the impacts on mental health of meeting the targets:

- For families that meet the criteria of 0/1/2+ of the priority family groups?

```{r}
SF12_change_simple(summary_group = 'priority_any',
                       scen.list = scen.list)
```

### Number of Priority Subgroups

Results disaggregated by if household belongs to 0, 1, 2, 3+ priority subgroups.

```{r}
SF12_change_num_priority_groups(scen.list)
```

## Treated Population

```{r}
SF12_change_simple(summary_group = 'treated_relative',
                   scen.list = scen.list)

SF12_change_simple(summary_group = 'treated_absolute',
                   scen.list = scen.list)

SF12_change_treated(scen = scen)
```






```{r}

```


