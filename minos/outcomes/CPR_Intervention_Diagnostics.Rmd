---
title: "Diagnosing Child Poverty Reduction Interventions"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
---

# SETUP

This document presents results from a host of interventions on child poverty, including visualisations of the change in SF_12_MCS compared with baseline.

```{r "setup", include=FALSE}

library(tidyverse)
library(ggplot2)
library(ggridges) # for densities over time plots. 
library(knitr)
library(here)
library(gghighlight)
library(spatstat)

#workingDir <- "/home/luke/Documents/MINOS/Minos/"
workingDir <- normalizePath('../')
knitr::opts_knit$set(root.dir = workingDir)
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
rm(workingDir)
```

```{r "imports", include=FALSE}
source(here::here('minos', 'utils_datain.R'))
#source(here::here('minos', 'utils_validation_vis.R'))
source(here::here('minos', 'validation', 'utils.r'))
```

```{r, include=FALSE}
out.path <- here::here('output', 'default_config/')
#out.path <- here::here('output', 'scotland_scaled/')
base.dat <- read_singular_local_out(out.path, 
                                    'baseline', 
                                    drop.dead = TRUE, 
                                    drop.zero.weight = TRUE)
int.dat <- read_singular_local_out(out.path,
                               'ChildPovertyReduction',
                               drop.dead = TRUE,
                               drop.zero.weight = TRUE)
# rel.int <- read_singular_local_out(out.path,
#                                      'ChildPovertyReductionRELATIVE_2',
#                                      drop.dead = TRUE,
#                                      drop.zero.weight = TRUE)
# abs.int <- read_singular_local_out(out.path,
#                                    'ChildPovertyReductionABSOLUTE',
#                                    drop.dead = TRUE,
#                                    drop.zero.weight = TRUE)
```

# Household Income

i.e. is the intervention working?

## All Pop

```{r}
base.inc <- base.dat %>%
  select(pidp, hidp, time, hh_income, weight) %>%
  group_by(time) %>%
  summarise(hh_income = weighted.mean(x = hh_income,w = weight, na.rm = TRUE)) %>%
  mutate(scen = 'Baseline')

int.inc <- int.dat %>%
  select(pidp, hidp, time, hh_income, weight) %>%
  group_by(time) %>%
  summarise(hh_income = weighted.mean(x = hh_income,w = weight, na.rm = TRUE)) %>%
  mutate(scen = 'Intervention')

inc <- rbind(base.inc, int.inc)

ggplot(inc, aes(x = time, y = hh_income, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point() +
  labs(title = 'Whole Population')

ggplot(base.dat, aes(x = hh_income, y = time, group = time)) +
  geom_density_ridges(color = 'blue', alpha = 0.3) +
  geom_density_ridges(data = int.dat, aes(color = 'red', alpha = 0.3)) +
  theme(legend.position = 'none') +
  labs(title = 'Relative Poverty Reduction Intervention - Red')
```

## Households With Children

```{r}
base.inc <- base.dat %>%
  select(pidp, hidp, time, hh_income, age, nkids, weight) %>%
  mutate(nkids_any = (nkids > 0)) %>%
  filter(nkids_any == TRUE) %>%
  group_by(time) %>%
  summarise(hh_income = weighted.mean(x = hh_income, w = weight, na.rm = TRUE)) %>%
  mutate(scen = 'Baseline')

int.inc <- int.dat %>%
  select(pidp, hidp, time, hh_income, age, nkids, weight) %>%
  mutate(nkids_any = (nkids > 0)) %>%
  filter(nkids_any = TRUE) %>%
  group_by(time) %>%
  summarise(hh_income = weighted.mean(x = hh_income, w = weight, na.rm = TRUE)) %>%
  mutate(scen = 'Intervention')

inc <- rbind(base.inc, int.inc)

ggplot(inc, aes(x = time, y = hh_income, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point() +
  labs(title = 'Households with Children')
```

## Boosted Pop

```{r}
boosted.pidps <- int.dat %>%
  filter(income_boosted == 'True') %>%
  select(pidp, time)

#base.inc <- merge(base.dat, boosted.pidps, by = c('pidp', 'time'))
#int.inc <- merge(int.dat, boosted.pidps, by = c('pidp', 'time'))

base.inc <- base.dat %>%
  select(pidp, hidp, time, hh_income, SF_12, weight) %>%
  inner_join(boosted.pidps, by = c("pidp", "time")) %>%
  group_by(time) %>%
  summarise(hh_income = weighted.mean(x = hh_income, w = weight, na.rm = TRUE),
            SF_12 = weighted.mean(x = SF_12, w = weight, na.rm = TRUE)) %>%
  mutate(scen = 'Baseline')

int.inc <- int.dat %>%
  select(pidp, hidp, time, hh_income, SF_12, weight) %>%
  inner_join(boosted.pidps, by = c("pidp", "time")) %>%
  group_by(time) %>%
  summarise(hh_income = weighted.mean(x = hh_income, w = weight, na.rm = TRUE),
            SF_12 = weighted.mean(x = SF_12, w = weight, na.rm = TRUE)) %>%
  mutate(scen = 'Intervention')

inc <- rbind(base.inc, int.inc)

ggplot(inc, aes(x = time, y = hh_income, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point()

ggplot(inc, aes(x = time, y = SF_12, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point()
```


```{r}
colnames(base.dat)
```


# Income by Quintile

Firstly, can't rely on the income_quintile variable as this is a variable created in start year which does not transition. Therefore we will need to calculate an income quintile variable for both dataframes.

## Density Ridges

```{r}
base.dat <- base.dat %>%
  group_by(time) %>%
  mutate(income_quint = ntile(hh_income, 5))

int.dat <- int.dat %>%
  group_by(time) %>%
  mutate(income_quint = ntile(hh_income, 5))
```


```{r}

density_plot <- function(base, int) {
  p <- ggplot(base, aes(x = hh_income, y = time, group = time)) +
    geom_density_ridges(color = 'blue', alpha = 0.3) +
    geom_density_ridges(data = int, aes(color = 'red', alpha = 0.3)) +
    theme(legend.position = 'none') +
    labs(title = 'Household Income Density Plots')
  
  return(p)
}

p <- density_plot(base.dat, int.dat)

p <- p + facet_wrap(~ income_quint, ncol=1)

print(p)

# ggplot(base.dat, aes(x = hh_income, y = time, group = time)) +
#   geom_density_ridges(color = 'blue', alpha = 0.3) +
#   geom_density_ridges(data = int.dat, aes(color = 'red', alpha = 0.3)) +
#   theme(legend.position = 'none') +
#   labs(title = 'Household Income Density Plots') +
#   facet_wrap(~ income_quint, ncol=1)
```

```{r}
density_plot_quintile <- function(base, int, quintile) {
  
  base <- base %>%
    filter(income_quint == quintile) %>%
    select(pidp, time, hh_income) %>%
    rename(Baseline = hh_income)
  int <- int %>%
    filter(income_quint == quintile) %>%
    select(pidp, time, hh_income) %>%
    rename(Intervention = hh_income)
  
  combined <- merge(base, int, by = c('pidp', 'time'))
  combined <- combined %>%
    pivot_longer(cols = Baseline:Intervention,
                 names_to = 'Source',
                 values_to = 'hh_income')
  
  p <- ggplot(combined, aes(x = hh_income, y = time, group = interaction(time, Source), color = Source, fill = Source)) +
    geom_density_ridges(alpha = 0.3) +
    labs(title = 'Household Income Density Plots',
         subtitle = paste0('Quintile ', quintile))
  
  return(p)
}

density_plot_quintile(base.dat, int.dat, quintile = 1)
density_plot_quintile(base.dat, int.dat, quintile = 2)
density_plot_quintile(base.dat, int.dat, quintile = 3)
density_plot_quintile(base.dat, int.dat, quintile = 4)
density_plot_quintile(base.dat, int.dat, quintile = 5)
```
```{r}
density_plot_quintile_2 <- function(base, int, quintile) {
  base <- base %>%
    filter(income_quint == quintile) %>%
    select(pidp, time, hh_income) %>%
    rename(Baseline = hh_income)
  int <- int %>%
    select(pidp, time, hh_income) %>%
    rename(Intervention = hh_income)
  
  combined <- merge(base, int, by = c('pidp', 'time'))
  combined <- combined %>%
    pivot_longer(cols = Baseline:Intervention,
                 names_to = 'Source',
                 values_to = 'hh_income')
  
  # Calculate the 1st and 99th percentiles
  lower_cutoff <- quantile(combined$hh_income, 0.01)
  upper_cutoff <- quantile(combined$hh_income, 0.99)
  
  #filtered_combined <- combined %>%
  #  filter(hh_income > lower_cutoff, hh_income < upper_cutoff)
  
  p <- ggplot(combined, aes(x = hh_income, y = time, group = interaction(time, Source), color = Source, fill = Source)) +
    geom_density_ridges(alpha = 0.3) +
    labs(title = 'Household Income Density Plots',
         subtitle = paste0('Quintile ', quintile))
  return(p)
}

density_plot_quintile_2(base.dat, int.dat, quintile = 1)
density_plot_quintile_2(base.dat, int.dat, quintile = 2)
density_plot_quintile_2(base.dat, int.dat, quintile = 3)
density_plot_quintile_2(base.dat, int.dat, quintile = 4)
density_plot_quintile_2(base.dat, int.dat, quintile = 5)
```


## Mean Income

```{r}
mean_income_quintile <- function(base, int) {
  base <- base %>%
    select(pidp, time, hh_income, income_quint, weight) %>%
    mutate(source = 'Baseline')
  int <- int %>%
    select(pidp, time, hh_income, income_quint, weight) %>%
    mutate(source = 'Intervention')
  
  combined <- rbind(base, int)
  
  combined <- combined %>%
    group_by(time, income_quint, source) %>%
    summarise(mean = weighted.mean(hh_income, weight),
              median = weighted.median(hh_income, weight))
  
  combined$income_quint <- factor(combined$income_quint)
  combined$source <- factor(combined$source)

  
  p1 <- ggplot(combined, aes(x = time, y = mean, group = interaction(income_quint, source), color = income_quint, linetype = source, fill = income_quint)) +
    geom_line() +
    labs(title = 'Mean hh_income by quintile',
         subtitle = 'Baseline vs Intervention')
  
  p2 <- ggplot(combined, aes(x = time, y = median, group = interaction(income_quint, source), color = income_quint, linetype = source, fill = income_quint)) +
    geom_line() +
    labs(title = 'Median hh_income by quintile',
         subtitle = 'Baseline vs Intervention')
  
  print(p1)
  print(p2)
  #return(p)
}

mean_income_quintile(base.dat, int.dat)
```

```{r}
mean_income_quintile_2 <- function(base, int) {
  
  base <- base.dat %>%
    select(pidp, time, hh_income, income_quint, weight) %>%
    mutate(source = 'Baseline')
  
  # start processing to use baseline income_quint var on intervention
  base.tmp <- base %>% 
    select(-weight, -hh_income, -source)
  
  int <- int.dat %>%
    select(pidp, time, hh_income, weight)
  
  merged.int <- merge(int, base.tmp, by = c('pidp', 'time'))
  
  int <- merged.int %>%
    mutate(source = 'Intervention')
  
  
  combined <- rbind(base, int)
  
  combined <- combined %>%
    group_by(time, income_quint, source) %>%
    summarise(mean = weighted.mean(hh_income, weight),
              median = weighted.median(hh_income, weight))
  
  combined$income_quint <- factor(combined$income_quint)
  combined$source <- factor(combined$source)

  
  p1 <- ggplot(combined, aes(x = time, y = mean, group = interaction(income_quint, source), color = income_quint, linetype = source, fill = income_quint)) +
    geom_line() +
    labs(title = 'Mean hh_income by quintile',
         subtitle = 'Baseline vs Intervention')
  
  p2 <- ggplot(combined, aes(x = time, y = median, group = interaction(income_quint, source), color = income_quint, linetype = source, fill = income_quint)) +
    geom_line() +
    labs(title = 'Median hh_income by quintile',
         subtitle = 'Baseline vs Intervention')
  
  print(p1)
  print(p2)
  #return(p)
}

mean_income_quintile_2(base.dat, int.dat)
```


# TESTING THE BOOSTED POP


```{r}
boosted.pidps <- int.dat %>%
  filter(income_boosted == 'True') %>%
  select(pidp, time)

# Define the recoding mapping for housing_quality
recoding_mapping <- c("Low" = 1, "Medium" = 2, "High" = 3)  # Adjust as needed

base.inc <- base.dat %>%
  select(pidp, hidp, time, age, hh_income, SF_12, housing_quality, neighbourhood_safety, ncigs, nutrition_quality, loneliness, nkids, weight) %>%
  inner_join(boosted.pidps, by = c("pidp", "time")) %>%
  mutate_at(vars(housing_quality), ~recode(., !!!recoding_mapping)) %>%
  group_by(time) %>%
  summarise(boosted_pop = n(),
            age = mean(age, na.rm = TRUE),
            hh_income = weighted.mean(x = hh_income, w = weight, na.rm = TRUE),
            SF_12 = weighted.mean(x = SF_12, w = weight, na.rm = TRUE),
            housing_quality = weighted.mean(x = housing_quality, w = weight, na.rm = TRUE),
            neighbourhood_safety = weighted.mean(x = neighbourhood_safety, w = weight, na.rm = TRUE),
            ncigs = weighted.mean(x = ncigs, w = weight, na.rm = TRUE),
            nutrition_quality = weighted.mean(x = nutrition_quality, w = weight, na.rm = TRUE),
            loneliness = weighted.mean(x = loneliness, w = weight, na.rm = TRUE)) %>%
  mutate(scen = 'Baseline')


int.inc <- int.dat %>%
  select(pidp, hidp, time, age, hh_income, SF_12, housing_quality, neighbourhood_safety, ncigs, nutrition_quality, loneliness, nkids, weight) %>%
  inner_join(boosted.pidps, by = c("pidp", "time")) %>%
  mutate_at(vars(housing_quality), ~recode(., !!!recoding_mapping)) %>%
  group_by(time) %>%
  summarise(boosted_pop = n(),
            age = mean(age, na.rm = TRUE),
            hh_income = weighted.mean(x = hh_income, w = weight, na.rm = TRUE),
            SF_12 = weighted.mean(x = SF_12, w = weight, na.rm = TRUE),
            housing_quality = weighted.mean(x = housing_quality, w = weight, na.rm = TRUE),
            neighbourhood_safety = weighted.mean(x = neighbourhood_safety, w = weight, na.rm = TRUE),
            ncigs = weighted.mean(x = ncigs, w = weight, na.rm = TRUE),
            nutrition_quality = weighted.mean(x = nutrition_quality, w = weight, na.rm = TRUE),
            loneliness = weighted.mean(x = loneliness, w = weight, na.rm = TRUE)) %>%
  mutate(scen = 'Intervention')

base.treated <- base.dat %>%
  select(pidp, time, hh_income, SF_12, nutrition_quality, ncigs) %>%
  inner_join(boosted.pidps, by = c("pidp", "time")) %>%
  mutate(scen = 'Baseline')

int.treated <- int.dat %>%
  select(pidp, time, hh_income, SF_12, nutrition_quality, ncigs) %>%
  inner_join(boosted.pidps, by = c("pidp", "time")) %>%
  mutate(scen = 'Intervention')

inc <- rbind(base.inc, int.inc)
treated <- rbind(base.treated, int.treated)
```

```{r}
ggplot(inc, aes(x = time, y = boosted_pop, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point()

ggplot(inc, aes(x = time, y = age, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point()

ggplot(inc, aes(x = time, y = hh_income, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point()

ggplot(base.treated, aes(x = hh_income, y = time, group = time, alpha = 0.3), color = 'blue') +
  geom_density_ridges() +
  geom_density_ridges(data = int.treated, aes(x = hh_income, y = time, group = time), color = 'red') +
  theme(legend.position = 'none') +
  labs(title = 'Relative Poverty Reduction Intervention - Red')

ggplot(inc, aes(x = time, y = SF_12, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point()

ggplot(inc, aes(x = time, y = housing_quality, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point()

ggplot(inc, aes(x = time, y = neighbourhood_safety, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point()

ggplot(inc, aes(x = time, y = ncigs, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point()

ggplot(inc, aes(x = time, y = nutrition_quality, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point()

ggplot(inc, aes(x = time, y = loneliness, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_point()

```


```{r}
library(xgboost)
sf12 <- readRDS('/home/luke/Documents/WORK/MINOS/Minos/data/transitions/SF_12/xgb/SF_12_XGB.rds')


sf12$params
importance_matrix <- xgb.importance(model = sf12)
print(importance_matrix)

xgb.plot.importance(importance_matrix)
```



```{r}
ggplot(treated, aes(x = time, y = hh_income, group = interaction(time, scen), fill = scen)) +
  geom_boxplot()

ggplot(treated, aes(x = time, y = SF_12, group = interaction(time, scen), fill = scen)) +
  geom_boxplot()

ggplot(treated, aes(x = time, y = nutrition_quality, group = interaction(time, scen), fill = scen)) +
  geom_boxplot()

ggplot(treated, aes(x = time, y = ncigs, group = interaction(time, scen), fill = scen)) +
  geom_boxplot()
```

```{r}
base.housing <- base.dat %>%
  dplyr::select(pidp, time, housing_quality) %>%
  group_by(time, housing_quality) %>%
  count() %>%
  mutate(scen = 'Baseline')

int.housing <- int.dat %>%
  dplyr::select(pidp, time, housing_quality) %>%
  group_by(time, housing_quality) %>%
  count() %>%
  mutate(scen = 'Intervention')

housing <- rbind(base.housing, int.housing)
housing$housing_quality <- as.factor(housing$housing_quality)

housing.norm <- housing %>%
  group_by(time, scen) %>%
  mutate(total = sum(n)) %>%
  mutate(prct = (n / total))

# Plot the data
ggplot(data = housing.norm, mapping = aes(x = factor(time), y = prct, fill = housing_quality)) +
  geom_bar(stat = 'identity', position = 'stack') +
  facet_wrap(~ scen, nrow = 2) +
  labs(title = 'Housing Quality Over Time', x = 'Year', y = 'Proportion') +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data = housing.norm, mapping = aes(x = factor(time), y = prct, fill = housing_quality)) +
  geom_bar(stat = 'identity', position = position_dodge(width = 0.9)) +
  facet_wrap(~ scen, nrow = 2) +
  labs(title = 'Housing Quality Over Time', x = 'Year', y = 'Proportion') +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```


```{r}
# Plot the data
ggplot(data = housing.norm, mapping = aes(x = factor(time), y = prct, fill = housing_quality)) +
  geom_bar(stat = 'identity', position = position_dodge(width = 0.8), aes(group = scen)) +
  labs(title = 'Housing Quality Over Time', x = 'Year', y = 'Proportion') +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~ scen, scales = "free_y", ncol = 2)

ggplot(data = housing.norm, mapping = aes(x = interaction(time, scen), y = prct, fill = housing_quality)) +
  geom_bar(stat = 'identity', position = 'stack') +
  labs(title = 'Housing Quality Over Time', x = 'Year and Scenario', y = 'Proportion') +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
# Create a combined variable for interspersed plotting
housing.norm2 <- housing.norm %>%
  mutate(year_scen = interaction(time, scen, sep = " - "))

# Plot the data
ggplot(data = housing.norm2, mapping = aes(x = year_scen, y = prct, fill = housing_quality)) +
  geom_bar(stat = 'identity', position = 'stack') +
  labs(title = 'Housing Quality Over Time', x = 'Year and Scenario', y = 'Proportion') +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}
# Prepare data for line plot
housing.norm3 <- housing %>%
  group_by(time, scen, housing_quality) %>%
  summarize(prct = sum(n) / sum(housing$n)) %>%
  ungroup()

# Line plot with faceting by scenario
ggplot(data = housing.norm3, mapping = aes(x = time, y = prct, color = housing_quality, group = housing_quality)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  facet_wrap(~ scen) +
  labs(title = 'Housing Quality Over Time by Scenario', x = 'Year', y = 'Proportion') +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r}
# Generate proportions
housing.norm5 <- housing %>%
  group_by(time, scen) %>%
  mutate(total = sum(n)) %>%
  mutate(prct = (n / total)) %>%
  ungroup()

# Create a combined variable for interspersed plotting
housing.norm5 <- housing.norm5 %>%
  mutate(year_scen = interaction(time, scen, sep = " - "))

# Plot the data with different color schemes
ggplot(data = housing.norm5, mapping = aes(x = factor(time), y = prct, fill = housing_quality, group = scen)) +
  geom_bar(stat = 'identity', position = position_dodge(width = 0.9)) +
  facet_wrap(~ scen, ncol = 1) +
  labs(title = 'Housing Quality Over Time', x = 'Year', y = 'Proportion') +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```








# BOTTOM

```{r}

```








