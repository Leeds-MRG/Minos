---
title: "MHF SCP Experiment Visualisations"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
---








```{r "setup", include=FALSE}

library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(stringr)
library(grid)

workingDir <- "/home/luke/Documents/WORK/MINOS/SCP_ARC_SUMMARIES/"
knitr::opts_knit$set(root.dir = workingDir)
rm(workingDir)
```



```{r "data", include=FALSE}
# whole pop to start
# base.whole <- read.csv(file = sprintf('%s/combined_summary_whole_pop.csv', 'baseline'))
# base.UC <- read.csv(file = sprintf('%s/combined_summary_UC.csv', 'baseline'))
```

```{r}
scen.colour.list <- c('baseline', '£10', '£20',
               '£25', '£30',
               '£35', '£40', '£45',
               '£50', '£60', '£70',
               '£80', '£90', '£100') #, '£110', '£120', '£130')

#colours <- display.brewer.all(length(scen.list.full))
#colours <- colorRampPalette( brewer.pal(11,"Spectral") )(14)
colours <- colorRampPalette( brewer.pal(9,"Set1") )(14)
my_palette <- set_names(colours, scen.colour.list)

scen.list.full <- c('baseline', '10UniversalCredit', '20UniversalCredit',
               '25UniversalCredit', '30UniversalCredit',
               '35UniversalCredit', '40UniversalCredit', '45UniversalCredit',
               '50UniversalCredit', '60UniversalCredit', '70UniversalCredit',
               '80UniversalCredit', '90UniversalCredit', '100UniversalCredit')#,
               #'110UniversalCredit', '120UniversalCredit', '130UniversalCredit')

scen.list.50l <- c('baseline', '10UniversalCredit',
               '20UniversalCredit', '25UniversalCredit', '30UniversalCredit',
               '35UniversalCredit', '40UniversalCredit', '45UniversalCredit',
               '50UniversalCredit')

scen.list.10_50 <- c('baseline', '10UniversalCredit',
               '20UniversalCredit', '30UniversalCredit',
               '40UniversalCredit', '50UniversalCredit')

scen.list.60_100 <- c('baseline', '60UniversalCredit', '70UniversalCredit',
               '80UniversalCredit', '90UniversalCredit', '100UniversalCredit')

scen.list.25_50 <- c('baseline', '25UniversalCredit', '30UniversalCredit',
                    '35UniversalCredit', '40UniversalCredit', '45UniversalCredit',
                    '50UniversalCredit')

scen.list.10_100 <- c('baseline', '10UniversalCredit', '20UniversalCredit',
                      '30UniversalCredit', '40UniversalCredit', '50UniversalCredit', 
                      '60UniversalCredit', '70UniversalCredit', '80UniversalCredit', 
                      '90UniversalCredit', '100UniversalCredit')

# scen.list.10_130 <- c('baseline', '10UniversalCredit', '20UniversalCredit',
#                       '30UniversalCredit', '40UniversalCredit', '50UniversalCredit', 
#                       '60UniversalCredit', '70UniversalCredit', '80UniversalCredit', 
#                       '90UniversalCredit', '100UniversalCredit',
#                       '110UniversalCredit', '120UniversalCredit', '130UniversalCredit')

scen.list.20_100 <- c('baseline', '20UniversalCredit', '40UniversalCredit',
                      '60UniversalCredit', '80UniversalCredit', '100UniversalCredit')

scen.list.25_100 <- c('baseline', '25UniversalCredit', '50UniversalCredit',
                      '70UniversalCredit', '100UniversalCredit')
```

# Functions

```{r "datain", include=FALSE}
generate_df_list <- function(summary, scen.list) {
  df.list <- lapply(scen.list, function(scen) {
    df <- read.csv(file = sprintf('%s/combined_summary_%s.csv', scen, summary))
    df$scen <- scen
    return(df)
  })
  return(df.list)
}

```



```{r "cost_ratio_functions", include=FALSE}

SF_12_cost_ratio <- function(summary_type, scen_list, palette = my_palette) {
  
  data <- do.call(rbind, generate_df_list(summary_type, scen_list))
  
  data <- data %>%
    mutate_at("scen", str_replace, "UniversalCredit", "") %>%
    mutate(scen = if_else(scen == "baseline", scen, paste0("£", scen)))
  
  if (summary_type == "UC") {
    data <- data %>%
      filter(universal_credit == 1)
  }
  
  plot_data1 <- data %>%
    select(run_id, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"), 
                 names_to = c(".value", "scen"), 
                 names_sep = "\\.") %>%
    filter(scen != 'baseline')
  
  # Extract numeric part from 'scen' column then...
  scen_numeric <- as.numeric(gsub("[^0-9]", "", plot_data1$scen))
  # ...Reorder 'scen' column based on numeric values for plotting
  plot_data1$scen <- factor(plot_data1$scen, levels = unique(plot_data1$scen[order(scen_numeric)]))
  
  plot_data1_confint <- plot_data1 %>%
    group_by(year, scen) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  plot_data2 <- plot_data1 %>%
    mutate(SF12_to_cost_ratio = diff_SF_12 / mean_cost) %>%
    replace_na(list(SF12_to_cost_ratio = 0))
  
  plot_data2_confint <- plot_data2 %>%
    group_by(year, scen) %>%
    summarise(n = n(),
              mean_SF12_to_cost_ratio = mean(SF12_to_cost_ratio),
              margin = qt(0.975, df = n - 1) * (sd(SF12_to_cost_ratio) / sqrt(n)),
              lower = mean_SF12_to_cost_ratio - margin,
              upper = mean_SF12_to_cost_ratio + margin)
  
  # p1 <- ggplot(plot_data1, aes(x = year, y = diff_SF_12, group = scen, colour = scen, fill = scen)) +
  #   geom_smooth()
  p1 <- ggplot(plot_data1_confint, aes(x = year, y = mean_SF12_change, group = scen)) +
    geom_ribbon(aes(ymin = lower, ymax = upper, color = scen, fill = scen), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = scen), linetype = 'dashed') +
    geom_point(aes(color = scen)) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    xlab('Year') +
    ylab('Mean SF-12 Change') +
    theme(
        legend.title = element_blank(),  # Remove the legend title
        legend.position = c(0.2, 0.7),  # Position the legend inside the plot
        legend.text = element_text(size = 8),  # Increase the text size for better readability
        legend.key.size = unit(0.8, 'cm'),  # Reduce the key size to fit more entries
        legend.spacing.y = unit(0.1, 'cm')  # Add vertical space between legend items
    ) +
    guides(
        color = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        ),
        fill = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        )
    )
  
  p2 <- ggplot(plot_data2_confint, aes(x = year, y = mean_SF12_to_cost_ratio, group = scen)) +
    geom_ribbon(aes(ymin = lower, ymax = upper, color = scen, fill = scen), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = scen), linetype = 'dashed') +
    geom_point(aes(color = scen)) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    xlab('Year') +
    ylab('Cost - SF12 Change Ratio') +
    theme(
        legend.title = element_blank(),  # Remove the legend title
        legend.position = c(0.2, 0.7),  # Position the legend inside the plot
        legend.text = element_text(size = 8),  # Increase the text size for better readability
        legend.key.size = unit(0.8, 'cm'),  # Reduce the key size to fit more entries
        legend.spacing.y = unit(0.1, 'cm')  # Add vertical space between legend items
    ) +
    guides(
        color = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        ),
        fill = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        )
    )
  
  print(p1)
  print(p2)
  
  ggsave(filename = paste('SF_12', summary_type, deparse(substitute(scen_list)), '.png', sep = '_'),
         plot <- p1,
         path = 'plots')
  
  ggsave(filename = paste('SF_12_cost_ratio', summary_type, deparse(substitute(scen_list)), '.png', sep = '_'),
         plot <- p2,
         path = 'plots')
}

SF_12_cost_ratio_cumul <- function(summary_type, scen_list, palette = my_palette) {
  
  data <- do.call(rbind, generate_df_list(summary_type, scen_list))
  
  data <- data %>%
    mutate_at("scen", str_replace, "UniversalCredit", "") %>%
    mutate(scen = if_else(scen == "baseline", scen, paste0("£", scen)))
  
  if (summary_type == "UC") {
    data <- data %>%
      filter(universal_credit == 1)
  }
    
  plot_data1 <- data %>%
    select(run_id, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"), 
                 names_to = c(".value", "scen"), 
                 names_sep = "\\.") %>%
    filter(scen != 'baseline')
  
  # Extract numeric part from 'scen' column then...
  scen_numeric <- as.numeric(gsub("[^0-9]", "", plot_data1$scen))
  # ...Reorder 'scen' column based on numeric values for plotting
  plot_data1$scen <- factor(plot_data1$scen, levels = unique(plot_data1$scen[order(scen_numeric)]))
  
  # Now we need to calculate cumulative stuff for the ratio
  cumulative_SF12 <- plot_data1 %>%
    group_by(scen, run_id) %>%
    summarise(SF_12 = sum(diff_SF_12),
              cost = sum(mean_cost))
  
  cumulative_SF12_ratio <- cumulative_SF12 %>%
    mutate(SF12_to_cost_ratio = SF_12 / cost) %>%
    replace_na(list(SF12_to_cost_ratio = 0))
  
  cumulative_SF12_ratio_confint <- cumulative_SF12_ratio %>%
    group_by(scen) %>%
    summarise(n = n(),
              mean_SF12_to_cost_ratio = mean(SF12_to_cost_ratio),
              margin = qt(0.975, df = n - 1) * (sd(SF12_to_cost_ratio) / sqrt(n)),
              lower = mean_SF12_to_cost_ratio - margin,
              upper = mean_SF12_to_cost_ratio + margin)
  
  p1 <- ggplot(cumulative_SF12_ratio_confint, aes(x = scen, y = mean_SF12_to_cost_ratio)) +
    geom_col(aes(color = scen, fill = scen)) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    xlab('Intervention') +
    ylab('Ratio') +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
          legend.position = 'none')
  
  p2 <- ggplot(cumulative_SF12_ratio_confint, aes(x = scen, y = mean_SF12_to_cost_ratio)) +
    geom_col(aes(color = scen, fill = scen)) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    geom_errorbar(aes(ymin = lower, ymax = upper), position = 'dodge', width = 0.25) +
    xlab('Intervention') +
    ylab('Ratio') +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
          legend.position = 'none')
  
  #print(p1)
  print(p2)
  
  ggsave(filename = paste('SF_12_cost_ratio_cumulative', summary_type, deparse(substitute(scen_list)), '.png', sep = '_'),
         plot <- p2,
         path = 'plots')
}
```



```{r "rel_abs_functions", include=FALSE}

compare_relative_absolute <- function(comparison_scen, kids = FALSE) {
  
  scen.list <- c('baseline', comparison_scen)
  
  if (kids) {
    UC.rel <- do.call(rbind, generate_df_list('UC_kids_rel_pov', scen.list))
    UC.abs <- do.call(rbind, generate_df_list('UC_kids_abs_pov', scen.list))
  } else {
    UC.rel <- do.call(rbind, generate_df_list('UC_rel_pov', scen.list))
    UC.abs <- do.call(rbind, generate_df_list('UC_abs_pov', scen.list))
  }
  
  UC.rel <- UC.rel %>%
    mutate_at("scen", str_replace, "UniversalCredit", "") %>%
    mutate(scen = if_else(scen == "baseline", scen, paste0("£", scen)))
  
  UC.abs <- UC.abs %>%
    mutate_at("scen", str_replace, "UniversalCredit", "") %>%
    mutate(scen = if_else(scen == "baseline", scen, paste0("£", scen)))
  
  rel.change <- UC.rel %>%
    filter(universal_credit == 1,
           relative_poverty == 1) %>%
    select(run_id, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    rename(RelativePoverty = diff_SF_12) %>%
    select(run_id, year, RelativePoverty)
  
  abs.change <- UC.abs %>%
    filter(universal_credit == 1,
           absolute_poverty == 1) %>%
    select(run_id, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    rename(AbsolutePoverty = diff_SF_12) %>%
    select(run_id, year, AbsolutePoverty)
  
  combined <- merge(rel.change, abs.change, by = c('run_id', 'year'))
  
  combined_confint <- combined %>%
    pivot_longer(cols = RelativePoverty:AbsolutePoverty,
                 names_to = 'subpop',
                 values_to = 'SF_12_change') %>%
      group_by(subpop, year) %>%
      summarise(n = n(),
                mean_SF12_change = mean(SF_12_change),
                margin = qt(0.975, df = n - 1) * (sd(SF_12_change) / sqrt(n)),
                lower = mean_SF12_change - margin,
                upper = mean_SF12_change + margin)
  
  comparison_scen <- gsub("[a-zA-Z ]", "", comparison_scen)
  comparison_scen <- paste0("£", comparison_scen)
  
  p1 <- ggplot(combined_confint, aes(x = year, y = mean_SF12_change, group = subpop, colour = subpop, fill = subpop)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = subpop), linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') + 
    labs(subtitle = comparison_scen) +
    xlab('Year') +
    ylab('Mean SF-12 Change')
  
  p2 <- ggplot(combined_confint, aes(x = year, y = mean_SF12_change, group = subpop, colour = subpop, fill = subpop)) +
    geom_smooth() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    labs(subtitle = comparison_scen) +
    xlab('Year') +
    ylab('Mean SF-12 Change')
  
  print(p1)
  #print(p2)
  
  ggsave(filename = paste('abs_rel_comparison', comparison_scen, '.png', sep = '_'),
         plot <- p1,
         path = 'plots')
}

compare_init_relative_absolute <- function(comparison_scen, kids = FALSE) {
  
  scen.list <- c('baseline', comparison_scen)
  
  if (kids) {
    UC.rel <- do.call(rbind, generate_df_list('UC_kids_init_rel_pov', scen.list))
    UC.abs <- do.call(rbind, generate_df_list('UC_kids_init_abs_pov', scen.list))
  } else {
    UC.rel <- do.call(rbind, generate_df_list('UC_init_rel_pov', scen.list))
    UC.abs <- do.call(rbind, generate_df_list('UC_init_abs_pov', scen.list))
  }
  
  UC.rel <- UC.rel %>%
    mutate_at("scen", str_replace, "UniversalCredit", "") %>%
    mutate(scen = if_else(scen == "baseline", scen, paste0("£", scen)))
  
  UC.abs <- UC.abs %>%
    mutate_at("scen", str_replace, "UniversalCredit", "") %>%
    mutate(scen = if_else(scen == "baseline", scen, paste0("£", scen)))
  
  rel.change <- UC.rel %>%
    filter(universal_credit == 1,
           init_relative_poverty == 1) %>%
    select(run_id, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    rename(RelativePoverty = diff_SF_12) %>%
    select(run_id, year, RelativePoverty)
  
  abs.change <- UC.abs %>%
    filter(universal_credit == 1,
           init_absolute_poverty == 1) %>%
    select(run_id, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    rename(AbsolutePoverty = diff_SF_12) %>%
    select(run_id, year, AbsolutePoverty)
  
  combined <- merge(rel.change, abs.change, by = c('run_id', 'year'))
  
  combined_confint <- combined %>%
    pivot_longer(cols = RelativePoverty:AbsolutePoverty,
                 names_to = 'subpop',
                 values_to = 'SF_12_change') %>%
      group_by(subpop, year) %>%
      summarise(n = n(),
                mean_SF12_change = mean(SF_12_change),
                margin = qt(0.975, df = n - 1) * (sd(SF_12_change) / sqrt(n)),
                lower = mean_SF12_change - margin,
                upper = mean_SF12_change + margin)
  
  comparison_scen <- gsub("[a-zA-Z ]", "", comparison_scen)
  comparison_scen <- paste0("£", comparison_scen)
  
  p1 <- ggplot(combined_confint, aes(x = year, y = mean_SF12_change, group = subpop, colour = subpop, fill = subpop)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = subpop), linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    labs(subtitle = comparison_scen) +
    xlab('Year') +
    ylab('Mean SF-12 Change')
  
  p2 <- ggplot(combined_confint, aes(x = year, y = mean_SF12_change, group = subpop, colour = subpop, fill = subpop)) +
    geom_smooth() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    labs(subtitle = comparison_scen) +
    xlab('Year') +
    ylab('Mean SF-12 Change')
  
  print(p1)
  #print(p2)
  
  ggsave(filename = paste('abs_rel_comparison_init', comparison_scen, '.png', sep = '_'),
         plot <- p1,
         path = 'plots')
}

```



```{r "gender_function", include=FALSE}
compare_gender <- function(comparison_scen) {
  scen.list <- c('baseline', comparison_scen)
  UC.gender <- do.call(rbind, generate_df_list('UC_gender', scen.list))
  
  gender.change <- UC.gender %>%
    filter(universal_credit == 1) %>%
    select(run_id, sex, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    select(run_id, sex, year, diff_SF_12)
  
  gender.confint <- gender.change %>%
    group_by(sex, year) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  comparison_scen <- gsub("[a-zA-Z ]", "", comparison_scen)
  comparison_scen <- paste0("£", comparison_scen)
  
  p1 <- ggplot(data = gender.confint, aes(x = year, y = mean_SF12_change, group = sex, colour = sex, fill = sex)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = sex), linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    scale_fill_manual(values = c("#E69F00", "#56B4E9")) +
    scale_color_manual(values = c("#E69F00", "#56B4E9")) +
    labs(subtitle = comparison_scen) +
    xlab('Year') +
    ylab('SF-12 Change')
  
  p2 <- ggplot(data = gender.confint, aes(x = year, y = mean_SF12_change, group = sex, colour = sex, fill = sex)) +
    geom_smooth() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    labs(subtitle = comparison_scen) +
    xlab('Year') +
    ylab('SF-12 Change')
  
  print(p1)
  #print(p2)
  
  ggsave(filename = paste('gender_comparison', comparison_scen, '.png', sep = '_'),
         plot <- p1,
         path = 'plots')
}
```

```{r "lone_parent_function", include=FALSE}
compare_lone_parent <- function(comparison_scen) {
  scen.list <- c('baseline', comparison_scen)
  UC.lone_parent <- do.call(rbind, generate_df_list('priority_lone_parent_UC', scen.list))
  
  lone_parent.change <- UC.lone_parent %>%
    select(run_id, lone_parent_flag, SF_12, mean_cost, year, scen) %>%
    pivot_wider(names_from = scen,
                values_from = c(SF_12, mean_cost),
                names_sep = '.') %>%
    mutate(across(starts_with("SF_12"), ~ . - SF_12.baseline)) %>%
    rename_with(~ paste0("diff_", .), starts_with("SF_12")) %>%
    pivot_longer(cols = starts_with("diff") | starts_with("mean_cost"),
                 names_to = c(".value", "scen"),
                 names_sep = "\\.") %>%
    filter(scen != 'baseline') %>%
    select(run_id, lone_parent_flag, year, diff_SF_12)
  
  lone_parent.confint <- lone_parent.change %>%
    group_by(lone_parent_flag, year) %>%
    summarise(n = n(),
              mean_SF12_change = mean(diff_SF_12),
              margin = qt(0.975, df = n - 1) * (sd(diff_SF_12) / sqrt(n)),
              lower = mean_SF12_change - margin,
              upper = mean_SF12_change + margin)
  
  comparison_scen <- gsub("[a-zA-Z ]", "", comparison_scen)
  comparison_scen <- paste0("£", comparison_scen)
  
  lone_parent.confint$lone_parent_flag <- ifelse(lone_parent.confint$lone_parent_flag == 1, 'TRUE', 'FALSE')
  
  p1 <- ggplot(data = lone_parent.confint, aes(x = year, y = mean_SF12_change, group = lone_parent_flag, colour = lone_parent_flag, fill = lone_parent_flag)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = lone_parent_flag), linetype = 'dashed') +
    geom_point() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    scale_fill_manual(values = c("#49a04d", "#3f3d9e")) +
    scale_color_manual(values = c("#49a04d", "#3f3d9e")) +
    labs(subtitle = comparison_scen) +
    xlab('Year') +
    ylab('SF-12 Change') +
    theme(
        legend.position = c(0.2, 0.7),  # Position the legend inside the plot
        legend.text = element_text(size = 8),  # Increase the text size for better readability
        legend.key.size = unit(0.8, 'cm'),  # Reduce the key size to fit more entries
        legend.spacing.y = unit(0.1, 'cm')  # Add vertical space between legend items
    ) +
    guides(fill = guide_legend(title = 'Lone Parent Household'),
           color = guide_legend(title = 'Lone Parent Household'),
           group = guide_legend(title = 'Lone Parent Household'))
  
  p2 <- ggplot(data = lone_parent.confint, aes(x = year, y = mean_SF12_change, group = lone_parent_flag, colour = lone_parent_flag, fill = lone_parent_flag)) +
    geom_smooth() +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    labs(subtitle = comparison_scen) +
    xlab('Year') +
    ylab('SF-12 Change')
  
  print(p1)
  #print(p2)
  
  ggsave(filename = paste('lone_parent_comparison', comparison_scen, '.png', sep = '_'),
         plot <- p1,
         path = 'plots')
}
```


```{r "mental_illness_risk_plots", include=FALSE}
mental_illness_risk_plots <- function(summary_group, scen.list, palette = my_palette, scale = scaling_factor) {

  tit <- ' '
  if (summary_group == 'UC_men_illness_risk') { tit <- 'UC Population' }
  if (summary_group == 'UC_families_men_illness_risk') { tit <- 'UC Families' }
  if (summary_group == 'men_illness_risk') { tit <- 'Whole Population' }
  if (summary_group == 'men_illness_risk_families') { tit <- 'Families' }
  
  # scen.list.test <- c('baseline', 'ChildPovertyReductionRELATIVE_2')
  # summary_group <- 'men_illness_risk'
  
  #scen.list <- c('baseline', comparison_scen)
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  data <- data %>%
    mutate_at("scen", str_replace, "UniversalCredit", "") %>%
    mutate(scen = if_else(scen == "baseline", scen, paste0("£", scen)))
  
  plot_data1 <- data %>%
    filter(mental_health_risk == 'TRUE') %>%
    select(-prop, -mental_health_risk) %>%
    pivot_wider(names_from = scen,
                values_from = count) %>%
    mutate(across(starts_with("£"), ~ . - baseline, .names = "diff_{.col}")) %>%
    select(run_id, year, starts_with('diff')) %>%
    pivot_longer(cols = starts_with("diff"),
                 names_sep = '_',
                 names_to = c("diff", "scen"),
                 values_to = 'Count')
  
  # Extract numeric part from 'scen' column then...
  scen_numeric <- as.numeric(gsub("[^0-9]", "", plot_data1$scen))
  # ...Reorder 'scen' column based on numeric values for plotting
  plot_data1$scen <- factor(plot_data1$scen, levels = unique(plot_data1$scen[order(scen_numeric)]))
  
  
  plot_data1_confint <- plot_data1 %>%
    group_by(year, scen) %>%
    summarise(n = n(),
              Mean_Count = mean(Count),
              margin = qt(0.975, df = n - 1) * (sd(Count) / sqrt(n)),
              lower = Mean_Count - margin,
              upper = Mean_Count + margin)
  
  
  p1 <- ggplot(plot_data1_confint, aes(x = year, y = Mean_Count, group = scen)) +
    geom_ribbon(aes(ymin = lower, ymax = upper, color = scen, fill = scen), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = scen), linetype = 'dashed') +
    geom_point(aes(color = scen)) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    xlab('Year') +
    ylab('Mean Change') +
    theme(
        legend.title = element_blank(),  # Remove the legend title
        legend.position = c(0.2, 0.7),  # Position the legend inside the plot
        legend.text = element_text(size = 8),  # Increase the text size for better readability
        legend.key.size = unit(0.8, 'cm'),  # Reduce the key size to fit more entries
        legend.spacing.y = unit(0.1, 'cm')  # Add vertical space between legend items
    ) +
    guides(
        color = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        ),
        fill = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        )
    )
  
    plot_data_2 <- data %>%
      filter(mental_health_risk == 'TRUE') %>%
      select(-mental_health_risk, -count) %>%
      pivot_wider(names_from = scen,
                  values_from = prop) %>%
      mutate(across(starts_with("£"), ~ . - baseline, .names = "diff_{.col}")) %>%
      select(run_id, year, starts_with('diff')) %>%
      pivot_longer(cols = starts_with("diff"),
                   names_sep = '_',
                   names_to = c("diff", "scen"),
                   values_to = 'Proportion')
    
    plot_data2_confint <- plot_data_2 %>%
      mutate(Proportion = Proportion * 100) %>%
      group_by(year, scen) %>%
      summarise(n = n(),
              Mean_Proportion = mean(Proportion),
              margin = qt(0.975, df = n - 1) * (sd(Proportion) / sqrt(n)),
              lower = Mean_Proportion - margin,
              upper = Mean_Proportion + margin)
    
    p2 <- ggplot(plot_data2_confint, aes(x = year, y = Mean_Proportion, group = scen)) +
    geom_ribbon(aes(ymin = lower, ymax = upper, color = scen, fill = scen), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = scen), linetype = 'dashed') +
    geom_point(aes(color = scen)) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    xlab('Year') +
    ylab('Mean Change (%)') +
    theme(
        legend.title = element_blank(),  # Remove the legend title
        legend.position = c(0.2, 0.7),  # Position the legend inside the plot
        legend.text = element_text(size = 8),  # Increase the text size for better readability
        legend.key.size = unit(0.8, 'cm'),  # Reduce the key size to fit more entries
        legend.spacing.y = unit(0.1, 'cm')  # Add vertical space between legend items
    ) +
    guides(
        color = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        ),
        fill = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        )
    )
  
  print(p1)
  print(p2)
  
  ggsave(filename = paste('men_illness_risk_counts', summary_group, deparse(substitute(scen_list)), '.png', sep = '_'),
         plot <- p1,
         path = 'plots')
  
  ggsave(filename = paste('men_illness_risk_prop', summary_group, deparse(substitute(scen_list)), '.png', sep = '_'),
         plot <- p2,
         path = 'plots')
}


mental_illness_risk_plots_interval <- function(summary_group, scen.list, palette = my_palette) {
  tit <- ' '
  if (summary_group == 'UC_men_illness_risk') { tit <- 'UC Population' }
  if (summary_group == 'UC_families_men_illness_risk') { tit <- 'UC Families' }
  if (summary_group == 'men_illness_risk') { tit <- 'Whole Population' }
  if (summary_group == 'men_illness_risk_families') { tit <- 'Families' }
  
  # scen.list.test <- c('baseline', 'ChildPovertyReductionRELATIVE_2')
  # summary_group <- 'men_illness_risk'
  
  # Get data for the standard threshold (45.6)
  data.mid <- do.call(rbind, generate_df_list(summary_group, scen.list))

  # # get data for the upper and lower threshold
  sum_high <- paste0(summary_group, '_higher')
  sum_low <- paste0(summary_group, '_lower')
  data.high <- do.call(rbind, generate_df_list(sum_high, scen.list))
  data.low <- do.call(rbind, generate_df_list(sum_low, scen.list))
  
  get_counts <- function(data) {
    
    data <- data %>%
      mutate_at("scen", str_replace, "UniversalCredit", "") %>%
      mutate(scen = if_else(scen == "baseline", scen, paste0("£", scen)))
    
    plot_data <- data %>%
      filter(mental_health_risk == 'TRUE') %>%
      select(-prop, -mental_health_risk) %>%
      pivot_wider(names_from = scen,
                  values_from = count) %>%
      mutate(across(starts_with("£"), ~ . - baseline, .names = "diff_{.col}")) %>%
      select(run_id, year, starts_with('diff')) %>%
      pivot_longer(cols = starts_with("diff"),
                   names_sep = '_',
                   names_to = c("diff", "scen"),
                   values_to = 'Count') %>%
      select(-diff) %>%
      group_by(year, scen) %>%
      summarise(Count = mean(Count))
    
    # Extract numeric part from 'scen' column then...
    scen_numeric <- as.numeric(gsub("[^0-9]", "", plot_data$scen))
    # ...Reorder 'scen' column based on numeric values for plotting
    plot_data$scen <- factor(plot_data$scen, levels = unique(plot_data$scen[order(scen_numeric)]))
    
    return(plot_data)
  }
  
  mid <- get_counts(data.mid)
  high <- get_counts(data.high)
  low <- get_counts(data.low)
  
  high <- high %>%
    rename(High = Count)
  low <- low %>%
    rename(Low = Count)

  
  plot_data_counts <- merge(mid, high, by = c('year', 'scen'))
  plot_data_counts <- merge(plot_data_counts, low, by = c('year', 'scen'))
  
  rm(mid, high, low)

  p1 <- ggplot(plot_data_counts, aes(x = year, y = Count, group = scen)) +
    geom_ribbon(aes(ymin = High, ymax = Low, color = scen, fill = scen), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = scen), linetype = 'dashed') +
    geom_point(aes(color = scen)) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    labs(subtitle = tit) +
    xlab('Year') +
    ylab('Mean Change (Count)') +
    theme(
        legend.title = element_blank(),  # Remove the legend title
        legend.position = c(0.2, 0.7),  # Position the legend inside the plot
        legend.text = element_text(size = 8),  # Increase the text size for better readability
        legend.key.size = unit(0.8, 'cm'),  # Reduce the key size to fit more entries
        legend.spacing.y = unit(0.1, 'cm')  # Add vertical space between legend items
    ) +
    guides(
        color = guide_legend(
            ncol = ifelse(length(unique(plot_data_counts$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        ),
        fill = guide_legend(
            ncol = ifelse(length(unique(plot_data_counts$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        )
    )
  
  get_props <- function(data) {
    
    data <- data %>%
      mutate_at("scen", str_replace, "UniversalCredit", "") %>%
      mutate(scen = if_else(scen == "baseline", scen, paste0("£", scen)))
    
    plot_data <- data %>%
      filter(mental_health_risk == 'TRUE') %>%
      select(-mental_health_risk, -count) %>%
      pivot_wider(names_from = scen,
                  values_from = prop) %>%
      mutate(across(starts_with("£"), ~ . - baseline, .names = "diff_{.col}")) %>%
      select(run_id, year, starts_with('diff')) %>%
      pivot_longer(cols = starts_with("diff"),
                   names_sep = '_',
                   names_to = c("diff", "scen"),
                   values_to = 'Proportion') %>%
      select(-diff) %>%
      group_by(year, scen) %>%
      summarise(Percentage = mean(Proportion) * 100)
    
    # Extract numeric part from 'scen' column then...
    scen_numeric <- as.numeric(gsub("[^0-9]", "", plot_data$scen))
    # ...Reorder 'scen' column based on numeric values for plotting
    plot_data$scen <- factor(plot_data$scen, levels = unique(plot_data$scen[order(scen_numeric)]))
    
    return(plot_data)
  }
  
  mid <- get_props(data.mid)
  high <- get_props(data.high)
  low <- get_props(data.low)
  
  high <- high %>%
    rename(High = Percentage)
  low <- low %>%
    rename(Low = Percentage)

  
  plot_data_prop <- merge(mid, high, by = c('year', 'scen'))
  plot_data_prop <- merge(plot_data_prop, low, by = c('year', 'scen'))
  
  rm(mid, high, low)


  p2 <- ggplot(plot_data_prop, aes(x = year, y = Percentage, group = scen)) +
    geom_ribbon(aes(ymin = High, ymax = Low, color = scen, fill = scen), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = scen), linetype = 'dashed') +
    geom_point(aes(color = scen)) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    labs(subtitle = tit) +
    xlab('Year') +
    ylab('Mean Change (%)') +
    theme(
        legend.title = element_blank(),  # Remove the legend title
        legend.position = c(0.2, 0.7),  # Position the legend inside the plot
        legend.text = element_text(size = 8),  # Increase the text size for better readability
        legend.key.size = unit(0.8, 'cm'),  # Reduce the key size to fit more entries
        legend.spacing.y = unit(0.1, 'cm')  # Add vertical space between legend items
    ) +
    guides(
        color = guide_legend(
            ncol = ifelse(length(unique(plot_data_prop$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        ),
        fill = guide_legend(
            ncol = ifelse(length(unique(plot_data_prop$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        )
    )
   
  print(p1)
  print(p2)
  
    ggsave(filename = paste('men_illness_risk_counts_sensitivity', summary_group, deparse(substitute(scen_list)), '.png', sep = '_'),
         plot <- p1,
         path = 'plots')
  
  ggsave(filename = paste('men_illness_risk_prop_sensitivity', summary_group, deparse(substitute(scen_list)), '.png', sep = '_'),
         plot <- p2,
         path = 'plots')
}
```

# Sample Size Calculations

```{r}
# E&W adults: 48,566,000
# N: 160,908; 211,034
# N total: 371,942

# so we have
scaling_factor <- (371942 / 48566000) * 100
scaling_factor
```


# Whole Population

```{r}
whole.pop.list <- generate_df_list('whole_pop', scen.list.full)
whole.pop <- do.call(rbind, whole.pop.list)
```

```{r}
whole.pop.sum <- whole.pop %>%
  group_by(scen, year) %>%
  summarise(hh_income = mean(hh_income),
            SF_12 = mean(SF_12))

ggplot(whole.pop.sum, aes(x = year, y = SF_12, group = scen, colour = scen, fill = scen)) +
  geom_line()

ggplot(whole.pop, aes(x = year, y = SF_12, group = scen, colour = scen, fill = scen)) +
  geom_smooth()

rm(whole.pop.sum, whole.pop.list, whole.pop)
```

# Families

```{r}
fam.list <- generate_df_list('families', scen.list.full)
families <- do.call(rbind, fam.list)
```

```{r}
fam.sum <- families %>%
  group_by(scen, year) %>%
  summarise(hh_income = mean(hh_income),
            SF_12 = mean(SF_12))

ggplot(fam.sum, aes(x = year, y = SF_12, group = scen, colour = scen, fill = scen)) +
  geom_line()

ggplot(families, aes(x = year, y = SF_12, group = scen, colour = scen, fill = scen)) +
  geom_smooth()

rm(fam.sum, fam.list, families)
```

```{r}
fam.2550 <- do.call(rbind, generate_df_list('families', scen.list.25_50))

ggplot(fam.2550, aes(x = year, y = SF_12, group = scen, colour = scen, fill = scen)) +
  geom_smooth()

rm(fam.2550)
```


# Improvement Ratios

```{r}
# test <- do.call(rbind, generate_df_list('families', scen.list.10_50))
# test2 <- do.call(rbind, generate_df_list('UC', scen.list.10_50))
# SF_12_cost_ratio(summary_type = 'families', scen_list = scen.list.10_50)
# SF_12_cost_ratio_cumul(summary_type = 'families', scen_list = scen.list.10_50)
```

## Cost Ratio: £25 - £50


```{r}
SF_12_cost_ratio(summary_type = 'UC', scen_list = scen.list.25_50)
SF_12_cost_ratio_cumul(summary_type = 'UC', scen_list = scen.list.25_50)
```

## Cost Ratio: £10 - £50


```{r}
SF_12_cost_ratio(summary_type = 'UC', scen_list = scen.list.10_50)
SF_12_cost_ratio_cumul(summary_type = 'UC', scen_list = scen.list.10_50)
```

## Cost Ratio: £60 - £100


```{r}
SF_12_cost_ratio(summary_type = 'UC', scen_list = scen.list.60_100)
SF_12_cost_ratio_cumul(summary_type = 'UC', scen_list = scen.list.60_100)
```

## Cost Ratio: £10 - £100


```{r}
SF_12_cost_ratio(summary_type = 'UC', scen_list = scen.list.10_100)
SF_12_cost_ratio_cumul(summary_type = 'UC', scen_list = scen.list.10_100)
```


## Cost Ratio: £10 - £130 (Defunkt)

```{r}
#SF_12_cost_ratio(summary_type = 'UC', scen_list = scen.list.10_130)
#SF_12_cost_ratio_cumul(summary_type = 'UC', scen_list = scen.list.10_130)
```


# Compare Different Populations

## Relative and Absolute Poverty

### Whole Pop

```{r}
compare_relative_absolute(comparison_scen = '25UniversalCredit')
compare_relative_absolute(comparison_scen = '50UniversalCredit')
compare_relative_absolute(comparison_scen = '70UniversalCredit')
compare_relative_absolute(comparison_scen = '100UniversalCredit')
```

### Families with Children

```{r}
compare_relative_absolute(comparison_scen = '25UniversalCredit', kids=TRUE)
compare_relative_absolute(comparison_scen = '50UniversalCredit', kids=TRUE)
compare_relative_absolute(comparison_scen = '70UniversalCredit', kids=TRUE)
compare_relative_absolute(comparison_scen = '100UniversalCredit', kids=TRUE)
```

## INITIAL Relative and Absolute Poverty

### Whole Pop

```{r}
compare_init_relative_absolute(comparison_scen = '25UniversalCredit')
compare_init_relative_absolute(comparison_scen = '50UniversalCredit')
compare_init_relative_absolute(comparison_scen = '70UniversalCredit')
compare_init_relative_absolute(comparison_scen = '100UniversalCredit')
```

### Families with Children

```{r}
compare_init_relative_absolute(comparison_scen = '25UniversalCredit', kids=TRUE)
compare_init_relative_absolute(comparison_scen = '50UniversalCredit', kids=TRUE)
compare_init_relative_absolute(comparison_scen = '70UniversalCredit', kids=TRUE)
compare_init_relative_absolute(comparison_scen = '100UniversalCredit', kids=TRUE)
```

## Gender

```{r}
compare_gender(comparison_scen = '25UniversalCredit')
compare_gender(comparison_scen = '50UniversalCredit')
compare_gender(comparison_scen = '70UniversalCredit')
compare_gender(comparison_scen = '100UniversalCredit')
```

## Lone Parent


```{r}
compare_lone_parent(comparison_scen = '25UniversalCredit')
compare_lone_parent(comparison_scen = '50UniversalCredit')
compare_lone_parent(comparison_scen = '70UniversalCredit')
compare_lone_parent(comparison_scen = '100UniversalCredit')
```

# Mental Illness Risk

## Whole Pop

```{r}
summary_group <- 'men_illness_risk'
scen.list = scen.list.25_100


tit <- ' '
  if (summary_group == 'UC_men_illness_risk') { tit <- 'UC Population' }
  if (summary_group == 'UC_families_men_illness_risk') { tit <- 'UC Families' }
  if (summary_group == 'men_illness_risk') { tit <- 'Whole Population' }
  if (summary_group == 'men_illness_risk_families') { tit <- 'Families' }
  
  # scen.list.test <- c('baseline', 'ChildPovertyReductionRELATIVE_2')
  # summary_group <- 'men_illness_risk'
  
  #scen.list <- c('baseline', comparison_scen)
  data <- do.call(rbind, generate_df_list(summary_group, scen.list))
  
  data <- data %>%
    mutate_at("scen", str_replace, "UniversalCredit", "") %>%
    mutate(scen = if_else(scen == "baseline", scen, paste0("£", scen)))
  
  plot_data1 <- data %>%
    filter(mental_health_risk == 'TRUE') %>%
    select(-prop, -mental_health_risk) %>%
    pivot_wider(names_from = scen,
                values_from = count) %>%
    mutate(across(starts_with("£"), ~ . - baseline, .names = "diff_{.col}")) %>%
    select(run_id, year, starts_with('diff')) %>%
    pivot_longer(cols = starts_with("diff"),
                 names_sep = '_',
                 names_to = c("diff", "scen"),
                 values_to = 'Count')
  
  # Extract numeric part from 'scen' column then...
  scen_numeric <- as.numeric(gsub("[^0-9]", "", plot_data1$scen))
  # ...Reorder 'scen' column based on numeric values for plotting
  plot_data1$scen <- factor(plot_data1$scen, levels = unique(plot_data1$scen[order(scen_numeric)]))
  
  
  plot_data1_confint <- plot_data1 %>%
    group_by(year, scen) %>%
    summarise(n = n(),
              Mean_Count = mean(Count),
              margin = qt(0.975, df = n - 1) * (sd(Count) / sqrt(n)),
              lower = Mean_Count - margin,
              upper = Mean_Count + margin)
  
  
  p1 <- ggplot(plot_data1_confint, aes(x = year, y = Mean_Count, group = scen)) +
    geom_ribbon(aes(ymin = lower, ymax = upper, color = scen, fill = scen), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = scen), linetype = 'dashed') +
    geom_point(aes(color = scen)) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    xlab('Year') +
    ylab('Mean Change') +
    theme(
        legend.title = element_blank(),  # Remove the legend title
        legend.position = c(0.2, 0.7),  # Position the legend inside the plot
        legend.text = element_text(size = 8),  # Increase the text size for better readability
        legend.key.size = unit(0.8, 'cm'),  # Reduce the key size to fit more entries
        legend.spacing.y = unit(0.1, 'cm')  # Add vertical space between legend items
    ) +
    guides(
        color = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        ),
        fill = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        )
    )
  
    plot_data_2 <- data %>%
      filter(mental_health_risk == 'TRUE') %>%
      select(-mental_health_risk, -count) %>%
      pivot_wider(names_from = scen,
                  values_from = prop) %>%
      mutate(across(starts_with("£"), ~ . - baseline, .names = "diff_{.col}")) %>%
      select(run_id, year, starts_with('diff')) %>%
      pivot_longer(cols = starts_with("diff"),
                   names_sep = '_',
                   names_to = c("diff", "scen"),
                   values_to = 'Proportion')
    
    plot_data2_confint <- plot_data_2 %>%
      mutate(Proportion = Proportion * 100) %>%
      group_by(year, scen) %>%
      summarise(n = n(),
              Mean_Proportion = mean(Proportion),
              margin = qt(0.975, df = n - 1) * (sd(Proportion) / sqrt(n)),
              lower = Mean_Proportion - margin,
              upper = Mean_Proportion + margin)
    
    p2 <- ggplot(plot_data2_confint, aes(x = year, y = Mean_Proportion, group = scen)) +
    geom_ribbon(aes(ymin = lower, ymax = upper, color = scen, fill = scen), linetype = 'dotted', alpha = 0.3) +
    geom_line(aes(color = scen), linetype = 'dashed') +
    geom_point(aes(color = scen)) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    xlab('Year') +
    ylab('Mean Change (%)') +
    theme(
        legend.title = element_blank(),  # Remove the legend title
        legend.position = c(0.2, 0.7),  # Position the legend inside the plot
        legend.text = element_text(size = 8),  # Increase the text size for better readability
        legend.key.size = unit(0.8, 'cm'),  # Reduce the key size to fit more entries
        legend.spacing.y = unit(0.1, 'cm')  # Add vertical space between legend items
    ) +
    guides(
        color = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        ),
        fill = guide_legend(
            ncol = ifelse(length(unique(plot_data1_confint$scen)) > 5, 2, 1)  # Use 2 columns if more than 5 groups
        )
    )
  
  print(p1)
  print(p2)
```


```{r}
mental_illness_risk_plots('men_illness_risk', scen.list = scen.list.25_100)
```

## Families

```{r}
mental_illness_risk_plots('men_illness_risk_families', scen.list = scen.list.25_100)
```


## UC Pop

```{r}
mental_illness_risk_plots('UC_men_illness_risk', scen.list = scen.list.25_100)
mental_illness_risk_plots_interval('UC_men_illness_risk', scen.list = scen.list.25_100)
```


## UC Families

```{r}
mental_illness_risk_plots('UC_families_men_illness_risk', scen.list = scen.list.25_100)
mental_illness_risk_plots_interval('UC_families_men_illness_risk', scen.list = scen.list.25_100)
```






# OLD OR UNWANTED

## Cost Ratio: £10 - £50

### Whole Pop

```{r}
# SF_12_cost_ratio(summary_type = 'whole_pop', scen_list = scen.list.10_50)
# SF_12_cost_ratio_cumul(summary_type = 'whole_pop', scen_list = scen.list.10_50)
```


### Families

```{r}
# SF_12_cost_ratio(summary_type = 'families', scen_list = scen.list.10_50)
# SF_12_cost_ratio_cumul(summary_type = 'families', scen_list = scen.list.10_50)
```

## Cost Ratio: £60 - £100

### Whole Pop

```{r}
# SF_12_cost_ratio(summary_type = 'whole_pop', scen_list = scen.list.60_100)
# SF_12_cost_ratio_cumul(summary_type = 'whole_pop', scen_list = scen.list.60_100)
```


### Families

```{r}
# SF_12_cost_ratio(summary_type = 'families', scen_list = scen.list.60_100)
# SF_12_cost_ratio_cumul(summary_type = 'families', scen_list = scen.list.60_100)
```

## Cost Ratio: £10 - £100

### Whole Pop

```{r}
# SF_12_cost_ratio(summary_type = 'whole_pop', scen_list = scen.list.10_100)
# SF_12_cost_ratio_cumul(summary_type = 'whole_pop', scen_list = scen.list.10_100)
```


### Families

```{r}
# SF_12_cost_ratio(summary_type = 'families', scen_list = scen.list.10_100)
# SF_12_cost_ratio_cumul(summary_type = 'families', scen_list = scen.list.10_100)
```





