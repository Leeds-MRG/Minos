---
title: "Investigating Interventions"
output: html_notebook
---

# Setup

```{r "setup", include=FALSE}

require(tidyverse)
require(ggplot2)
require(purrr)
require(ordinal)
require(nnet)
require(pscl)

workingDir <- "/home/luke/Documents/WORK/MINOS/"
knitr::opts_knit$set(root.dir = workingDir)
rm(workingDir)
```

Source utils for some functions.
```{r}
source('Minos/minos/validation/utils.r')
```

## Data

```{r}
out.path <- 'Minos/output/default_config/'
#out.path <- 'Minos/output/scotland_mode/'

base <- read_output(out.path, 'baseline')
allchild <- read_output(out.path, 'hhIncomeChildUplift')
poverty <- read_output(out.path, 'hhIncomePovertyLineChildUplift')
wage <- read_output(out.path, 'livingWageIntervention')
energy <- read_output(out.path, 'energyDownlift')

```

## Transition Models

```{r, include=FALSE}
trans.path <- 'Minos/data/transitions/'

educ.mod <- readRDS(paste0(trans.path, 'education_state/nnet/education_state_2018_2019.rds'))
sf_12.mod <- readRDS(paste0(trans.path, 'SF_12/ols/SF_12_2018_2019.rds'))
house.mod <- readRDS(paste0(trans.path, 'housing_quality/clm/housing_quality_2018_2019.rds'))
income.mod <- readRDS(paste0(trans.path, 'hh_income/ols/hh_income_2018_2019.rds'))
nut.mod <- readRDS(paste0(trans.path, 'nutrition_quality/ols/nutrition_quality_2018_2019.rds'))
```

# Energy Downlift

## Household Income

```{r}
income.base <- base %>% 
  select(pidp, time, hh_income)

income.energy <- energy %>% 
  select(pidp, time, hh_income, income_boosted)

# first rename and cbind
income.b <- rename(income.base, base = hh_income)
income.e <- rename(income.energy, energy = hh_income)

income.merged <- merge(income.b, income.e, by=c('pidp', 'time'))

income.merged <- pivot_longer(data = income.merged,
                              cols = base:energy,
                              names_to = 'scenario',
                              values_to = 'hh_income')

income.merged.byyr <- income.merged %>%
  group_by(time, scenario) %>%
  summarise(hh_income = mean(hh_income))

ggplot(data = income.merged.byyr, mapping = aes(x = time, y = hh_income, color=scenario)) +
  geom_line()
```

## SF_12

```{r}
sf12.base <- base %>% 
  select(pidp, time, SF_12)

sf12.energy <- energy %>% 
  select(pidp, time, SF_12, income_boosted)

# first rename and cbind
sf12.b <- rename(sf12.base, base = SF_12)
sf12.e <- rename(sf12.energy, energy = SF_12)

sf12.merged <- merge(sf12.b, sf12.e, by=c('pidp', 'time'))

sf12.merged <- pivot_longer(data = sf12.merged,
                              cols = base:energy,
                              names_to = 'scenario',
                              values_to = 'SF_12')

sf12.merged.byyr <- sf12.merged %>%
  group_by(time, scenario) %>%
  summarise(SF_12 = mean(SF_12))

ggplot(data = sf12.merged.byyr, mapping = aes(x = time, y = SF_12, color=scenario)) +
  geom_line()
```

## Pathways

### Housing Quality

```{r}
compare_housing_out(base, energy)
```

### Neighbourhood Safety

```{r}
compare_neighbourhood_out(base, energy)
```

### Tobacco Use

```{r}
compare_ncigs_out(base, energy)
```

### Nutrition Quality

```{r}
compare_nutrition_out(base, energy)
```

### Loneliness (NOT CURRENTLY IN SF12 MODEL)

```{r}
compare_loneliness_out(base, energy)
```

## Boost Amount

```{r}
income.energy <- energy %>% 
  select(pidp, time, hh_income, income_boosted, boost_amount)

income.energy.byyr <- income.energy %>%
  group_by(time) %>%
  summarise(boost_amount = mean(boost_amount))

ggplot(data = income.energy.byyr, mapping = aes(x = time, y = boost_amount)) +
  geom_line()
```

## Who Boosted?

```{r}
boosted.byyr <- income.energy %>% 
  group_by(time) %>%
  count(income_boosted)

ggplot(data = filter(boosted.byyr, income_boosted == 'True'), mapping = aes(x = time, y = n)) +
  geom_line()
```


# Living Wage

## Household Income

```{r}
income.base <- base %>% 
  select(pidp, time, hh_income)

income.wage <- wage %>% 
  select(pidp, time, hh_income, income_boosted)

# first rename and cbind
income.b <- rename(income.base, base = hh_income)
income.w <- rename(income.wage, wage = hh_income)

income.merged <- merge(income.b, income.w, by=c('pidp', 'time'))

income.merged <- pivot_longer(data = income.merged,
                              cols = base:wage,
                              names_to = 'scenario',
                              values_to = 'hh_income')

income.merged.byyr <- income.merged %>%
  group_by(time, scenario) %>%
  summarise(hh_income = mean(hh_income))

ggplot(data = income.merged.byyr, mapping = aes(x = time, y = hh_income, color=scenario)) +
  geom_line()
```

## Pathways

```{r}
compare_housing_out(base, wage)
compare_neighbourhood_out(base, wage)
compare_ncigs_out(base, wage)
compare_nutrition_out(base, wage)
compare_loneliness_out(base, wage)
```


## Boost Amount

```{r}
income.wage <- wage %>% 
  select(pidp, time, hh_income, income_boosted, boost_amount)

income.wage.byyr <- income.wage %>%
  group_by(time) %>%
  summarise(boost_amount = mean(boost_amount))

ggplot(data = income.wage.byyr, mapping = aes(x = time, y = boost_amount)) +
  geom_line()
```

## Who Boosted?

```{r}
boosted.byyr <- income.wage %>% 
  group_by(time) %>%
  count(income_boosted)

ggplot(data = filter(boosted.byyr, income_boosted == 'True'), mapping = aes(x = time, y = n)) +
  geom_line()

ggplot(data = boosted.byyr, mapping = aes(x = time, y = n, color = income_boosted)) +
  geom_line()
```

# All Child Uplift

## Household Income

```{r}
income.base <- base %>% 
  select(pidp, time, hh_income)

income.child <- allchild %>% 
  select(pidp, time, hh_income, income_boosted)

# first rename and cbind
income.base <- rename(income.base, base = hh_income)
income.child <- rename(income.child, allchild = hh_income)

income.merged <- merge(income.base, income.child, by=c('pidp', 'time'))

income.merged <- pivot_longer(data = income.merged,
                              cols = base:allchild,
                              names_to = 'scenario',
                              values_to = 'hh_income')

income.merged.byyr <- income.merged %>%
  group_by(time, scenario) %>%
  summarise(hh_income = mean(hh_income))

ggplot(data = income.merged.byyr, mapping = aes(x = time, y = hh_income, color=scenario)) +
  geom_line()
```

## Pathways

```{r}
compare_housing_out(base, allchild)
compare_neighbourhood_out(base, allchild)
compare_ncigs_out(base, allchild)
compare_nutrition_out(base, allchild)
compare_loneliness_out(base, allchild)
```


## Boost Amount

```{r}
income.child <- allchild %>% 
  select(pidp, time, hh_income, income_boosted, boost_amount)

income.child.byyr <- income.child %>%
  group_by(time) %>%
  summarise(boost_amount = mean(boost_amount))

ggplot(data = income.child.byyr, mapping = aes(x = time, y = boost_amount)) +
  geom_line()
```

## Who Boosted?

```{r}
boosted.byyr <- income.child %>% 
  group_by(time) %>%
  count(income_boosted)

ggplot(data = filter(boosted.byyr, income_boosted == 'True'), mapping = aes(x = time, y = n)) +
  geom_line()

ggplot(data = boosted.byyr, mapping = aes(x = time, y = n, color = income_boosted)) +
  geom_line()
```


# END

```{r}

```

