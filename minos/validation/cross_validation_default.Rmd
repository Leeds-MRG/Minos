---
title: "Cross-Validation Default"
output: html_notebook
---

# SETUP

```{r "setup", include=FALSE}

require(tidyverse)
require(ggplot2)
require(ggExtra)
require(here)
require(scales)

#workingDir <- "/home/luke/Documents/WORK/MINOS/"
workingDir <- normalizePath('../')
knitr::opts_knit$set(root.dir = workingDir)
rm(workingDir)
```

```{r, include=FALSE}
source(here::here('minos', 'utils_datain.R'))
source(here::here('minos', 'utils_validation_vis.R'))
source(here::here('minos', 'validation', 'utils.r'))
#source(here::here('minos', 'utils_outcome_vis.R'))
```

## Data

```{r, include=FALSE}
# cross validation simulation output
#out.path <- 'Minos/output/cross_validation/'
out.path <- here::here('output', 'cv')
cv1 <- read_singular_local_out(here::here(out.path, 'default1/'), 'baseline', drop.dead = TRUE)
cv2 <- read_singular_local_out(here::here(out.path, 'default2/'), 'baseline', drop.dead = TRUE)
cv3 <- read_singular_local_out(here::here(out.path, 'default3/'), 'baseline', drop.dead = TRUE)
cv4 <- read_singular_local_out(here::here(out.path, 'default4/'), 'baseline', drop.dead = TRUE)
cv5 <- read_singular_local_out(here::here(out.path, 'default5/'), 'baseline', drop.dead = TRUE)

cvlist <- list(cv1, cv2, cv3, cv4, cv5)
cv <- do.call(rbind, cvlist)

# cv simulation batches
cv.simul.files1 <- list.files(here::here('data', 'final_US', 'cross_validation', 'batch1'),
                             pattern = '[0-9]{4}_US_cohort.csv',
                             full.names = TRUE)
raw1 <- do.call(rbind, lapply(cv.simul.files1, read.csv))
cv.simul.files2 <- list.files(here::here('data', 'final_US', 'cross_validation', 'batch2'),
                             pattern = '[0-9]{4}_US_cohort.csv',
                             full.names = TRUE)
raw2 <- do.call(rbind, lapply(cv.simul.files2, read.csv))
cv.simul.files3 <- list.files(here::here('data', 'final_US', 'cross_validation', 'batch3'),
                             pattern = '[0-9]{4}_US_cohort.csv',
                             full.names = TRUE)
raw3 <- do.call(rbind, lapply(cv.simul.files3, read.csv))
cv.simul.files4 <- list.files(here::here('data', 'final_US', 'cross_validation', 'batch4'),
                             pattern = '[0-9]{4}_US_cohort.csv',
                             full.names = TRUE)
raw4 <- do.call(rbind, lapply(cv.simul.files4, read.csv))
cv.simul.files5 <- list.files(here::here('data', 'final_US', 'cross_validation', 'batch5'),
                             pattern = '[0-9]{4}_US_cohort.csv',
                             full.names = TRUE)
raw5 <- do.call(rbind, lapply(cv.simul.files5, read.csv))

rawlist <- list(raw1, raw2, raw3, raw4, raw5)
raw.dat <- do.call(rbind, rawlist)
```

First things first, we need to make sure that we are comparing the exact same people from each dataset. Therefore, we need a step here to check the pidps from both, and remove anybody not in both datasets. We can also filter the years out of the raw data here, as we only care about years that have been simulated for comparison.

```{r}
# pidp filter
#cv.pidps <- cv %>% select(pidp) %>% unique()
#raw.pidps <- raw %>% select(pidp) %>% unique()
#both.pidps <- intersect(cv.pidps, raw.pidps)

# year filter
cv.years <- cv %>% select(time) %>% unique()
cv.years <- cv.years[['time']]

#cv <- cv.dat %>% filter(pidp %in% both.pidps$pidp)
raw <- raw.dat %>% filter(time %in% cv.years)

#rm(cv.pidps, raw.pidps, both.pidps, cv.years)
rm(cv.years)
```

For all analyses, results will be calculated on each output separately and pooled. For example, the mean hh_income over time will be calculated for each output run seperately, and the mean of these 5 means is what will be plotted. This will be plotted against the entire raw sample.

# hh_income

```{r}
cv.mean.plots(cv1, cv2, cv3, cv4, cv5, raw, 'hh_income')
```

```{r}
multi_year_boxplots(raw, cv, 'hh_income')
```

```{r}
snapshot_OP_plots(raw, cv, 'hh_income')
```


```{r}
marg_dist_densigram_plot_oneyear(observed = raw, 
                                 predicted = cv, 
                                 var = 'hh_income', 
                                 target.year = 2014)

marg_dist_densigram_plot_oneyear(observed = raw, 
                                 predicted = cv, 
                                 var = 'hh_income', 
                                 target.year = 2016)

marg_dist_densigram_plot_oneyear(observed = raw, 
                                 predicted = cv, 
                                 var = 'hh_income', 
                                 target.year = 2018)

marg_dist_densigram_plot_oneyear(observed = raw, 
                                 predicted = cv, 
                                 var = 'hh_income', 
                                 target.year = 2020)
```

# SF_12

```{r}
cv.mean.plots(cv1, cv2, cv3, cv4, cv5, raw, 'SF_12')
```

```{r}
multi_year_boxplots(raw, cv, 'SF_12')
```

```{r}
snapshot_OP_plots(raw, cv, 'SF_12')
```


```{r}
marg_dist_densigram_plot_oneyear(observed = raw, 
                                 predicted = cv, 
                                 var = 'SF_12', 
                                 target.year = 2014)
marg_dist_densigram_plot_oneyear(observed = raw, 
                                 predicted = cv, 
                                 var = 'SF_12', 
                                 target.year = 2016)
marg_dist_densigram_plot_oneyear(observed = raw, 
                                 predicted = cv, 
                                 var = 'SF_12', 
                                 target.year = 2018)
marg_dist_densigram_plot_oneyear(observed = raw, 
                                 predicted = cv, 
                                 var = 'SF_12', 
                                 target.year = 2020)
```

# Housing Quality

```{r}
hous.pivoted <- combine_and_pivot_long(df1 = cv, 
                                       df1.name = 'simulated', 
                                       df2 = raw, 
                                       df2.name = 'raw', 
                                       var = 'housing_quality')

cv_ordinal_plots(pivoted.df = hous.pivoted, 
                 var = 'housing_quality',
                 save = FALSE)
```

# Neighbourhood Safety

```{r}
nhsafe.pivoted <- combine_and_pivot_long(df1 = cv, 
                                          df1.name = 'simulated', 
                                          df2 = raw, 
                                          df2.name = 'raw', 
                                          var = 'neighbourhood_safety')

cv_ordinal_plots(pivoted.df = nhsafe.pivoted, 
                 var = 'neighbourhood_safety',
                 save = FALSE)
```

# Loneliness

```{r}
lnly.pivoted <- combine_and_pivot_long(df1 = cv, 
                                          df1.name = 'simulated', 
                                          df2 = raw, 
                                          df2.name = 'raw', 
                                          var = 'loneliness')

cv_ordinal_plots(pivoted.df = lnly.pivoted, 
                 var = 'loneliness',
                 save = FALSE)
```

# Nutrition Quality

```{r}
cv.mean.plots(cv1, cv2, cv3, cv4, cv5, raw, 'nutrition_quality')
multi_year_boxplots(raw, cv, 'nutrition_quality')
```

# Tobacco Use

```{r}
cv.mean.plots(cv1, cv2, cv3, cv4, cv5, raw, 'ncigs')

multi_year_boxplots(raw, cv, 'ncigs')
```

# Financial Situation

```{r}
fsit.pivoted <- combine_and_pivot_long(df1 = cv, 
                                          df1.name = 'simulated', 
                                          df2 = raw, 
                                          df2.name = 'raw', 
                                          var = 'financial_situation')

cv_ordinal_plots(pivoted.df = fsit.pivoted, 
                 var = 'financial_situation',
                 save = FALSE)

rm(fsit.pivoted)
```

# Heating

```{r}
heat.pivoted <- combine_and_pivot_long(df1 = cv, 
                                          df1.name = 'simulated', 
                                          df2 = raw, 
                                          df2.name = 'raw', 
                                          var = 'heating')

cv_ordinal_plots(pivoted.df = heat.pivoted, 
                 var = 'heating',
                 save = FALSE)
```

# SECONDARY VARS

## Marital Status

```{r}
mstat.pivoted <- combine_and_pivot_long(df1 = cv, 
                                          df1.name = 'simulated', 
                                          df2 = raw, 
                                          df2.name = 'raw', 
                                          var = 'marital_status')

cv_ordinal_plots(pivoted.df = mstat.pivoted, 
                 var = 'marital_status',
                 save = FALSE)

rm(mstat.pivoted)
```

## hhsize

```{r}
cv.mean.plots(cv1, cv2, cv3, cv4, cv5, raw, 'hhsize')

multi_year_boxplots(raw, cv, 'hhsize')
```

## housing tenure

```{r}
tenure.pivoted <- combine_and_pivot_long(df1 = cv, 
                                          df1.name = 'simulated', 
                                          df2 = raw, 
                                          df2.name = 'raw', 
                                          var = 'housing_tenure')

cv_ordinal_plots(pivoted.df = tenure.pivoted, 
                 var = 'housing_tenure',
                 save = FALSE)

rm(tenure.pivoted)
```

## Ethnicity

```{r}
ethnic.pivoted <- combine_and_pivot_long(df1 = cv, 
                                          df1.name = 'simulated', 
                                          df2 = raw, 
                                          df2.name = 'raw', 
                                          var = 'ethnicity')

cv_ordinal_plots(pivoted.df = ethnic.pivoted, 
                 var = 'ethnicity',
                 save = FALSE)

ethnic.piv.nowhite <- filter(ethnic.pivoted, ethnicity != 'WBI')

cv_ordinal_plots(pivoted.df = ethnic.piv.nowhite, 
                 var = 'ethnicity',
                 save = FALSE)

rm(ethnic.pivoted, ethnic.piv.nowhite)
```




```{r}

```

