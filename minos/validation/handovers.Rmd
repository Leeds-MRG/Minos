---
title: "MINOS Handover Plots"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
---

This notebook shows the handover plots for all pathways in the MINOS microsimulation model.

Handover plots are not strictly statistical validation, but more a type of 'sanity check' for transitioned variables. A handover plot shows the 'handover' from input data to predicted outcomes, and allows us to see at a glance if the predicted outputs are following the same trends seen in the input data.

# SETUP

```{r "setup", include=FALSE}

require(tidyverse)
require(ggplot2)
require(knitr)
require(here)

#workingDir <- "/home/luke/Documents/WORK/MINOS/"
workingDir <- normalizePath('../')
knitr::opts_knit$set(root.dir = workingDir)
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
rm(workingDir)
```

Source utils for some functions.

```{r}
source(here::here('minos', 'utils_datain.R'))
source(here::here('minos', 'utils_validation_vis.R'))
source(here::here('minos', 'validation', 'utils.r'))
```

## Data

```{r}
# Read raw datafiles in
raw.files <- list.files(here::here('data', 'final_US'), pattern='[0-9]{4}_US_cohort.csv', full.names = TRUE)
raw.dat <- do.call(rbind, lapply(raw.files, read.csv)) 

out.path <- here::here('output', 'default_config/')
base.dat <- read_singular_local_out(out.path, 'baseline', drop.dead = TRUE)
```

## Constants

```{r}
start.year <- 2020
save.path <- here::here("plots", "handovers", 'default')
create.if.not.exists(save.path)

shall.we.save <- FALSE
```

# PATHWAYS

## Income

```{r}
handover_continuous(raw.dat, base.dat, var = 'hh_income')
```

### Spaghetti

```{r}
raw.inc <- raw.dat %>%
  select(pidp, age, time, hh_income)
base.inc <- base.dat %>%
  select(pidp, age, time, hh_income)

income.spag <- rbind(raw.inc, base.inc)

spaghetti_plot(income.spag, 'hh_income',
               save = shall.we.save,
               save.path = save.path)

rm(raw.inc, base.inc, income.spag)
```


## SF_12_MCS

```{r}
handover_continuous(raw.dat, base.dat, var = 'SF_12_MCS')
```

### Spaghetti

```{r}
raw.sf12.m <- raw.dat %>%
  select(pidp, age, time, SF_12_MCS)
base.sf12.m <- base.dat %>%
  select(pidp, age, time, SF_12_MCS)

sf12.m.spag <- rbind(raw.sf12.m, base.sf12.m)

spaghetti_plot(sf12.m.spag, 'SF_12_MCS',
               save = shall.we.save,
               save.path = save.path)

rm(raw.sf12.m, base.sf12.m, sf12.m.spag)
```

## SF_12_PCS

```{r}
handover_continuous(raw.dat, base.dat, var = 'SF_12_PCS')
```

### Spaghetti

```{r}
raw.sf12.p <- raw.dat %>%
  select(pidp, age, time, SF_12_PCS)
base.sf12.p <- base.dat %>%
  select(pidp, age, time, SF_12_PCS)

sf12.p.spag <- rbind(raw.sf12.p, base.sf12.p)

spaghetti_plot(sf12.p.spag, 'SF_12_PCS',
               save = shall.we.save,
               save.path = save.path)

rm(raw.sf12.p, base.sf12.p, sf12.p.spag)
```

## Financial Situation

```{r}
handover_ordinal(raw.dat, base.dat, var = 'financial_situation', save = shall.we.save)
```

## Housing Quality

```{r}
handover_ordinal(raw.dat, base.dat, var = 'housing_quality', save = shall.we.save)
```

### Spaghetti

```{r}
raw.s <- raw.dat %>%
  select(pidp, age, time, housing_quality)
base.s <- base.dat %>%
  select(pidp, age, time, housing_quality)

spag <- rbind(raw.s, base.s)

spaghetti_plot(spag, 'housing_quality',
               save = shall.we.save,
               save.path = save.path)

rm(raw.s, base.s, spag)
```

## Neighbourhood Safety

```{r}
handover_ordinal(raw.dat, base.dat, var = 'neighbourhood_safety', save = shall.we.save)
```

### Spaghetti

```{r}
raw.s <- raw.dat %>%
  select(pidp, age, time, neighbourhood_safety)
base.s <- base.dat %>%
  select(pidp, age, time, neighbourhood_safety)

spag <- rbind(raw.s, base.s)

spaghetti_plot(spag, 'neighbourhood_safety',
               save = shall.we.save,
               save.path = save.path)

rm(raw.s, base.s, spag)
```

## Loneliness

```{r}
handover_ordinal(raw.dat, base.dat, var = 'loneliness', save = shall.we.save)
```

### Spaghetti

```{r}
raw.s <- raw.dat %>%
  select(pidp, age, time, loneliness)
base.s <- base.dat %>%
  select(pidp, age, time, loneliness)

spag <- rbind(raw.s, base.s)

spaghetti_plot(spag, 'loneliness',
               save = shall.we.save,
               save.path = save.path)

rm(raw.s, base.s, spag)
```

## Nutrition Quality

TODO: Drop negative values ONLY from waves with no data i.e. not 7,9,11

```{r}
handover_continuous(raw.dat, base.dat, var = 'nutrition_quality')
```

### Spaghetti

```{r}
raw.s <- raw.dat %>%
  select(pidp, age, time, nutrition_quality)
base.s <- base.dat %>%
  select(pidp, age, time, nutrition_quality)

spag <- rbind(raw.s, base.s)

spaghetti_plot(spag, 'nutrition_quality',
               save = shall.we.save,
               save.path = save.path)

rm(raw.s, base.s, spag)
```

## Physical Health

NOTE: At present, physical health is not predicted or transitioned.

```{r}
handover_continuous(raw.dat, base.dat, var = 'phealth')
```

### Spaghetti

```{r}
raw.s <- raw.dat %>%
  select(pidp, age, time, phealth)
base.s <- base.dat %>%
  select(pidp, age, time, phealth)

spag <- rbind(raw.s, base.s)

spaghetti_plot(spag, 'phealth',
             save = shall.we.save,
             save.path = save.path)

rm(raw.s, base.s, spag)
```

## Education

```{r}
handover_ordinal(raw.dat, base.dat, var = 'education_state', save = shall.we.save)
```



```{r}
pivoted <- combine_and_pivot_long(df1 = base.dat, 
                                       df1.name = 'simulated', 
                                       df2 = raw.dat, 
                                       df2.name = 'raw', 
                                       var = 'education_state')

cv_ordinal_plots(pivoted.df = pivoted, 
                 var = 'education_state',
                 save = shall.we.save,
                 save.path = save.path)
```

### Spaghetti

```{r}
raw.s <- raw.dat %>%
  select(pidp, age, time, education_state)
base.s <- base.dat %>%
  select(pidp, age, time, education_state)

spag <- rbind(raw.s, base.s)

spaghetti_plot(spag, 'education_state',
               save = shall.we.save,
               save.path = save.path)

rm(raw.s, base.s, spag)
```

## Alcohol (AUDITC)

```{r}
handover_ordinal(raw.dat, base.dat, var = 'auditc', save = shall.we.save)
```

## Physical Activity

```{r}
handover_ordinal(raw.dat, base.dat, var = 'active', save = shall.we.save)
```

