---
title: "MINOS Handover Plots"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
---

This notebook shows the handover plots for all pathways in the MINOS microsimulation model.

Handover plots are not strictly statistical validation, but more a type of 'sanity check' for transitioned variables. A handover plot shows the 'handover' from input data to predicted outcomes, and allows us to see at a glance if the predicted outputs are following the same trends seen in the input data.

# SETUP

```{r "setup", include=FALSE}

require(tidyverse)
require(ggplot2)
require(ggridges) # for densities over time plots. 
require(knitr)
require(here)
require(dplyr)
require(tidyr)
require(purrr)
require(gghighlight)

#workingDir <- "/home/luke/Documents/WORK/MINOS/"
workingDir <- normalizePath('../')
knitr::opts_knit$set(root.dir = workingDir)
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
rm(workingDir)
```

Source utils for some functions.

```{r}
source(here::here('minos', 'utils_datain.R'))
source(here::here('minos', 'utils_validation_vis.R'))
source(here::here('minos', 'validation', 'utils.r'))
```

## Data

```{r}
# Read raw datafiles in
raw.files <- list.files(here::here('data', 'final_US'), pattern='[0-9]{4}_US_cohort.csv', full.names = TRUE)
raw.dat <- do.call(rbind, lapply(raw.files, read.csv)) 

out.path <- here::here('output', 'default_config/')
base.dat <- read_singular_local_out(out.path, 'baseline', drop.dead = TRUE)
```

## Constants

```{r}
start.year <- 2020
save.path <- here::here("plots", "handovers", 'default')
create.if.not.exists(save.path)

shall.we.save <- FALSE
```

# PATHWAYS

## Income

```{r}
# first figure out how to plot final_US
# start with hh_income

handover_boxplots(raw.dat, base.dat, 'hh_income')
handover_lineplots(raw.dat, base.dat, "hh_income")
```

### Spaghetti

```{r}
raw.inc <- raw.dat %>%
  select(pidp, age, time, hh_income)
base.inc <- base.dat %>%
  select(pidp, age, time, hh_income)

income.spag <- rbind(raw.inc, base.inc)

density_ridges(income.spag, 'hh_income',
               save=shall.we.save, 
               save.path=save.path)

pidp_sample <- sample(unique(income.spag$pidp), size=nrow(raw.inc)/10, replace=FALSE)
income.spag.sample <- income.spag[which(income.spag$pidp %in% pidp_sample), ]
spaghetti_plot(income.spag.sample, 'hh_income',
               save = shall.we.save,
               save.path = save.path)
spaghetti_highlight_max_plot(income.spag.sample, 'hh_income',
               save = shall.we.save,
               save.path = save.path)

rm(raw.inc, base.inc, income.spag)
```


## SF_12_MCS

```{r}
# sf12 boxplot handovers
handover_boxplots(raw.dat, base.dat, 'SF_12_MCS')
handover_lineplots(raw.dat, base.dat, "SF_12_MCS")
```

### Spaghetti

```{r}
raw.sf12.m <- raw.dat %>%
  select(pidp, age, time, SF_12_MCS)
base.sf12.m <- base.dat %>%
  select(pidp, age, time, SF_12_MCS)

sf12.m.spag <- rbind(raw.sf12.m, base.sf12.m)

# sf12.m.spag.sample <- sf12.m.spag[which(sf12.m.spag$pidp %in% pidp_sample), ]
# spaghetti_plot(sf12.m.spag.sample, 'SF_12_MCS',
#                save = shall.we.save,
#                save.path = save.path)
# spaghetti_highlight_max_plot(sf12.m.spag.sample, 'SF_12_MCS',
#                save = shall.we.save,
#                save.path = save.path)
  
density_ridges(sf12.m.spag, "SF_12_MCS", 
               save = shall.we.save, 
               save.path = save.path)

rm(raw.sf12.m, base.sf12.m, sf12.m.spag, sf12.m.spag.sample)
```

## SF_12_PCS

```{r}
handover_boxplots(raw.dat, base.dat, 'SF_12_PCS')
handover_lineplots(raw.dat, base.dat, "SF_12_PCS")
```

### Spaghetti

```{r}
raw.sf12.p <- raw.dat %>%
  select(pidp, age, time, SF_12_PCS)
base.sf12.p <- base.dat %>%
  select(pidp, age, time, SF_12_PCS)

sf12.p.spag <- rbind(raw.sf12.p, base.sf12.p)

spaghetti_plot(sf12.p.spag, 'SF_12_PCS',
               save = shall.we.save,
               save.path = save.path)

density_ridges(sf12.p.spag, "SF_12_PCS", 
               save = shall.we.save, 
               save.path = save.path)

rm(raw.sf12.p, base.sf12.p, sf12.p.spag)
```

## Financial Situation

```{r}
handover_ordinal(raw.dat, base.dat, var = 'financial_situation', save = shall.we.save)
```

## Housing Quality

```{r}
handover_ordinal(raw.dat, base.dat, var = 'housing_quality', save = shall.we.save)
```

### Spaghetti

```{r}
# raw.s <- raw.dat %>%
#   select(pidp, age, time, housing_quality)
# base.s <- base.dat %>%
#   select(pidp, age, time, housing_quality)
# 
# spag <- rbind(raw.s, base.s)
# 
# spaghetti_plot(spag, 'housing_quality',
#                save = shall.we.save,
#                save.path = save.path)
# 
# rm(raw.s, base.s, spag)
```

## Neighbourhood Safety

```{r}
handover_ordinal(raw.dat, base.dat, var = 'neighbourhood_safety', save = shall.we.save)
```

### Spaghetti

```{r}
# raw.s <- raw.dat %>%
#   select(pidp, age, time, neighbourhood_safety)
# base.s <- base.dat %>%
#   select(pidp, age, time, neighbourhood_safety)
# 
# spag <- rbind(raw.s, base.s)
# 
# spaghetti_plot(spag, 'neighbourhood_safety',
#                save = shall.we.save,
#                save.path = save.path)
# 
# rm(raw.s, base.s, spag)
```

## Loneliness

```{r}
handover_ordinal(raw.dat, base.dat, var = 'loneliness', save = shall.we.save)
```

### Spaghetti

```{r}
# raw.s <- raw.dat %>%
#   select(pidp, age, time, loneliness)
# base.s <- base.dat %>%
#   select(pidp, age, time, loneliness)
# 
# spag <- rbind(raw.s, base.s)
# 
# spaghetti_plot(spag, 'loneliness',
#                save = shall.we.save,
#                save.path = save.path)
# 
# rm(raw.s, base.s, spag)
```

## Nutrition Quality

TODO: Drop negative values ONLY from waves with no data i.e. not 7,9,11

```{r}
#  nutriton quality line/boxplots.
handover_boxplots(raw.dat, base.dat, 'nutrition_quality')
handover_lineplots(raw.dat, base.dat, 'nutrition_quality')

test.pidps <- raw.dat %>%
  select(pidp)

test.base <- base.dat %>%
  filter(pidp %in% test.pidps$pidp)

handover_boxplots(raw.dat, test.base, 'nutrition_quality')
handover_lineplots(raw.dat, test.base, 'nutrition_quality')
```

### Spaghetti

```{r}
# raw.nut <- raw.dat %>%
#   select(pidp, age, time, nutrition_quality)
# base.nut <- base.dat %>%
#   select(pidp, age, time, nutrition_quality)
# 
# nut.spag <- rbind(raw.nut, base.nut)
# 
# spaghetti_plot(nut.spag, 'nutrition_quality',
#                save = shall.we.save,
#                save.path = save.path)
# 
# 
# density_ridges(nut.spag, "nutrition_quality",
#                save = T,
#                save.path = save.path)
# 
# rm(raw.nut, base.nut, nut.spag)
```

## Tobacco

TODO: Drop negative values ONLY from waves with no data i.e. not 7,9,11

```{r}
#  nutriton quality line/boxplots.
handover_boxplots(raw.dat, base.dat, 'ncigs')
handover_lineplots(raw.dat, base.dat, 'ncigs')

test.pidps <- raw.dat %>%
  select(pidp)

test.base <- base.dat %>%
  filter(pidp %in% test.pidps$pidp)

handover_boxplots(raw.dat, test.base, 'ncigs')
handover_lineplots(raw.dat, test.base, 'ncigs')
```

### Spaghetti

```{r}
raw.nut <- raw.dat %>%
  select(pidp, age, time, ncigs)
base.nut <- base.dat %>%
  select(pidp, age, time, ncigs)

nut.spag <- rbind(raw.nut, base.nut)

spaghetti_plot(nut.spag, 'ncigs',
               save = shall.we.save,
               save.path = save.path)


density_ridges(nut.spag, "ncigs",
               save = FALSE,
               save.path = save.path)

rm(raw.nut, base.nut, nut.spag)
```

## Physical Health

NOTE: At present, physical health is not predicted or transitioned.

```{r}
handover_continuous(raw.dat, base.dat, var = 'phealth')
handover_boxplots(raw.dat, base.dat, 'phealth')
handover_lineplots(raw.dat, base.dat, 'phealth')
```

### Spaghetti

```{r}
# raw.s <- raw.dat %>%
#   select(pidp, age, time, phealth)
# base.s <- base.dat %>%
#   select(pidp, age, time, phealth)
# 
# spag <- rbind(raw.s, base.s)
# 
# spaghetti_plot(spag, 'phealth',
#              save = shall.we.save,
#              save.path = save.path)
# 
# rm(raw.s, base.s, spag)
```

## Education

```{r}
handover_ordinal(raw.dat, base.dat, var = 'education_state', save = shall.we.save)
```



```{r}
pivoted <- combine_and_pivot_long(df1 = base.dat,
                                       df1.name = 'simulated',
                                       df2 = raw.dat,
                                       df2.name = 'raw',
                                       var = 'education_state')

cv_ordinal_plots(pivoted.df = pivoted,
                 var = 'education_state',
                 save = shall.we.save,
                 save.path = save.path)
```

### Spaghetti

```{r}
# raw.s <- raw.dat %>%
#   select(pidp, age, time, education_state)
# base.s <- base.dat %>%
#   select(pidp, age, time, education_state)
# 
# spag <- rbind(raw.s, base.s)
# 
# spaghetti_plot(spag, 'education_state',
#                save = shall.we.save,
#                save.path = save.path)
# 
# rm(raw.s, base.s, spag)
```

## Parity

```{r}
base.parity <- base.dat %>%
  filter(sex == "Female")

raw.parity <- raw.dat %>%
  filter(sex == "Female")

prepped.list <- validation_prep_ordinal(raw.parity, base.parity, 'nkids_ind')

var <- prepped.list$var
norm <- prepped.list$norm

tit <- 'Parity (total no. of children)'

# Now plot
ggplot(data = var, mapping = aes(x = time, y = n, group = nkids_ind, colour = nkids_ind)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = tit, subtitle = 'Counts by Level') +
  xlab('Year') +
  ylab('Count')

ggplot(data = norm, mapping = aes(x = time, y = prct, fill=nkids_ind)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = tit) +
  xlab('Year') +
  ylab('Proportion')

if (shall.we.save) {
  ggsave(filename = 'parity.png',
         plot = last_plot(),
         path = save.path)
}


rm(prepped.list, var, norm, tit)
```

```{r}
pivoted <- combine_and_pivot_long(df1 = base.parity,
                                  df1.name = 'simulated', 
                                  df2 = raw.parity, 
                                  df2.name = 'raw', 
                                  var = 'nkids_ind')

cv_ordinal_plots(pivoted.df = pivoted, 
                 var = 'nkids_ind',
                 save = shall.we.save,
                 save.path = save.path)
```


### Spaghetti

```{r}
# raw.s <- raw.parity %>%
#   select(pidp, age, time, nkids_ind)
# base.s <- base.parity %>%
#   select(pidp, age, time, nkids_ind)
# 
# spag <- rbind(raw.s, base.s)
# 
# spaghetti_plot(spag, 'nkids_ind',
#                save = shall.we.save,
#                save.path = save.path)
# 
# rm(raw.s, base.s, spag)
```


## Alcohol (AUDITC)

```{r}
handover_ordinal(raw.dat, base.dat, var = 'auditc', save = shall.we.save)

raw.2020.alc <- raw.dat %>% 
  filter(time == 2020) %>%
  group_by(auditc) %>%
  summarise(n = n()) %>%
  mutate(prop = n / sum(n))

```

## Physical Activity

```{r}
handover_ordinal(raw.dat, base.dat, var = 'active', save = shall.we.save)

raw.2020.phys <- raw.dat %>% 
  filter(time == 2020) %>%
  group_by(active) %>%
  summarise(n = n()) %>%
  mutate(prop = n / sum(n))
```

## Material Deprivation

```{r}
#handover_boxplots(raw.dat, base.dat, 'matdep')
#handover_lineplots(raw.dat, base.dat, 'matdep')
handover_ordinal(raw.dat, base.dat, var = 'matdep', save = shall.we.save)

raw.dat$chron_disease <- as.factor(raw.dat$chron_disease)
raw.2020.cd <- raw.dat %>%
  select(time, chron_disease, age) %>%
  filter(time == 2020) %>%
  mutate(age_group = cut(age, 
                         breaks = c(0,20,30,40,50,60,70,80,90,100,120),
                         labels = c('16-19', '20-30', '30-40', '40-50', '50-60', '60-70', '70-80', '80-90', '90-100', '100+'))) %>%
  group_by(age_group, chron_disease) %>%
  summarise(n = n()) %>%
  group_by(age_group) %>%
  mutate(prop = n / sum(n),
         perc = prop * 100)
  # mutate(prop = n() / sum(n),
  #        perc = prop * 100)

raw.2020.cd

ggplot(raw.2020.cd, aes(x = age_group, y = perc, group = chron_disease, colour = chron_disease, fill = chron_disease)) +
  geom_col(position = 'dodge') +
  xlab('Age Group') +
  ylab('Proportion')
```

```{r}
raw.s <- raw.dat %>%
  select(pidp, age, time, matdep) %>%
  filter(!matdep %in% miss.values)
base.s <- base.dat %>%
  select(pidp, age, time, matdep) %>%
  filter(!matdep %in% miss.values)

spag <- rbind(raw.s, base.s)

spaghetti_plot(spag, 'matdep',
               save = shall.we.save,
               save.path = save.path)

rm(raw.s, base.s, spag)
```

## Chronic Disease

```{r}
handover_ordinal(raw.dat, base.dat, var = 'chron_disease', save = shall.we.save)
```

```{r}
raw.s <- raw.dat %>%
  select(pidp, age, time, chron_disease) %>%
  filter(!chron_disease %in% miss.values)
base.s <- base.dat %>%
  select(pidp, age, time, chron_disease) %>%
  filter(!chron_disease %in% miss.values)

spag <- rbind(raw.s, base.s)

spaghetti_plot(spag, 'chron_disease',
               save = shall.we.save,
               save.path = save.path)

density_ridges(spag, 'chron_disease',
               save=shall.we.save, 
               save.path=save.path)

pidp_sample <- sample(unique(spag$pidp), size=nrow(raw.s)/10, replace=FALSE)
spag.sample <- spag[which(spag$pidp %in% pidp_sample), ]
spaghetti_plot(spag.sample, 'chron_disease',
               save = shall.we.save,
               save.path = save.path)
spaghetti_highlight_max_plot(spag.sample, 'chron_disease',
               save = shall.we.save,
               save.path = save.path)

rm(raw.s, base.s, spag)
```
