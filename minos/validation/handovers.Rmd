---
title: "MINOS Handover Plots"
output: html_notebook
---

This notebook shows the handover plots for all pathways in the MINOS microsimulation model.

Handover plots are not strictly statistical validation, but more a type of 'sanity check' for transitioned variables. A handover plot shows the 'handover' from input data to predicted outcomes, and allows us to see at a glance if the predicted outputs are following the same trends seen in the input data.

# SETUP

```{r "setup", include=FALSE}

require(tidyverse)
require(ggplot2)

workingDir <- "/home/luke/Documents/WORK/MINOS/"
knitr::opts_knit$set(root.dir = workingDir)
rm(workingDir)
```

Source utils for some functions.

```{r}
source('Minos/minos/validation/utils.r')
```

## Data

```{r}
# Read raw datafiles in
raw.files <- list.files('/home/luke/Documents/WORK/MINOS/Minos/data/final_US/', full.names = TRUE)
raw.dat <- do.call(rbind, lapply(raw.files, read.csv))

out.path <- 'Minos/output/default_config/'
base.dat <- read_output(out.path, 'baseline')
```

## Constants

```{r}
start.year <- 2020
```


# PATHWAYS

## Income

```{r}
# first figure out how to plot final_US
# start with hh_income
raw.income <- raw.dat %>% 
  select(pidp, time, hh_income, weight) %>%
  group_by(time) %>%
  summarise(income = weighted.mean(hh_income, weight)) %>%
  mutate(source = 'final_US')

base.income <- base.dat %>%
  select(pidp, time, hh_income, weight) %>%
  group_by(time) %>%
  summarise(income = weighted.mean(hh_income, weight, na.rm = TRUE)) %>%
  mutate(source = 'baseline_output')

# merge before plot
income <- rbind(raw.income, base.income)

# Now plot
ggplot(data = income, mapping = aes(x = time, y = income, group = source, colour = source)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted')

## Try a version where final_US is limited to only those present from wave 1 
# onwards because the sample refreshments are messing with the plot
raw.income.wave1 <- raw.dat$pidp[raw.dat$time == 2009]

raw.income2 <- raw.dat %>% 
  select(pidp, time, hh_income) %>%
  filter(pidp %in% raw.income.wave1) %>%
  group_by(time) %>%
  summarise(income = mean(hh_income, na.rm = TRUE)) %>%
  mutate(source = 'final_US')

base.income2 <- base.dat %>%
  select(pidp, time, hh_income) %>%
  filter(pidp %in% raw.income.wave1) %>%
  group_by(time) %>%
  summarise(income = mean(hh_income, na.rm = TRUE)) %>%
  mutate(source = 'baseline_output')

income2 <- rbind(raw.income2, base.income2)

# Now plot
ggplot(data = income2, mapping = aes(x = time, y = income, group = source, colour = source)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted')

raw.income.check <- raw.dat %>% 
  select(pidp, time, hh_income) %>%
  filter(pidp %in% raw.income.wave1)

base.income.check <- base.dat %>%
  select(pidp, time, hh_income) %>%
  filter(pidp %in% raw.income.wave1)

#rm(raw.income, base.income, income, raw.income.wave1, raw.income2, base.income2, 
#   raw.income.check, base.income.check)
```


## SF12

```{r}
# first figure out how to plot final_US
# start with hh_income
raw.sf12 <- raw.dat %>% 
  select(pidp, time, SF_12) %>%
  group_by(time) %>%
  summarise(sf12 = mean(SF_12, na.rm = TRUE)) %>%
  mutate(source = 'final_US')

base.sf12 <- base.dat %>%
  select(pidp, time, SF_12) %>%
  group_by(time) %>%
  summarise(sf12 = mean(SF_12, na.rm = TRUE)) %>%
  mutate(source = 'baseline_output')

# merge before plot
sf12 <- rbind(raw.sf12, base.sf12)

# Now plot
ggplot(data = sf12, mapping = aes(x = time, y = sf12, group = source, colour = source)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted')

## Try a version where final_US is limited to only those present from wave 1 
# onwards because the sample refreshments are messing with the plot
raw.sf12.wave1 <- raw.dat$pidp[raw.dat$time == 2009]

raw.sf12.2 <- raw.dat %>% 
  select(pidp, time, SF_12) %>%
  filter(pidp %in% raw.sf12.wave1) %>%
  group_by(time) %>%
  summarise(sf12 = mean(SF_12, na.rm = TRUE)) %>%
  mutate(source = 'final_US')

base.sf12.2 <- base.dat %>%
  select(pidp, time, SF_12) %>%
  filter(pidp %in% raw.sf12.wave1) %>%
  group_by(time) %>%
  summarise(sf12 = mean(SF_12, na.rm = TRUE)) %>%
  mutate(source = 'baseline_output')

sf12.2 <- rbind(raw.sf12.2, base.sf12.2)

# Now plot
ggplot(data = sf12.2, mapping = aes(x = time, y = sf12, group = source, colour = source)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted')
```


## Housing Quality

```{r}
raw.housing <- raw.dat %>% 
  select(pidp, time, housing_quality) %>%
  group_by(time, housing_quality) %>%
  count() %>%
  mutate(source = 'final_US')

base.housing <- base.dat %>%
  select(pidp, time, housing_quality) %>%
  group_by(time, housing_quality) %>%
  count() %>%
  mutate(source = 'baseline_output')



# merge before plot
housing <- rbind(raw.housing, base.housing)
housing$housing_quality <- as.factor(housing$housing_quality)

# Now plot
ggplot(data = housing, mapping = aes(x = time, y = n, group = housing_quality, colour = housing_quality)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted')

housing.norm <- housing %>%
  group_by(time) %>%
  mutate(total = sum(n)) %>%
  mutate(prct = (n / total))

ggplot(data = housing.norm, mapping = aes(x = time, y = prct, fill=housing_quality)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted')

rm(raw.housing, base.housing, housing, housing.norm)
```


## Neighbourhood Safety

```{r}
raw.neighbour <- raw.dat %>% 
  select(pidp, time, neighbourhood_safety) %>%
  group_by(time, neighbourhood_safety) %>%
  count() %>%
  mutate(source = 'final_US')

base.neighbour <- base.dat %>%
  select(pidp, time, neighbourhood_safety) %>%
  group_by(time, neighbourhood_safety) %>%
  count() %>%
  mutate(source = 'baseline_output')



# merge before plot
neighbour <- rbind(raw.neighbour, base.neighbour)
neighbour$neighbourhood_safety <- as.factor(neighbour$neighbourhood_safety)

# Now plot
ggplot(data = neighbour, mapping = aes(x = time, y = n, group = neighbourhood_safety, colour = neighbourhood_safety)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted')

neighbour.norm <- neighbour %>%
  group_by(time) %>%
  filter(neighbourhood_safety != -9) %>%
  mutate(total = sum(n)) %>%
  mutate(prct = (n / total))

ggplot(data = neighbour.norm, mapping = aes(x = time, y = prct, fill=neighbourhood_safety)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted')

#rm(raw.neighbour, base.neighbour, neighbour, neighbour.norm)
```


## Loneliness

```{r}
raw.loneliness <- raw.dat %>% 
  select(pidp, time, loneliness) %>%
  group_by(time, loneliness) %>%
  count() %>%
  mutate(source = 'final_US')

base.loneliness <- base.dat %>%
  select(pidp, time, loneliness) %>%
  group_by(time, loneliness) %>%
  count() %>%
  mutate(source = 'baseline_output')



# merge before plot
loneliness <- rbind(raw.loneliness, base.loneliness)
loneliness$loneliness <- as.factor(loneliness$loneliness)

# Now plot
ggplot(data = loneliness, mapping = aes(x = time, y = n, group = loneliness, colour = loneliness)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted')

loneliness.norm <- loneliness %>%
  group_by(time) %>%
  filter(loneliness != -9) %>%
  mutate(total = sum(n)) %>%
  mutate(prct = (n / total))

ggplot(data = loneliness.norm, mapping = aes(x = time, y = prct, fill=loneliness)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted')

rm(raw.loneliness, base.loneliness, loneliness, loneliness.norm)
```


## Nutrition Quality

TODO: Drop negative values ONLY from waves with no data i.e. not 7,9,11

```{r}
# first figure out how to plot final_US
# start with hh_income
raw.nut <- raw.dat %>% 
  select(pidp, time, nutrition_quality) %>%
  group_by(time) %>%
  summarise(nutrition_quality = mean(nutrition_quality, na.rm = TRUE)) %>%
  mutate(source = 'final_US')

base.nut <- base.dat %>%
  select(pidp, time, nutrition_quality) %>%
  group_by(time) %>%
  summarise(nutrition_quality = mean(nutrition_quality, na.rm = TRUE)) %>%
  mutate(source = 'baseline_output')

# merge before plot
nutrition_quality <- rbind(raw.nut, base.nut)

# Now plot
ggplot(data = nutrition_quality, mapping = aes(x = time, y = nutrition_quality, group = source, colour = source)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted')

## Try a version where final_US is limited to only those present from wave 1 
# onwards because the sample refreshments are messing with the plot
raw.wave1 <- raw.dat$pidp[raw.dat$time == 2009]

raw.nut2 <- raw.dat %>% 
  select(pidp, time, nutrition_quality) %>%
  filter(pidp %in% raw.wave1) %>%
  filter(nutrition_quality >= 0) %>%
  group_by(time) %>%
  summarise(nutrition_quality = mean(nutrition_quality, na.rm = TRUE)) %>%
  mutate(source = 'final_US')

base.nut2 <- base.dat %>%
  select(pidp, time, nutrition_quality) %>%
  filter(pidp %in% raw.wave1) %>%
  group_by(time) %>%
  summarise(nutrition_quality = mean(nutrition_quality, na.rm = TRUE)) %>%
  mutate(source = 'baseline_output')

nutrition_quality2 <- rbind(raw.nut2, base.nut2)

# Now plot
ggplot(data = nutrition_quality2, mapping = aes(x = time, y = nutrition_quality, group = source, colour = source)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted')

rm(raw.nut, base.nut, nutrition_quality, raw.wave1, raw.nut2, base.nut2, 
    nutrition_quality2)
```


## Physical Health

NOTE: At present, physical health is not predicted or transitioned.

```{r}
# first figure out how to plot final_US
# start with hh_income
raw.phealth <- raw.dat %>% 
  select(pidp, time, phealth) %>%
  group_by(time) %>%
  summarise(phealth = mean(phealth, na.rm = TRUE)) %>%
  mutate(source = 'final_US')

base.phealth <- base.dat %>%
  select(pidp, time, phealth) %>%
  group_by(time) %>%
  summarise(phealth = mean(phealth, na.rm = TRUE)) %>%
  mutate(source = 'baseline_output')

# merge before plot
phealth <- rbind(raw.phealth, base.phealth)

# Now plot
ggplot(data = phealth, mapping = aes(x = time, y = phealth, group = source, colour = source)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted')

## Try a version where final_US is limited to only those present from wave 1 
# onwards because the sample refreshments are messing with the plot
raw.wave1 <- raw.dat$pidp[raw.dat$time == 2009]

raw.phealth2 <- raw.dat %>% 
  select(pidp, time, phealth) %>%
  filter(pidp %in% raw.wave1) %>%
  group_by(time) %>%
  summarise(phealth = mean(phealth, na.rm = TRUE)) %>%
  mutate(source = 'final_US')

base.phealth2 <- base.dat %>%
  select(pidp, time, phealth) %>%
  filter(pidp %in% raw.wave1) %>%
  group_by(time) %>%
  summarise(phealth = mean(phealth, na.rm = TRUE)) %>%
  mutate(source = 'baseline_output')

phealth2 <- rbind(raw.phealth2, base.phealth2)

# Now plot
ggplot(data = phealth2, mapping = aes(x = time, y = phealth, group = source, colour = source)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted')

raw.phealth.check <- raw.dat %>% 
  select(pidp, time, phealth) %>%
  filter(pidp %in% raw.wave1)

base.phealth.check <- base.dat %>%
  select(pidp, time, phealth) %>%
  filter(pidp %in% raw.wave1)

rm(raw.phealth, base.phealth, phealth, raw.wave1, raw.phealth2, base.phealth2, 
   raw.phealth.check, base.phealth.check, phealth2)
```



```{r}

```

