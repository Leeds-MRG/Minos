---
title: "MINOS Handover Plots"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
---

This notebook shows the handover plots for all pathways in the MINOS microsimulation model.

Handover plots are not strictly statistical validation, but more a type of 'sanity check' for transitioned variables. A handover plot shows the 'handover' from input data to predicted outcomes, and allows us to see at a glance if the predicted outputs are following the same trends seen in the input data.

# SETUP

```{r "setup", include=FALSE}

library(tidyverse)
library(ggplot2)
library(ggridges) # for densities over time plots. 
library(knitr)
library(here)
library(dplyr)
library(tidyr)
library(purrr)
library(gghighlight)
library(spatstat)

#workingDir <- "/home/luke/Documents/WORK/MINOS/"
workingDir <- normalizePath('../')
knitr::opts_knit$set(root.dir = workingDir)
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
rm(workingDir)
```

Source utils for some functions.

```{r}
source(here::here('minos', 'utils_datain.R'))
source(here::here('minos', 'utils_validation_vis.R'))
source(here::here('minos', 'validation', 'utils.r'))
```

## Data

```{r}
# Read raw datafiles in
#raw.files <- list.files(here::here('data', 'final_US'), pattern='[0-9]{4}_US_cohort.csv', full.names = TRUE)
raw.files <- list.files(here::here('data', 'imputed_final_US'), pattern='[0-9]{4}_US_cohort.csv', full.names = TRUE)
raw.dat <- do.call(rbind, lapply(raw.files, read.csv))
raw.dat <- raw.dat %>%
  filter(weight > 0)

out.path <- here::here('output', 'default_config/')
base.dat <- read_singular_local_out(out.path, 'baseline', 
                                    drop.dead = TRUE, 
                                    drop.zero.weight = TRUE)
#base.dat <- read_singular_local_out(out.path, 'goodHeatingDummy', drop.dead = TRUE)
```

## Constants

```{r}
start.year <- 2020
save.path <- here::here("plots", "handovers", 'default')
create.if.not.exists(save.path)

# Need to remove extra data from raw data after start year
raw.dat <- raw.dat %>%
  filter(time <= start.year)

shall.we.save <- FALSE
```

# DEMOGRAPHICS

## Age Structure

```{r}
# assign to age_bucket in raw data
cut_bins <- c(-1, 15, 19, 24, 29, 44, 59, 74, 200)
cut_labels <- c("0to15", "16to19", "20to24", "25to29", "30to44", "45to59", "60to74", "75plus")

raw.dat$age_bucket <- cut(raw.dat$age, 
                          breaks = cut_bins, 
                          labels = cut_labels)

handover_ordinal(raw.dat, base.dat, var = 'age_bucket', save = shall.we.save)
```

## Age Structure (Households with Children)

```{r}
raw.dat_fam <- raw.dat %>%
  filter(nkids > 0)

base.dat_fam <- base.dat %>%
  filter(nkids > 0)

empty.dat <- raw.dat %>%
  filter(age > 150)

handover_ordinal(raw.dat_fam, base.dat_fam, var = 'age_bucket', save = shall.we.save)
handover_ordinal(empty.dat, base.dat_fam, var = 'age_bucket', save = shall.we.save)
```

## Max Age

```{r}
raw.maxAge <- raw.dat %>%
  group_by(time) %>%
  summarise(max_age = max(age)) %>%
  mutate(scen = 'final_US')

base.maxAge <- base.dat %>%
  group_by(time) %>%
  summarise(max_age = max(age)) %>%
  mutate(scen = 'baseline')


combined <- rbind(raw.maxAge, base.maxAge)

#handover_lineplots(raw.maxAge, base.maxAge, 'max_age')
ggplot(combined, aes(x = time, y = max_age, group = scen, colour = scen)) +
  geom_line() +
  geom_vline(xintercept = start.year, linetype = 'dashed') +
  labs(title = 'Max year of age') +
  xlab('Year') +
  ylab('Age')

## Check counts in very old age groups
brks = c(75, 80, 85, 90, 95, 100, 105, 110)
lbls = c("75to80", "80to85", "85to90", "90to95", "95to100", "100to105", "105to110")

raw.countOldAge <- raw.dat %>%
  filter(age > 75) %>%
  mutate(age_group = cut(age,
                         breaks = brks,
                         labels = lbls)) %>%
  group_by(time, age_group) %>%
  summarise(age_group_counts = n()) %>%
  mutate(source = 'observed')

base.countOldAge <- base.dat %>%
  filter(age > 75) %>%
  mutate(age_group = cut(age,
                         breaks = brks,
                         labels = lbls)) %>%
  group_by(time, age_group) %>%
  summarise(age_group_counts = n()) %>%
  mutate(source = 'predicted')

combined <- rbind(raw.countOldAge, base.countOldAge)

ggplot(combined, aes(x = time, y = age_group_counts, group = age_group, colour = age_group)) +
  geom_line() +
  geom_vline(xintercept = start.year, linetype = 'dashed') +
  labs(title = 'Counts by older age group', subtitle = '75 to 110 by 5 year groups') +
  xlab('Year') +
  ylab('Count')





raw.countOldAge <- raw.dat %>%
  filter(age > 75) %>%
  mutate(age_group = cut(age,
                         breaks = brks,
                         labels = lbls))

base.countOldAge <- base.dat %>%
  filter(age > 75) %>%
  mutate(age_group = cut(age,
                         breaks = brks,
                         labels = lbls))

handover_ordinal(raw.countOldAge, base.countOldAge, var = 'age_group', save = shall.we.save)
  
```

```{r}
# Having a go at an age pyramid, hopefully animated

brks = c(75, 80, 85, 90, 95, 100, 105, 110)
lbls = c("75to80", "80to85", "85to90", "90to95", "95to100", "100to105", "105to110")

var <- 'age_group'

# start with calculating percentages
#raw.oldAgePct
#base.oldAgePct

raw.oldAgePct <- raw.dat %>%
  filter(age > 75) %>%
  mutate(age_group = cut(age,
                         breaks = brks,
                         labels = lbls)) %>%
  dplyr::select(time, age_group) %>%
  group_by(time, age_group) %>%
  count() %>%
  mutate(source = 'predicted')

base.oldAgePct <- base.dat %>%
  filter(age > 75) %>%
  mutate(age_group = cut(age,
                         breaks = brks,
                         labels = lbls)) %>%
  dplyr::select(time, all_of(var)) %>%
  #filter(!.data[[var]] %in% miss.values) %>%
  group_by(time, .data[[var]]) %>%
  count() %>%
  mutate(source = 'observed')

raw.oldAgePct[[var]] <- as.factor(raw.oldAgePct[[var]])
base.oldAgePct[[var]] <- as.factor(base.oldAgePct[[var]])

merged <- rbind(raw.oldAgePct, base.oldAgePct)
merged[[var]] <- as.factor(merged[[var]])


var.norm <- merged %>%
    group_by(time) %>%
    mutate(total = sum(n)) %>%
    mutate(prct = (n / total) * 100)
```


## Population Counts

### Total Pop

```{r}
raw.alive <- raw.dat %>%
  group_by(time) %>%
  summarise(n = n()) %>%
  mutate(scen = 'final_US')

base.alive <- base.dat %>%
  group_by(time) %>%
  summarise(n = n()) %>%
  mutate(scen = 'baseline')

#handover_boxplots(raw.alive, base.alive, 'n')
#handover_lineplots(raw.alive, base.alive, "n")

combined <- rbind(raw.alive, base.alive)

ggplot(combined, aes(x = time, y = n, group = scen, color = scen, fill = scen)) +
  geom_line() +
  geom_vline(xintercept = start.year, linetype = 'dashed') +
  labs(title = 'Total Count in Sample') +
  xlab('Year') +
  ylab('Count')

rm(raw.alive, base.alive)
```

### Households

```{r}
raw.hhs <- raw.dat %>%
  select(hidp, time) %>%
  distinct() %>%
  group_by(time) %>%
  summarise(n = n()) %>%
  mutate(source = 'final_US')

base.hhs <- base.dat %>%
  select(hidp, time) %>%
  distinct() %>%
  group_by(time) %>%
  summarise(n = n()) %>%
  mutate(source = 'baseline')

combined <- rbind(raw.hhs, base.hhs)

ggplot(combined, aes(x = time, y = n, group = source, color = source, fill = source)) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = start.year, linetype = 'dashed') +
  labs(title = 'Households Count')
```


### Households With Children

```{r}
raw.household_count_by_year <- raw.dat %>%
  filter(nkids > 0) %>%
  select(hidp, time) %>%  # Select relevant columns to reduce data size
  distinct() %>%
  group_by(time) %>%
  summarise(n = n()) %>%
  mutate(source = 'final_US')

base.household_count_by_year <- base.dat %>%
  filter(nkids > 0) %>%
  select(hidp, time) %>%  # Select relevant columns to reduce data size
  distinct() %>%
  group_by(time) %>%
  summarise(n = n()) %>%
  mutate(source = 'baseline')

combined <- rbind(raw.household_count_by_year, base.household_count_by_year)

ggplot(combined, aes(x = time, y = n, group = source, color = source, fill = source)) +
  geom_point() +
  geom_line() +
  labs(title = 'Households with Children Count')
```

### Households With Children (Income Quintile)

```{r}
raw.hhs_kids.income_quint <- raw.dat %>%
  filter(nkids > 0) %>%
  select(hidp, time, hh_income) %>%  # Select relevant columns to reduce data size
  distinct() %>%
  mutate(income_group = case_when(
    hh_income <= 1000 ~ "<= 1000",
    hh_income <= 1500 ~ "1001 - 1500",
    hh_income <= 2000 ~ "1501 - 2000",
    hh_income <= 2500 ~ "2001 - 2500",
    hh_income > 2500  ~ "> 2500"
  )) %>%
  group_by(time, income_group) %>%
  summarise(n = n(), .groups = 'drop') %>%
  mutate(source = 'final_US')

base.hhs_kids.income_quint <- base.dat %>%
  filter(nkids > 0) %>%
  select(hidp, time, hh_income) %>%  # Select relevant columns to reduce data size
  distinct() %>%
  mutate(income_group = case_when(
    hh_income <= 1000 ~ "<= 1000",
    hh_income <= 1500 ~ "1001 - 1500",
    hh_income <= 2000 ~ "1501 - 2000",
    hh_income <= 2500 ~ "2001 - 2500",
    hh_income > 2500  ~ "> 2500"
  )) %>%
  group_by(time, income_group) %>%
  summarise(n = n(), .groups = 'drop') %>%
  mutate(source = 'baseline')

combined <- rbind(raw.hhs_kids.income_quint, base.hhs_kids.income_quint)
combined$income_group <- factor(combined$income_group)

ggplot(combined, aes(x = time, y = n, group = income_group, color = income_group, fill = income_group)) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = start.year) +
  labs(title = 'Households with Children Count')
```

#### Proportions

```{r}
calculate_hh_proportions <- function(data) {
  # Step 1: Filter for households with children
  households_with_kids <- data %>%
    filter(nkids > 0) %>%
    select(hidp, time, hh_income) %>%
    distinct()
  
  # Step 2: Create income group based on thresholds
  households_with_kids <- households_with_kids %>%
    mutate(income_group = case_when(
      hh_income <= 1000 ~ "<= 1000",
      hh_income <= 1500 ~ "1001 - 1500",
      hh_income <= 2000 ~ "1501 - 2000",
      hh_income <= 2500 ~ "2001 - 2500",
      hh_income > 2500  ~ "> 2500"
    ))
  
  # Step 3: Count households within each income group per year
  household_counts <- households_with_kids %>%
    group_by(time, income_group) %>%
    summarise(count = n(), .groups = 'drop')
  
  # Step 4: Calculate total households with children per year
  total_households_per_year <- households_with_kids %>%
    group_by(time) %>%
    summarise(total_count = n(), .groups = 'drop')
  
  # Step 5: Calculate proportion of households in each group per year
  household_proportions <- household_counts %>%
    left_join(total_households_per_year, by = "time") %>%
    mutate(proportion = count / total_count) %>%
    select(time, income_group, proportion)
  
  return(household_proportions)
}

raw.hh_kids_prop <- calculate_hh_proportions(raw.dat)
base.hh_kids_prop <- calculate_hh_proportions(base.dat)

raw.hh_kids_prop$source <- 'final_US'
raw.hh_kids_prop <- filter(raw.hh_kids_prop, time != start.year)
base.hh_kids_prop$source <- 'baseline'

combined <- rbind(raw.hh_kids_prop, base.hh_kids_prop)
combined$income_group <- factor(combined$income_group)

ggplot(combined, aes(x = time, y = proportion, group = income_group, color = income_group, fill = income_group)) +
  geom_col() +
  geom_vline(xintercept = start.year) +
  labs(title = 'Households with Children Count')
```


```{r}
# Step 1: Filter for households with children
households_with_kids <- raw.dat %>%
  filter(nkids > 0) %>%
  select(hidp, time, hh_income) %>%
  distinct() %>%
  select(-hidp)

# Step 2: Calculate income quintiles
households_with_kids <- households_with_kids %>%
  group_by(time) %>%
  mutate(income_quintile = ntile(hh_income, 5)) %>%
  ungroup()

# Step 3: Count households within each income quintile per year
household_count_by_income_quintile <- households_with_kids %>%
  group_by(time, income_quintile) %>%
  summarise(n = n())

household_count_by_income_quintile
```


# PATHWAYS

## Income

```{r}
# first figure out how to plot final_US
# start with hh_income

handover_boxplots(raw.dat, base.dat, 'hh_income')
handover_lineplots(raw.dat, base.dat, "hh_income")
handover_boxplots(raw.dat, base.dat, 'council_tax')
handover_lineplots(raw.dat, base.dat, "council_tax")
```

### Spaghetti

```{r}
raw.inc <- raw.dat %>%
  select(pidp, age, time, hh_income)
base.inc <- base.dat %>%
  select(pidp, age, time, hh_income)

income.spag <- rbind(raw.inc, base.inc)

density_ridges(income.spag, 'hh_income',
               save=TRUE, 
               save.path=save.path)

pidp_sample <- sample(unique(income.spag$pidp), size=nrow(raw.inc)/10, replace=FALSE)
income.spag.sample <- income.spag[which(income.spag$pidp %in% pidp_sample), ]
spaghetti_plot(income.spag.sample, 'hh_income',
               save = shall.we.save,
               save.path = save.path)
spaghetti_highlight_max_plot(income.spag.sample, 'hh_income',
               save = shall.we.save,
               save.path = save.path)

spaghetti_plot(base.inc, 'hh_income',
               save = shall.we.save,
               save.path = save.path)

rm(raw.inc, base.inc, income.spag)
```

### Poverty Thresholds

#### Relative
```{r}
rel.threshold.raw <- raw.dat %>%
  select(time, weight, hh_income) %>%
  group_by(time) %>%
  summarise(poverty_threshold = (weighted.mean(hh_income, w = weight) * 0.6))

rel.threshold.base <- base.dat %>%
  select(time, weight, hh_income) %>%
  group_by(time) %>%
  summarise(poverty_threshold = (weighted.mean(hh_income, w = weight) * 0.6)) %>%
  filter(time != 2021)

rel.threshold <- rbind(rel.threshold.raw, rel.threshold.base)

ggplot(data = rel.threshold, aes(x = time, y = poverty_threshold)) +
  geom_col() +
  geom_hline(yintercept = rel.threshold$poverty_threshold[rel.threshold$time == 2020], linetype='dotted') +
  geom_vline(xintercept = start.year, linetype = 'dashed') +
  labs(title = 'Relative poverty threshold over time') +
  xlab('Year') +
  ylab('Threshold')
#rm(rel.threshold)
```

#### Absolute
```{r}
# raw.2010 <- raw.dat %>%
#   filter(time == 2010)
# 
# abs.threshold <- weighted.median(x = raw.2010$hh_income, 
#                                  w = raw.2010$weight, 
#                                  na.rm = TRUE)
# abs.threshold <- abs.threshold * 0.6
# 
# print(sprintf("The absolute poverty threshold is Â£%.02f", abs.threshold))
```


## SF12

```{r}
# sf12 boxplot handovers
handover_boxplots(raw.dat, base.dat, 'SF_12')
handover_lineplots(raw.dat, base.dat, "SF_12")
# 
# raw.sf12 <- raw.dat %>% 
#   dplyr::select(pidp, time, SF_12) %>%
#   group_by(time) %>%
#   summarise(sf12 = mean(SF_12, na.rm = TRUE)) %>%
#   mutate(source = 'final_US')
# 
# base.sf12 <- base.dat %>%
#   dplyr::select(pidp, time, SF_12) %>%
#   group_by(time) %>%
#   summarise(sf12 = mean(SF_12, na.rm = TRUE)) %>%
#   mutate(source = 'baseline_output')
# 
# # merge before plot
# sf12 <- rbind(raw.sf12, base.sf12)
# 
# # Now plot
# ggplot(data = sf12, mapping = aes(x = time, y = sf12, group = source, colour = source)) +
#   geom_smooth() +
#   #geom_line() +
#   geom_vline(xintercept=start.year, linetype='dotted') +
#   labs(title = 'Mental Wellbeing (SF12)', subtitle = 'Full Sample') +
#   xlab('Year') +
#   ylab('SF12')
# 
# ## Try a version where final_US is limited to only those present from wave 1 
# # onwards because the sample refreshments are messing with the plot
# raw.sf12.wave1 <- raw.dat$pidp[raw.dat$time == 2009]
# 
# raw.sf12.2 <- raw.dat %>% 
#   dplyr::select(pidp, time, SF_12) %>%
#   filter(pidp %in% raw.sf12.wave1) %>%
#   group_by(time) %>%
#   summarise(sf12 = mean(SF_12, na.rm = TRUE)) %>%
#   mutate(source = 'final_US')
# 
# base.sf12.2 <- base.dat %>%
#   dplyr::select(pidp, time, SF_12) %>%
#   filter(pidp %in% raw.sf12.wave1) %>%
#   group_by(time) %>%
#   summarise(sf12 = mean(SF_12, na.rm = TRUE)) %>%
#   mutate(source = 'baseline_output')
# 
# sf12.2 <- rbind(raw.sf12.2, base.sf12.2)
# 
# # Now plot
# ggplot(data = sf12.2, mapping = aes(x = time, y = sf12, group = source, colour = source)) +
#   geom_line() +
#   geom_vline(xintercept=start.year, linetype='dotted') +
#   labs(title = 'Mental Wellbeing (SF12 MCS)') +
#   xlab('Year') +
#   ylab('SF12')
# 
# if (shall.we.save) {
#   ggsave(filename = 'SF12_wav1.png',
#        plot = last_plot(),
#        path = save.path)
# }
# 
# rm(raw.sf12, base.sf12, sf12, raw.sf12.wave1, raw.sf12.2, base.sf12.2, sf12.2)
```

### Spaghetti

```{r}
raw.sf12 <- raw.dat %>%
  select(pidp, age, time, SF_12)
base.sf12 <- base.dat %>%
  select(pidp, age, time, SF_12)

sf12.spag <- rbind(raw.sf12, base.sf12)

sf12.spag.sample <- sf12.spag[which(sf12.spag$pidp %in% pidp_sample), ]
spaghetti_plot(sf12.spag.sample, 'SF_12',
               save = shall.we.save,
               save.path = save.path)
spaghetti_highlight_max_plot(sf12.spag.sample, 'SF_12',
               save = shall.we.save,
               save.path = save.path)
  
density_ridges(sf12.spag, "SF_12", 
               save = T, 
               save.path = save.path)

rm(raw.sf12, base.sf12, sf12.spag)
```

## Housing Quality

```{r}
raw.housing <- raw.dat %>%
  dplyr::select(pidp, time, housing_quality) %>%
  group_by(time, housing_quality) %>%
  count() %>%
  mutate(source = 'final_US')

base.housing <- base.dat %>%
  dplyr::select(pidp, time, housing_quality) %>%
  group_by(time, housing_quality) %>%
  count() %>%
  mutate(source = 'baseline_output')

# merge before plot
housing <- rbind(raw.housing, base.housing)
housing$housing_quality <- as.factor(housing$housing_quality)

# Now plot
ggplot(data = housing, mapping = aes(x = time, y = n, group = housing_quality, colour = housing_quality)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Housing Quality', subtitle = 'Counts by Level') +
  xlab('Year') +
  ylab('Count')

housing.norm <- housing %>%
  group_by(time) %>%
  mutate(total = sum(n)) %>%
  mutate(prct = (n / total))

ggplot(data = housing.norm, mapping = aes(x = time, y = prct, fill=housing_quality)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Housing Quality') +
  xlab('Year') +
  ylab('Proportion')

if (shall.we.save) {
  ggsave(filename = 'housing_quality.png',
       plot = last_plot(),
       path = save.path)
}

rm(raw.housing, base.housing, housing, housing.norm)
```

### Spaghetti

```{r}
# raw.s <- raw.dat %>%
#   select(pidp, age, time, housing_quality)
# base.s <- base.dat %>%
#   select(pidp, age, time, housing_quality)
# 
# spag <- rbind(raw.s, base.s)
# 
# spaghetti_plot(spag, 'housing_quality',
#                save = shall.we.save,
#                save.path = save.path)
# 
# rm(raw.s, base.s, spag)
```

## Neighbourhood Safety

```{r}
raw.neighbour <- raw.dat %>%
  dplyr::select(pidp, time, neighbourhood_safety) %>%
  group_by(time, neighbourhood_safety) %>%
  count() %>%
  mutate(source = 'final_US')

base.neighbour <- base.dat %>%
  dplyr::select(pidp, time, neighbourhood_safety) %>%
  group_by(time, neighbourhood_safety) %>%
  count() %>%
  mutate(source = 'baseline_output')

# merge before plot
neighbour <- rbind(raw.neighbour, base.neighbour)
neighbour$neighbourhood_safety <- as.factor(neighbour$neighbourhood_safety)

# Now plot
ggplot(data = neighbour, mapping = aes(x = time, y = n, group = neighbourhood_safety, colour = neighbourhood_safety)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Neighbourhood Safety', subtitle = 'Counts by level') +
  xlab('Year') +
  ylab('Count')

neighbour.norm <- neighbour %>%
  group_by(time) %>%
  filter(neighbourhood_safety != -9) %>%
  mutate(total = sum(n)) %>%
  mutate(prct = (n / total))

ggplot(data = neighbour.norm, mapping = aes(x = time, y = prct, fill=neighbourhood_safety)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Neighbourhood Safety') +
  xlab('Year') +
  ylab('Proportion')

if (shall.we.save) {
  ggsave(filename = 'neighbourhood_safety.png',
       plot = last_plot(),
       path = save.path)
}

#rm(raw.neighbour, base.neighbour, neighbour, neighbour.norm)
```

### Spaghetti

```{r}
# raw.s <- raw.dat %>%
#   select(pidp, age, time, neighbourhood_safety)
# base.s <- base.dat %>%
#   select(pidp, age, time, neighbourhood_safety)
# 
# spag <- rbind(raw.s, base.s)
# 
# spaghetti_plot(spag, 'neighbourhood_safety',
#                save = shall.we.save,
#                save.path = save.path)
# 
# rm(raw.s, base.s, spag)
```

## Loneliness

```{r}
raw.loneliness <- raw.dat %>%
  dplyr::select(pidp, time, loneliness) %>%
  group_by(time, loneliness) %>%
  count() %>%
  mutate(source = 'final_US')

base.loneliness <- base.dat %>%
  dplyr::select(pidp, time, loneliness) %>%
  group_by(time, loneliness) %>%
  count() %>%
  mutate(source = 'baseline_output')

# merge before plot
loneliness <- rbind(raw.loneliness, base.loneliness)
loneliness$loneliness <- as.factor(loneliness$loneliness)

# Now plot
ggplot(data = loneliness, mapping = aes(x = time, y = n, group = loneliness, colour = loneliness)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Loneliness', subtitle = 'Counts by level') +
  xlab('Year') +
  ylab('Count')

loneliness.norm <- loneliness %>%
  group_by(time) %>%
  filter(loneliness != -9) %>%
  mutate(total = sum(n)) %>%
  mutate(prct = (n / total))

ggplot(data = loneliness.norm, mapping = aes(x = time, y = prct, fill=loneliness)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Loneliness') +
  xlab('Year') +
  ylab('Proportion')

if (shall.we.save) {
  ggsave(filename = 'loneliness.png',
       plot = last_plot(),
       path = save.path)
}

rm(raw.loneliness, base.loneliness, loneliness, loneliness.norm)
```

### Spaghetti

```{r}
# raw.s <- raw.dat %>%
#   select(pidp, age, time, loneliness)
# base.s <- base.dat %>%
#   select(pidp, age, time, loneliness)
# 
# spag <- rbind(raw.s, base.s)
# 
# spaghetti_plot(spag, 'loneliness',
#                save = shall.we.save,
#                save.path = save.path)
# 
# rm(raw.s, base.s, spag)
```

## Nutrition Quality

TODO: Drop negative values ONLY from waves with no data i.e. not 7,9,11

```{r}
#  nutriton quality line/boxplots.
handover_boxplots(raw.dat, base.dat, 'nutrition_quality')
handover_lineplots(raw.dat, base.dat, 'nutrition_quality')


# Try a version where final_US is limited to only those present from wave 1
# onwards because the sample refreshments are messing with the plot
# raw.wave1 <- raw.dat$pidp[raw.dat$time == 2009]
# 
# raw.nut2 <- raw.dat %>%
#   dplyr::select(pidp, time, nutrition_quality) %>%
#   filter(pidp %in% raw.wave1) %>%
#   filter(nutrition_quality >= 0) %>%
#   group_by(time) %>%
#   summarise(nutrition_quality = mean(nutrition_quality, na.rm = TRUE)) %>%
#   mutate(source = 'final_US')
# 
# base.nut2 <- base.dat %>%
#   dplyr::select(pidp, time, nutrition_quality) %>%
#   filter(pidp %in% raw.wave1) %>%
#   group_by(time) %>%
#   summarise(nutrition_quality = mean(nutrition_quality, na.rm = TRUE)) %>%
#   mutate(source = 'baseline_output')
# 
# nutrition_quality2 <- rbind(raw.nut2, base.nut2)
# 
# # Now plot
# ggplot(data = nutrition_quality2, mapping = aes(x = time, y = nutrition_quality, group = source, colour = source)) +
#   geom_line() +
#   geom_vline(xintercept=start.year, linetype='dotted') +
#   labs(title = 'Nutrition Quality') +
#   xlab('Year') +
#   ylab('Nutrition Quality')
# 
# if (shall.we.save) {
#   ggsave(filename = 'nutrition_quality_wav1.png',
#        plot = last_plot(),
#        path = save.path)
# }
# 
# rm(raw.nut, base.nut, nutrition_quality, raw.wave1, raw.nut2, base.nut2,
#     nutrition_quality2)
```

### Spaghetti

```{r}
# raw.nut <- raw.dat %>%
#   select(pidp, age, time, nutrition_quality)
# base.nut <- base.dat %>%
#   select(pidp, age, time, nutrition_quality)
# 
# nut.spag <- rbind(raw.nut, base.nut)
# 
# spaghetti_plot(nut.spag, 'nutrition_quality',
#                save = shall.we.save,
#                save.path = save.path)
# 
# 
# density_ridges(nut.spag, "nutrition_quality", 
#                save = T, 
#                save.path = save.path)
# 
# rm(raw.nut, base.nut, nut.spag)
```

## Physical Health

NOTE: At present, physical health is not predicted or transitioned.

```{r}
# first figure out how to plot final_US
# start with hh_income
raw.phealth <- raw.dat %>%
  dplyr::select(pidp, time, phealth) %>%
  filter(time > 2009) %>%
  group_by(time) %>%
  summarise(phealth = mean(phealth, na.rm = TRUE)) %>%
  mutate(source = 'final_US')

base.phealth <- base.dat %>%
  dplyr::select(pidp, time, phealth) %>%
  filter(time > 2009) %>%
  group_by(time) %>%
  summarise(phealth = mean(phealth, na.rm = TRUE)) %>%
  mutate(source = 'baseline_output')

# merge before plot
phealth <- rbind(raw.phealth, base.phealth)

# Now plot
ggplot(data = phealth, mapping = aes(x = time, y = phealth, group = source, colour = source)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Physical Health', subtitle = 'Full Sample') +
  xlab('Year') +
  ylab('Average')

## Try a version where final_US is limited to only those present from wave 1
# onwards because the sample refreshments are messing with the plot
raw.wave1 <- raw.dat$pidp[raw.dat$time == 2009]

raw.phealth2 <- raw.dat %>%
  dplyr::select(pidp, time, phealth) %>%
  filter(time > 2009) %>%
  filter(pidp %in% raw.wave1) %>%
  group_by(time) %>%
  summarise(phealth = mean(phealth, na.rm = TRUE)) %>%
  mutate(source = 'final_US')

base.phealth2 <- base.dat %>%
  dplyr::select(pidp, time, phealth) %>%
  filter(time > 2009) %>%
  filter(pidp %in% raw.wave1) %>%
  group_by(time) %>%
  summarise(phealth = mean(phealth, na.rm = TRUE)) %>%
  mutate(source = 'baseline_output')

phealth2 <- rbind(raw.phealth2, base.phealth2)

# Now plot
ggplot(data = phealth2, mapping = aes(x = time, y = phealth, group = source, colour = source)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Physical Health') +
  xlab('Year') +
  ylab('Average')

if (shall.we.save) {
  ggsave(filename = 'physical_health_wav1.png',
       plot = last_plot(),
       path = save.path)
}

#raw.phealth.check <- raw.dat %>%
#  select(pidp, time, phealth) %>%
#  filter(time > 2009) %>%
#  filter(pidp %in% raw.wave1)

#base.phealth.check <- base.dat %>%
#  select(pidp, time, phealth) %>%
#  filter(time > 2009) %>%
#  filter(pidp %in% raw.wave1)

rm(raw.phealth, base.phealth, phealth, raw.wave1, raw.phealth2, base.phealth2, phealth2)
#rm(raw.phealth.check, base.phealth.check)
```

### Spaghetti

```{r}
# raw.s <- raw.dat %>%
#   select(pidp, age, time, phealth)
# base.s <- base.dat %>%
#   select(pidp, age, time, phealth)
# 
# spag <- rbind(raw.s, base.s)
# 
# spaghetti_plot(spag, 'phealth',
#              save = shall.we.save,
#              save.path = save.path)
# 
# rm(raw.s, base.s, spag)
```

## S7 Labour State

```{r}
prepped.list <- validation_prep_ordinal(raw.dat, base.dat, 'S7_labour_state')

lab.state <- prepped.list$var
lab.state.norm <- prepped.list$norm

# Now plot
ggplot(data = lab.state, mapping = aes(x = time, y = n, group = S7_labour_state, colour = S7_labour_state)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'S7 Labour State', subtitle = 'Counts by Level') +
  xlab('Year') +
  ylab('Count')

ggplot(data = lab.state.norm, mapping = aes(x = time, y = prct, fill=S7_labour_state)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'S7 Labour State') +
  xlab('Year') +
  ylab('Proportion')

if (shall.we.save) {
  ggsave(filename = 'S7_labour_state.png',
         plot = last_plot(),
         path = save.path)
}


rm(prepped.list, lab.state, lab.state.norm)
```



```{r}
pivoted <- combine_and_pivot_long(df1 = base.dat, 
                                       df1.name = 'simulated', 
                                       df2 = raw.dat, 
                                       df2.name = 'raw', 
                                       var = 'S7_labour_state')

cv_ordinal_plots(pivoted.df = pivoted, 
                 var = 'S7_labour_state',
                 save = shall.we.save,
                 save.path = save.path)
```

# ADDITIONAL VARIABLES

## Education

```{r}
prepped.list <- validation_prep_ordinal(raw.dat, base.dat, 'education_state')

var <- prepped.list$var
norm <- prepped.list$norm

tit <- 'Education State'

# Now plot
ggplot(data = var, mapping = aes(x = time, y = n, group = education_state, colour = education_state)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = tit, subtitle = 'Counts by Level') +
  xlab('Year') +
  ylab('Count')

ggplot(data = norm, mapping = aes(x = time, y = prct, fill=education_state)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = tit) +
  xlab('Year') +
  ylab('Proportion')

if (shall.we.save) {
  ggsave(filename = 'education_state.png',
         plot = last_plot(),
         path = save.path)
}


rm(prepped.list, var, norm, tit)
```



```{r}
pivoted <- combine_and_pivot_long(df1 = base.dat,
                                       df1.name = 'simulated',
                                       df2 = raw.dat,
                                       df2.name = 'raw',
                                       var = 'education_state')

cv_ordinal_plots(pivoted.df = pivoted,
                 var = 'education_state',
                 save = shall.we.save,
                 save.path = save.path)
```

### Spaghetti

```{r}
# raw.s <- raw.dat %>%
#   select(pidp, age, time, education_state)
# base.s <- base.dat %>%
#   select(pidp, age, time, education_state)
# 
# spag <- rbind(raw.s, base.s)
# 
# spaghetti_plot(spag, 'education_state',
#                save = shall.we.save,
#                save.path = save.path)
# 
# rm(raw.s, base.s, spag)
```

## Financial Situation

```{r}
raw.financial_situation <- raw.dat %>%
  dplyr::select(pidp, time, financial_situation) %>%
  group_by(time, financial_situation) %>%
  count() %>%
  mutate(source = 'final_US')

base.financial_situation <- base.dat %>%
  dplyr::select(pidp, time, financial_situation) %>%
  group_by(time, financial_situation) %>%
  count() %>%
  mutate(source = 'baseline_output')



# merge before plot
financial_situation <- rbind(raw.financial_situation, base.financial_situation)
financial_situation$financial_situation <- as.factor(financial_situation$financial_situation)

# Now plot
ggplot(data = financial_situation, mapping = aes(x = time, y = n, group = financial_situation, colour = financial_situation)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Financial Situation', subtitle = 'Counts by Level') +
  xlab('Year') +
  ylab('Count')

financial_situation.norm <- financial_situation %>%
  group_by(time) %>%
  mutate(total = sum(n)) %>%
  mutate(prct = (n / total))

ggplot(data = financial_situation.norm, mapping = aes(x = time, y = prct, fill=financial_situation)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Financial situation') +
  xlab('Year') +
  ylab('Proportion')

if (shall.we.save) {
  ggsave(filename = 'financial_situation.png',
       plot = last_plot(),
       path = save.path)
}

rm(raw.financial_situation, base.financial_situation, financial_situation, financial_situation.norm)
```

## Behind On Bills

```{r}
raw.behind_on_bills <- raw.dat %>%
  dplyr::select(pidp, time, behind_on_bills) %>%
  group_by(time, behind_on_bills) %>%
  count() %>%
  mutate(source = 'final_US')

base.behind_on_bills <- base.dat %>%
  dplyr::select(pidp, time, behind_on_bills) %>%
  group_by(time, behind_on_bills) %>%
  count() %>%
  mutate(source = 'baseline_output')



# merge before plot
behind_on_bills <- rbind(raw.behind_on_bills, base.behind_on_bills)
behind_on_bills$behind_on_bills <- as.factor(behind_on_bills$behind_on_bills)

# Now plot
ggplot(data = behind_on_bills, mapping = aes(x = time, y = n, group = behind_on_bills, colour = behind_on_bills)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Behind On Bills', subtitle = 'Counts by Level') +
  xlab('Year') +
  ylab('Count')

behind_on_bills.norm <- behind_on_bills %>%
  group_by(time) %>%
  mutate(total = sum(n)) %>%
  mutate(prct = (n / total))

ggplot(data = behind_on_bills.norm, mapping = aes(x = time, y = prct, fill=behind_on_bills)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Behind On Bills') +
  xlab('Year') +
  ylab('Proportion')

if (shall.we.save) {
  ggsave(filename = 'behind_on_bills.png',
       plot = last_plot(),
       path = save.path)
}

rm(raw.behind_on_bills, base.behind_on_bills, behind_on_bills, behind_on_bills.norm)
```


## nkids Household

```{r}
raw.hh_unique <- raw.dat %>%
  select(hidp, time, nkids, weight) %>%
  distinct(hidp, time, nkids, .keep_all = TRUE) %>%
  mutate(scen = 'final_US')

base.hh_unique <- base.dat %>%
  select(hidp, time, nkids, weight) %>%
  distinct(hidp, time, nkids, .keep_all = TRUE) %>%
  mutate(scen = 'baseline')

#handover_boxplots(raw.hh_unique, base.hh_unique, 'nkids')
handover_lineplots(raw.hh_unique, base.hh_unique, 'nkids')

```

```{r}
raw.s <- raw.dat %>%
  select(pidp, age, time, nkids)
base.s <- base.dat %>%
  select(pidp, age, time, nkids)

spag <- rbind(raw.s, base.s)

spaghetti_plot(spag, 'nkids',
               save = shall.we.save,
               save.path = save.path)

rm(raw.s, base.s, spag)
```

## nkids Max

```{r}
# first figure out how to plot final_US
# start with hh_income
raw.nkids_max <- raw.dat %>%
  dplyr::select(pidp, time, nkids) %>%
  group_by(time) %>%
  summarise(max_nkids = max(nkids)) %>%
  mutate(source = 'final_US')

base.nkids_max <- base.dat %>%
  dplyr::select(pidp, time, nkids) %>%
  group_by(time) %>%
  summarise(max_nkids = max(nkids)) %>%
  mutate(source = 'baseline_output')

# merge before plot
max_nkids <- rbind(raw.nkids_max, base.nkids_max)

# Now plot
ggplot(data = max_nkids, mapping = aes(x = time, y = max_nkids, group = source, colour = source)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = 'Max nkids', subtitle = 'Full Sample') +
  xlab('Year') +
  ylab('Average')
```

## Parity

```{r}
base.parity <- base.dat %>%
  filter(sex == "Female")

raw.parity <- raw.dat %>%
  filter(sex == "Female")

prepped.list <- validation_prep_ordinal(raw.parity, base.parity, 'nkids_ind')

var <- prepped.list$var
norm <- prepped.list$norm

tit <- 'Parity (total no. of children)'

# Now plot
ggplot(data = var, mapping = aes(x = time, y = n, group = nkids_ind, colour = nkids_ind)) +
  geom_line() +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = tit, subtitle = 'Counts by Level') +
  xlab('Year') +
  ylab('Count')

ggplot(data = norm, mapping = aes(x = time, y = prct, fill=nkids_ind)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept=start.year, linetype='dotted') +
  labs(title = tit) +
  xlab('Year') +
  ylab('Proportion')

if (shall.we.save) {
  ggsave(filename = 'parity.png',
         plot = last_plot(),
         path = save.path)
}


rm(prepped.list, var, norm, tit)
```
```{r}
pivoted <- combine_and_pivot_long(df1 = base.parity,
                                  df1.name = 'simulated', 
                                  df2 = raw.parity, 
                                  df2.name = 'raw', 
                                  var = 'nkids_ind')

cv_ordinal_plots(pivoted.df = pivoted, 
                 var = 'nkids_ind',
                 save = shall.we.save,
                 save.path = save.path)
```


### Spaghetti

```{r}
raw.s <- raw.parity %>%
  select(pidp, age, time, nkids_ind)
base.s <- base.parity %>%
  select(pidp, age, time, nkids_ind)

spag <- rbind(raw.s, base.s)

spaghetti_plot(spag, 'nkids_ind',
               save = shall.we.save,
               save.path = save.path)

rm(raw.s, base.s, spag)
```

## Hourly Wage

```{r}
handover_boxplots(raw.dat, base.dat, 'hourly_wage')
handover_lineplots(raw.dat, base.dat, 'hourly_wage')
```

```{r}
raw.s <- raw.dat %>%
  select(pidp, age, time, hourly_wage)
base.s <- base.dat %>%
  select(pidp, age, time, hourly_wage)

spag <- rbind(raw.s, base.s)

spaghetti_plot(spag, 'hourly_wage',
               save = shall.we.save,
               save.path = save.path)

# now a version limited to 0-100
spag <- spag %>%
  filter(hourly_wage <= 300)
spaghetti_plot(spag, 'hourly_wage',
               save = shall.we.save,
               save.path = save.path)

rm(raw.s, base.s, spag)
```

## Child Ages

```{r}
raw.child.ages <- raw.dat %>%
  dplyr::select(pidp, hidp, time, "child_ages", "nkids") %>%
  filter(time > 2013 & child_ages != 'childless') %>%
  group_by(time, hidp) %>%
  summarise(child_ages = find_mode(child_ages))

r.s<- strsplit(raw.child.ages$child_ages, "_")

raw.child.ages.expanded <- data.frame(time = rep(raw.child.ages$time, sapply(r.s, length)), expanded_child_ages = unlist(r.s))
raw.child.ages.expanded <- raw.child.ages.expanded %>%
  group_by(time, expanded_child_ages) %>%
  summarise(age_counts = n()) %>%
  mutate(source = 'final_US') %>%
  filter(expanded_child_ages <= 16)

base.child.ages <- base.dat %>%
  dplyr::select(pidp, hidp, time, "child_ages", "nkids") %>%
  filter(time > 2009) %>%
  group_by(time, hidp) %>%
  summarise(child_ages = find_mode(child_ages))

b.s<- strsplit(base.child.ages$child_ages, "_")

base.child.ages.expanded <- data.frame(time = rep(base.child.ages$time, sapply(b.s, length)), expanded_child_ages = unlist(b.s))
base.child.ages.expanded <- base.child.ages.expanded %>%
  group_by(time, expanded_child_ages) %>%
  summarise(age_counts = n()) %>%
  mutate(source = 'baseline')

combined <- rbind(raw.child.ages.expanded, base.child.ages.expanded)

combined$expanded_child_ages <- factor(combined$expanded_child_ages,
                                       levels = c('0', '1', '2', '3', '4', '5', 
                                                  '6', '7', '8', '9', '10', 
                                                  '11', '12', '13', '14', '15', 
                                                  '16', 'childless'))
  
ggplot(data = combined, mapping = aes(x = time, y = age_counts, group = expanded_child_ages, colour =  factor(as.numeric(expanded_child_ages)))) +
  geom_line() +
  geom_vline(xintercept = start.year) +
  labs(title = "Child Age Counts Over Time", subtitle = 'Counts by Level') +
  scale_colour_viridis_d() +
  xlab('Year') +
  ylab('Count')

ggplot(data = combined, mapping = aes(x = expanded_child_ages, y = age_counts, group = factor(time), colour = factor(time))) +
  geom_line() +
  geom_vline(xintercept = start.year) +
  labs(title = "Child Age Counts Over Time", subtitle = 'Counts by Level') +
  scale_colour_viridis_d() +
  xlab('Age') +
  ylab('Count')

base.child.ages.nkids <- base.dat %>%
  group_by(time, hidp) %>%
  summarise(nkids_counts = mean(nkids)) %>%
  group_by(time) %>%
  summarise(nkids_by_year = sum(nkids_counts)) %>%
  mutate(source = 'baseline')

raw.child.ages.nkids <- raw.dat %>%
  group_by(time, hidp) %>%
  summarise(nkids_counts = mean(nkids)) %>%
  group_by(time) %>%
  summarise(nkids_by_year = sum(nkids_counts)) %>%
  mutate(source = 'final_US')

combined.nkids <- rbind(base.child.ages.nkids, raw.child.ages.nkids)

ggplot(data = combined.nkids, mapping = aes(x = time, y = nkids_by_year, group = source, colour = source)) +
  geom_line() +
  labs(title = "nkids Count Over Time", subtitle = 'Counts by Level') +
  xlab('Year') +
  ylab('Count')

```


```{r}

```

