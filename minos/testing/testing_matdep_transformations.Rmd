---
title: "Testing Raw Data and Models"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    df_print: paged
    code_folding: hide
---

This notebook shows the handover plots for all pathways in the MINOS microsimulation model.

Handover plots are not strictly statistical validation, but more a type of 'sanity check' for transitioned variables. A handover plot shows the 'handover' from input data to predicted outcomes, and allows us to see at a glance if the predicted outputs are following the same trends seen in the input data.

# SETUP

```{r "setup", include=FALSE}

require(tidyverse)
require(ggplot2)
require(ggridges) # for densities over time plots. 
require(knitr)
require(here)
require(dplyr)
require(tidyr)
require(purrr)
require(gghighlight)
require(describedata)

#workingDir <- "/home/luke/Documents/WORK/MINOS/"
workingDir <- normalizePath('../')
knitr::opts_knit$set(root.dir = workingDir)
knitr::opts_chunk$set(
  #warning = FALSE,
  #message = FALSE
)
rm(workingDir)
```

Source utils for some functions.

```{r}
source(here::here('minos', 'utils_datain.R'))
source(here::here('minos', 'utils_validation_vis.R'))
source(here::here('minos', 'validation', 'utils.r'))
```

## Data

```{r}
# Read raw datafiles in
raw.files <- list.files(here::here('data', 'final_US'), pattern='[0-9]{4}_US_cohort.csv', full.names = TRUE)
raw.dat <- do.call(rbind, lapply(raw.files, read.csv)) 

# out.path <- here::here('output', 'default_config/')
# base.dat <- read_singular_local_out(out.path, 'baseline', drop.dead = TRUE)
```

## Constants

```{r}
start.year <- 2020
save.path <- here::here("plots", "handovers", 'default')
create.if.not.exists(save.path)

shall.we.save <- FALSE
```


## TESTING WITH LADDER

```{r}
var <- 'matdep'
miss.values <- c(-10, -9, -8, -7, -3, -2, -1,
                 -10., -9., -8., -7., -3., -2., -1.)

test.dat <- raw.dat %>% filter(!.data[[var]] %in% miss.values)
test.var <- sample(test.dat$matdep, size = 5000)

ladder(test.var)
norm_dist_plot(test.dat, 'matdep')
```

```{r}
## Cubic transform
new.test.dat <- raw.dat %>%
  mutate(test.matdep = matdep^(1/3))

ladder(sample(new.test.dat$test.matdep, size = 5000))
norm_dist_plot(new.test.dat, 'test.matdep')
qqnorm(new.test.dat$test.matdep)

```

```{r}
## Square Root transform
new.test.dat <- raw.dat %>%
  mutate(test.matdep = sqrt(matdep))

ladder(sample(new.test.dat$test.matdep, size = 5000))
norm_dist_plot(new.test.dat, 'test.matdep')
qqnorm(new.test.dat$test.matdep)
```


















